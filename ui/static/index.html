<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>UnoBot Control</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    :root {
      --bg: #0a0b0d;
      --surf: #111318;
      --surf2: #161b24;
      --surf3: #1c2230;
      --border: #1e2535;
      --border2: #283040;
      --text: #dde4f0;
      --muted: #566070;
      --muted2: #7a8899;
      --red: #e63946;
      --green: #22c55e;
      --yellow: #f0b429;
      --blue: #3b82f6;
      --orange: #f4845f;
      --r: 10px;
      --mono: 'Share Tech Mono', monospace;
      --display: 'Bebas Neue', sans-serif;
      --body: 'DM Sans', sans-serif;
    }

    html {
      background: var(--bg);
      color: var(--text);
      font-family: var(--body);
      font-size: 14px;
      height: 100%
    }

    body {
      height: 100%;
      display: flex;
      flex-direction: column
    }

    /* ‚îÄ‚îÄ‚îÄ Scanlines overlay ‚îÄ‚îÄ‚îÄ */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0, 0, 0, .06) 3px, rgba(0, 0, 0, .06) 4px);
      pointer-events: none;
      z-index: 9999
    }

    /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 26px;
      border-bottom: 1px solid var(--border);
      background: var(--surf);
      position: sticky;
      top: 0;
      z-index: 200;
      gap: 16px
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--red);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 0 20px rgba(230, 57, 70, .4);
      flex-shrink: 0
    }

    .logo-text {
      font-family: var(--display);
      font-size: 28px;
      letter-spacing: 3px;
      line-height: 1
    }

    .logo-sub {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 4px;
      text-transform: uppercase;
      margin-top: 2px
    }

    .hdr-right {
      display: flex;
      align-items: center;
      gap: 20px
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 5px 12px;
      border: 1px solid var(--border2);
      border-radius: 20px;
      font-family: var(--mono);
      font-size: 11px;
      background: var(--surf2)
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      transition: all .3s
    }

    .dot.stopped {
      background: var(--muted)
    }

    .dot.running {
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
      animation: pulse 2s infinite
    }

    .dot.paused {
      background: var(--yellow);
      box-shadow: 0 0 8px var(--yellow)
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .4
      }
    }

    .hdr-strategy {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted2)
    }

    .hdr-room {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      background: var(--surf2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 9px;
      cursor: default
    }

    .hdr-room.active {
      color: var(--green);
      border-color: rgba(34, 197, 94, .3)
    }

    /* ‚îÄ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ */
    .layout {
      display: flex;
      flex: 1;
      min-height: 0
    }

    .nav {
      width: 220px;
      min-width: 220px;
      border-right: 1px solid var(--border);
      padding: 16px 0;
      display: flex;
      flex-direction: column;
      background: var(--surf)
    }

    .nav-section {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 3px;
      text-transform: uppercase;
      padding: 12px 20px 5px
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 20px;
      cursor: pointer;
      color: var(--muted2);
      font-size: 13px;
      font-weight: 500;
      border-left: 3px solid transparent;
      transition: all .15s;
      user-select: none
    }

    .nav-item:hover {
      color: var(--text);
      background: rgba(255, 255, 255, .03)
    }

    .nav-item.active {
      color: var(--red);
      border-left-color: var(--red);
      background: rgba(230, 57, 70, .06)
    }

    .nav-icon {
      width: 18px;
      text-align: center;
      font-size: 15px;
      flex-shrink: 0
    }

    /* ‚îÄ‚îÄ‚îÄ Content ‚îÄ‚îÄ‚îÄ */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 28px
    }

    .page {
      display: none
    }

    .page.active {
      display: block
    }

    .page-title {
      font-family: var(--display);
      font-size: 28px;
      letter-spacing: 2px;
      margin-bottom: 22px
    }

    /* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ */
    .card {
      background: var(--surf);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 22px;
      margin-bottom: 16px
    }

    .card-title {
      font-family: var(--display);
      font-size: 17px;
      letter-spacing: 1.5px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 16px;
      border: 1px solid transparent;
      border-radius: 7px;
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
      flex-shrink: 0
    }

    .btn:disabled {
      opacity: .3;
      cursor: not-allowed;
      pointer-events: none
    }

    .btn-green {
      background: var(--green);
      color: #000;
      border-color: var(--green)
    }

    .btn-green:hover {
      background: #16a34a;
      box-shadow: 0 0 14px rgba(34, 197, 94, .3)
    }

    .btn-red {
      background: transparent;
      color: var(--red);
      border-color: var(--red)
    }

    .btn-red:hover {
      background: rgba(230, 57, 70, .1)
    }

    .btn-red-solid {
      background: var(--red);
      color: #fff;
      border-color: var(--red)
    }

    .btn-red-solid:hover {
      background: #c1121f
    }

    .btn-yellow {
      background: transparent;
      color: var(--yellow);
      border-color: var(--yellow)
    }

    .btn-yellow:hover {
      background: rgba(240, 180, 41, .1)
    }

    .btn-yellow-solid {
      background: var(--yellow);
      color: #000;
      border-color: var(--yellow)
    }

    .btn-yellow-solid:hover {
      background: #ca8a04
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted2);
      border-color: var(--border2)
    }

    .btn-ghost:hover {
      color: var(--text);
      background: rgba(255, 255, 255, .04)
    }

    .btn-blue {
      background: var(--blue);
      color: #fff;
      border-color: var(--blue)
    }

    .btn-blue:hover {
      background: #2563eb
    }

    .btn-sm {
      padding: 5px 11px;
      font-size: 10px;
      letter-spacing: 1px
    }

    .btn-xs {
      padding: 3px 8px;
      font-size: 9px;
      letter-spacing: .8px
    }

    /* ‚îÄ‚îÄ‚îÄ Forms ‚îÄ‚îÄ‚îÄ */
    .field {
      margin-bottom: 14px
    }

    .flbl {
      display: block;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 6px
    }

    input[type=text],
    input[type=number],
    select,
    textarea {
      background: var(--surf2);
      border: 1px solid var(--border2);
      border-radius: 7px;
      color: var(--text);
      font-family: var(--mono);
      font-size: 12px;
      padding: 8px 11px;
      outline: none;
      transition: border-color .15s;
      width: 100%
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--red)
    }

    select option {
      background: var(--surf2)
    }

    .row2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px
    }

    .row3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px
    }

    /* ‚îÄ‚îÄ‚îÄ Toggle ‚îÄ‚îÄ‚îÄ */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 0;
      border-bottom: 1px solid var(--border)
    }

    .toggle-row:last-child {
      border-bottom: none
    }

    .toggle-info .tlbl {
      font-size: 13px;
      font-weight: 500
    }

    .toggle-info .tsub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px
    }

    .tog {
      position: relative;
      width: 40px;
      height: 22px;
      cursor: pointer;
      flex-shrink: 0
    }

    .tog input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute
    }

    .tog-track {
      position: absolute;
      inset: 0;
      background: var(--border2);
      border-radius: 11px;
      transition: background .2s
    }

    .tog-track::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: var(--muted);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: all .2s
    }

    .tog input:checked~.tog-track {
      background: rgba(230, 57, 70, .3)
    }

    .tog input:checked~.tog-track::before {
      transform: translateX(18px);
      background: var(--red)
    }

    /* ‚îÄ‚îÄ‚îÄ Stats grid ‚îÄ‚îÄ‚îÄ */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 16px
    }

    .stat-box {
      background: var(--surf2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 13px
    }

    .stat-lbl {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 5px
    }

    .stat-val {
      font-family: var(--display);
      font-size: 30px;
      line-height: 1;
      color: var(--text)
    }

    .stat-val.g {
      color: var(--green)
    }

    .stat-val.r {
      color: var(--red)
    }

    .stat-val.y {
      color: var(--yellow)
    }

    .stat-val.b {
      color: var(--blue)
    }

    /* ‚îÄ‚îÄ‚îÄ Strategy cards ‚îÄ‚îÄ‚îÄ */
    .strat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(290px, 1fr));
      gap: 16px
    }

    .sc {
      background: var(--surf2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 20px;
      transition: border-color .2s;
      position: relative;
      overflow: hidden
    }

    .sc::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 0 0, rgba(230, 57, 70, .05), transparent 55%);
      opacity: 0;
      transition: opacity .2s
    }

    .sc:hover {
      border-color: var(--border2)
    }

    .sc:hover::before {
      opacity: 1
    }

    .sc.active-strat {
      border-color: var(--red)
    }

    .sc.active-strat::before {
      opacity: 1
    }

    .sc-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px
    }

    .sc-name {
      font-family: var(--display);
      font-size: 22px;
      letter-spacing: 1px
    }

    .sc-cls {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 2px
    }

    .active-badge {
      font-family: var(--mono);
      font-size: 9px;
      background: rgba(230, 57, 70, .15);
      color: var(--red);
      border: 1px solid rgba(230, 57, 70, .3);
      border-radius: 4px;
      padding: 2px 8px;
      white-space: nowrap
    }

    .sc-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin: 12px 0
    }

    .sc-stat {
      background: var(--surf);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px
    }

    .sc-stat-lbl {
      font-size: 9px;
      color: var(--muted);
      font-family: var(--mono);
      text-transform: uppercase;
      letter-spacing: 1px
    }

    .sc-stat-val {
      font-family: var(--display);
      font-size: 20px;
      color: var(--text)
    }

    .sc-stat-val.g {
      color: var(--green)
    }

    .sc-stat-val.r {
      color: var(--red)
    }

    .sc-identity {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted2);
      margin-bottom: 12px;
      padding: 6px 9px;
      background: var(--surf);
      border: 1px solid var(--border);
      border-radius: 6px
    }

    .sc-actions {
      display: flex;
      gap: 7px;
      flex-wrap: wrap
    }

    /* ‚îÄ‚îÄ‚îÄ Terminal ‚îÄ‚îÄ‚îÄ */
    .term {
      background: #070a0c;
      border: 1px solid var(--border);
      border-radius: var(--r);
      overflow: hidden
    }

    .term-bar {
      padding: 8px 13px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surf)
    }

    .term-dots {
      display: flex;
      gap: 5px
    }

    .td {
      width: 10px;
      height: 10px;
      border-radius: 50%
    }

    .td.r {
      background: #ff5f57
    }

    .td.y {
      background: #febc2e
    }

    .td.g {
      background: #28c840
    }

    .term-label {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 2px
    }

    .term-body {
      height: 420px;
      overflow-y: auto;
      padding: 13px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.75;
      color: #7a9aaa
    }

    .term-body::-webkit-scrollbar {
      width: 3px
    }

    .term-body::-webkit-scrollbar-thumb {
      background: var(--border2);
      border-radius: 2px
    }

    .ll {
      white-space: pre-wrap;
      word-break: break-word
    }

    .ll.ok {
      color: #4ade80
    }

    .ll.err {
      color: #f87171
    }

    .ll.warn {
      color: #fbbf24
    }

    .ll.info {
      color: #60a5fa
    }

    .ll.dim {
      color: #2a3a45
    }

    .ll.turn-mine {
      color: #e2e8f0;
      font-weight: 600
    }

    .ll.action-play {
      color: #86efac
    }

    .ll.action-draw {
      color: #93c5fd
    }

    .ll.action-penalty {
      color: #fca5a5
    }

    .ll.game-event {
      color: #fde68a
    }

    /* ‚îÄ‚îÄ‚îÄ Live action feed ‚îÄ‚îÄ‚îÄ */
    .feed {
      height: 280px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px
    }

    .feed::-webkit-scrollbar {
      width: 3px
    }

    .feed::-webkit-scrollbar-thumb {
      background: var(--border2);
      border-radius: 2px
    }

    .feed-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 11px;
      border-radius: 7px;
      background: var(--surf2);
      border: 1px solid var(--border);
      font-size: 13px;
      animation: fadeIn .25s ease
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    .feed-icon {
      font-size: 17px;
      flex-shrink: 0;
      margin-top: 1px
    }

    .feed-content {
      flex: 1;
      min-width: 0
    }

    .feed-main {
      color: var(--text);
      line-height: 1.4
    }

    .feed-main strong {
      color: #fff
    }

    .feed-time {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--muted);
      margin-top: 2px
    }

    .feed-item.mine {
      border-color: rgba(34, 197, 94, .25);
      background: rgba(34, 197, 94, .05)
    }

    .feed-item.win {
      border-color: rgba(240, 180, 41, .3);
      background: rgba(240, 180, 41, .06)
    }

    .feed-item.loss {
      border-color: rgba(230, 57, 70, .2);
      background: rgba(230, 57, 70, .04)
    }

    .feed-item.penalty {
      border-color: rgba(248, 113, 113, .3);
      background: rgba(248, 113, 113, .05)
    }

    .feed-item.system {
      opacity: .7
    }

    /* ‚îÄ‚îÄ‚îÄ Telemetry panel ‚îÄ‚îÄ‚îÄ */
    .telem-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px;
      margin-bottom: 14px
    }

    .telem-box {
      background: var(--surf2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px
    }

    .telem-lbl {
      font-family: var(--mono);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--muted);
      margin-bottom: 4px
    }

    .telem-val {
      font-family: var(--mono);
      font-size: 16px;
      font-weight: 700;
      color: var(--text)
    }

    .telem-val.red {
      color: var(--red)
    }

    .telem-val.green {
      color: var(--green)
    }

    .telem-val.yellow {
      color: var(--yellow)
    }

    .telem-val.blue {
      color: var(--blue)
    }

    .telem-sub {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--muted);
      margin-top: 2px
    }

    .fault-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: rgba(230, 57, 70, .12);
      border: 1px solid rgba(230, 57, 70, .3);
      border-radius: 20px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--red);
      margin: 2px
    }

    .nn-bar {
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      overflow: hidden;
      margin-top: 4px
    }

    .nn-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width .4s;
      background: linear-gradient(90deg, var(--red), var(--yellow), var(--green))
    }

    .mode-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1px
    }

    .mode-NORMAL {
      background: rgba(59, 130, 246, .12);
      color: var(--blue);
      border: 1px solid rgba(59, 130, 246, .3)
    }

    .mode-OFFENSIVE {
      background: rgba(240, 180, 41, .12);
      color: var(--yellow);
      border: 1px solid rgba(240, 180, 41, .3)
    }

    .mode-ENDGAME {
      background: rgba(230, 57, 70, .12);
      color: var(--red);
      border: 1px solid rgba(230, 57, 70, .3)
    }

    .mode-DEFENSIVE {
      background: rgba(34, 197, 94, .12);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, .3)
    }

    .mode-LIVE {
      background: rgba(6, 182, 212, .12);
      color: #06b6d4;
      border: 1px solid rgba(6, 182, 212, .35)
    }

    .telem-feed {
      height: 180px;
      overflow-y: auto;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted2);
      line-height: 1.6;
      padding: 4px 0
    }

    .telem-feed::-webkit-scrollbar {
      width: 3px
    }

    .telem-feed::-webkit-scrollbar-thumb {
      background: var(--border2);
      border-radius: 2px
    }

    .tl {
      padding: 2px 0;
      border-bottom: 1px solid rgba(255, 255, 255, .03)
    }

    .tl.warn {
      color: var(--red)
    }

    .tl.play {
      color: var(--text)
    }

    .tl.draw {
      color: var(--muted)
    }

    .color-RED {
      color: #e63946
    }

    .color-BLUE {
      color: #3b82f6
    }

    .color-GREEN {
      color: #22c55e
    }

    .color-YELLOW {
      color: #f0b429
    }

    .feed-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
      gap: 8px
    }

    .feed-empty .ei {
      font-size: 32px
    }

    /* ‚îÄ‚îÄ‚îÄ Mode selector ‚îÄ‚îÄ‚îÄ */
    .mode-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px
    }

    .mode-btn {
      background: var(--surf2);
      border: 2px solid var(--border);
      border-radius: 9px;
      padding: 14px 10px;
      text-align: center;
      cursor: pointer;
      transition: all .15s;
      user-select: none
    }

    .mode-btn:hover {
      border-color: var(--border2)
    }

    .mode-btn.sel {
      border-color: var(--red);
      background: rgba(230, 57, 70, .07)
    }

    .mode-icon {
      font-size: 26px;
      margin-bottom: 6px
    }

    .mode-name {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 1px
    }

    .mode-desc {
      font-size: 11px;
      color: var(--muted);
      margin-top: 3px
    }

    /* ‚îÄ‚îÄ‚îÄ Tags ‚îÄ‚îÄ‚îÄ */
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      min-height: 24px
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 9px;
      border-radius: 5px;
      font-family: var(--mono);
      font-size: 11px;
      background: rgba(59, 130, 246, .12);
      color: var(--blue);
      border: 1px solid rgba(59, 130, 246, .25)
    }

    .tag button {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      line-height: 1;
      opacity: .6
    }

    .tag button:hover {
      opacity: 1
    }

    /* ‚îÄ‚îÄ‚îÄ Hero bar ‚îÄ‚îÄ‚îÄ */
    .hero {
      background: var(--surf);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 24px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 24px;
      position: relative;
      overflow: hidden
    }

    .hero::before {
      content: '';
      position: absolute;
      top: -40px;
      right: -40px;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, rgba(230, 57, 70, .06) 0%, transparent 70%);
      pointer-events: none
    }

    .hero-ring {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--border2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      transition: all .4s;
      flex-shrink: 0
    }

    .hero-ring.running {
      border-color: var(--green);
      box-shadow: 0 0 24px rgba(34, 197, 94, .18)
    }

    .hero-ring.paused {
      border-color: var(--yellow);
      box-shadow: 0 0 24px rgba(240, 180, 41, .18)
    }

    .hero-ring.stopped {
      border-color: var(--muted)
    }

    .hero-info {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px
    }

    .info-box {
      background: var(--surf2);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 10px 13px
    }

    .info-lbl {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 4px
    }

    .info-val {
      font-size: 14px;
      font-weight: 600;
      color: var(--text)
    }

    .info-val.g {
      color: var(--green)
    }

    .info-val.r {
      color: var(--red)
    }

    .info-val.y {
      color: var(--yellow)
    }

    .hero-btns {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 124px
    }

    /* ‚îÄ‚îÄ‚îÄ Pause banner ‚îÄ‚îÄ‚îÄ */
    .pause-banner {
      background: rgba(240, 180, 41, .07);
      border: 1px solid rgba(240, 180, 41, .3);
      border-radius: var(--r);
      padding: 12px 18px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 12px
    }

    .pause-banner.show {
      display: flex
    }

    /* ‚îÄ‚îÄ‚îÄ Upload zone ‚îÄ‚îÄ‚îÄ */
    .upload-zone {
      border: 2px dashed var(--border2);
      border-radius: var(--r);
      padding: 28px;
      text-align: center;
      cursor: pointer;
      transition: all .2s
    }

    .upload-zone:hover,
    .upload-zone.drag {
      border-color: var(--red);
      background: rgba(230, 57, 70, .04)
    }

    .upload-icon {
      font-size: 36px;
      margin-bottom: 8px
    }

    .upload-text {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px
    }

    .upload-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px
    }

    /* ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .75);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px)
    }

    .overlay.hidden {
      display: none
    }

    .modal {
      background: var(--surf);
      border: 1px solid var(--border2);
      border-radius: var(--r);
      padding: 26px;
      width: 440px;
      max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto
    }

    .modal-title {
      font-family: var(--display);
      font-size: 24px;
      letter-spacing: 1.5px;
      margin-bottom: 4px
    }

    .modal-sub {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 20px
    }

    .modal-footer {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border)
    }

    .modal-divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 16px 0
    }

    /* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
    .toast-ct {
      position: fixed;
      bottom: 22px;
      right: 22px;
      display: flex;
      flex-direction: column;
      gap: 7px;
      z-index: 9000
    }

    .toast {
      padding: 10px 15px;
      border-radius: 7px;
      font-family: var(--mono);
      font-size: 12px;
      border: 1px solid;
      animation: tIn .2s ease;
      max-width: 320px
    }

    .toast.ok {
      background: rgba(34, 197, 94, .1);
      border-color: rgba(34, 197, 94, .3);
      color: var(--green)
    }

    .toast.err {
      background: rgba(230, 57, 70, .1);
      border-color: rgba(230, 57, 70, .3);
      color: var(--red)
    }

    .toast.info {
      background: rgba(59, 130, 246, .1);
      border-color: rgba(59, 130, 246, .3);
      color: var(--blue)
    }

    .toast.warn {
      background: rgba(240, 180, 41, .1);
      border-color: rgba(240, 180, 41, .3);
      color: var(--yellow)
    }

    @keyframes tIn {
      from {
        transform: translateX(14px);
        opacity: 0
      }

      to {
        transform: none;
        opacity: 1
      }
    }

    /* ‚îÄ‚îÄ‚îÄ Misc ‚îÄ‚îÄ‚îÄ */
    .empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px
    }

    .empty .ei {
      font-size: 36px;
      margin-bottom: 10px
    }

    .sep {
      border: none;
      border-top: 1px solid var(--border);
      margin: 18px 0
    }

    .help-text {
      font-size: 12px;
      color: var(--muted);
      margin-top: 5px;
      line-height: 1.5
    }

    .target-hint {
      display: none;
      margin-top: 12px
    }

    .target-hint.show {
      display: block
    }

    /* ‚îÄ‚îÄ‚îÄ Play mode cards ‚îÄ‚îÄ‚îÄ */
    .play-card {
      background: var(--surf);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: border-color .2s, transform .15s;
      cursor: default;
      position: relative;
      overflow: hidden
    }

    .play-card::before {
      content: '';
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity .2s;
      pointer-events: none
    }

    .play-card:hover {
      transform: translateY(-2px)
    }

    .play-card-icon {
      font-size: 36px;
      line-height: 1
    }

    .play-card-title {
      font-family: var(--display);
      font-size: 24px;
      letter-spacing: 1.5px
    }

    .play-card-desc {
      font-size: 13px;
      color: var(--muted2);
      line-height: 1.6;
      flex: 1
    }

    .play-card-badge {
      display: inline-flex;
      align-items: center;
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 1px;
      padding: 3px 9px;
      border-radius: 12px;
      width: fit-content
    }

    .play-card-btn {
      width: 100%;
      margin-top: 4px
    }

    .badge-green {
      background: rgba(34, 197, 94, .12);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, .25)
    }

    .badge-blue {
      background: rgba(59, 130, 246, .12);
      color: var(--blue);
      border: 1px solid rgba(59, 130, 246, .25)
    }

    .badge-yellow {
      background: rgba(240, 180, 41, .12);
      color: var(--yellow);
      border: 1px solid rgba(240, 180, 41, .25)
    }

    /* Active play card highlight */
    .play-card.running-auto {
      border-color: var(--green)
    }

    .play-card.running-auto::before {
      background: radial-gradient(ellipse at 0 0, rgba(34, 197, 94, .07), transparent 60%);
      opacity: 1
    }

    .play-card.running-wait {
      border-color: var(--blue)
    }

    .play-card.running-wait::before {
      background: radial-gradient(ellipse at 0 0, rgba(59, 130, 246, .07), transparent 60%);
      opacity: 1
    }

    .play-card.running-pvp {
      border-color: var(--yellow)
    }

    .play-card.running-pvp::before {
      background: radial-gradient(ellipse at 0 0, rgba(240, 180, 41, .07), transparent 60%);
      opacity: 1
    }

    /* PvP sub-options */
    .pvp-option {
      background: var(--surf2);
      border: 1px solid var(--border2);
      border-radius: 8px;
      padding: 14px 16px;
      cursor: pointer;
      transition: border-color .15s
    }

    .pvp-option:hover {
      border-color: var(--border)
    }

    .pvp-option.sel {
      border-color: var(--yellow);
      background: rgba(240, 180, 41, .06)
    }

    .pvp-option-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 3px
    }

    .pvp-option-desc {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5
    }

    /* ‚îÄ‚îÄ Strategy Guide Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .guide-tab {
      padding: 8px 16px;
      font-family: var(--mono);
      font-size: 11px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--muted);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: color .15s, border-color .15s;
    }

    .guide-tab:hover {
      color: var(--fg);
    }

    .guide-tab.active {
      color: var(--blue);
      border-bottom-color: var(--blue);
    }

    .guide-panel {
      display: block;
    }

    .guide-panel.hidden {
      display: none;
    }

    .guide-section {
      font-family: var(--mono);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--muted);
      margin: 18px 0 6px;
    }

    .guide-code {
      background: var(--surf2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px 14px;
      font-family: var(--mono);
      font-size: 11.5px;
      line-height: 1.65;
      color: var(--fg);
      white-space: pre;
      overflow-x: auto;
      margin: 0;
    }

    .guide-p {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.6;
      margin: 0 0 4px;
    }

    .ic {
      font-family: var(--mono);
      font-size: 11px;
      background: var(--surf2);
      border: 1px solid var(--border);
      padding: 1px 5px;
      border-radius: 3px;
      color: var(--blue);
    }

    /* ‚îÄ‚îÄ Stats graphs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .sparkline-wrap {
      position: relative;
      height: 72px;
      margin: 8px 0 0;
    }

    .sparkline-canvas {
      width: 100%;
      height: 72px;
      display: block;
    }

    .graph-legend {
      display: flex;
      gap: 12px;
      margin-top: 6px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted);
    }

    .graph-legend span::before {
      content: '‚ñ† ';
      font-size: 9px;
    }

    .trend-card {
      margin-top: 16px;
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">
      <div class="logo-icon">üÉè</div>
      <div>
        <div class="logo-text">UNOBOT</div>
        <div class="logo-sub">Control Panel</div>
      </div>
    </div>
    <div class="hdr-right">
      <div class="hdr-strategy" id="hdr-strategy">‚Äî</div>
      <div class="hdr-room" id="hdr-room">No room</div>
      <a href="https://uno-839271117832.europe-west1.run.app/watch" target="_blank" class="btn btn-ghost btn-sm"
        style="text-decoration:none;font-size:10px;padding:5px 11px" title="Watch the featured game">üëÅ Featured</a>
      <div class="status-pill">
        <div class="dot stopped" id="hdr-dot"></div>
        <span id="hdr-status">OFFLINE</span>
        <span id="hdr-uptime" style="color:var(--muted);margin-left:4px"></span>
      </div>
    </div>
  </header>

  <div class="layout">
    <nav class="nav">
      <div class="nav-section">Control</div>
      <div class="nav-item active" data-page="control" onclick="navTo('control',this)">
        <span class="nav-icon">‚ö°</span>Bot Control
      </div>
      <div class="nav-item" data-page="live" onclick="navTo('live',this)">
        <span class="nav-icon">üì°</span>Live Action
      </div>
      <div class="nav-section">Strategy</div>
      <div class="nav-item" data-page="strategies" onclick="navTo('strategies',this)">
        <span class="nav-icon">üß†</span>Strategies
      </div>
      <div class="nav-item" data-page="stats" onclick="navTo('stats',this)">
        <span class="nav-icon">üìä</span>Statistics
      </div>
      <div class="nav-section">Settings</div>
      <div class="nav-item" data-page="config" onclick="navTo('config',this)">
        <span class="nav-icon">‚öôÔ∏è</span>Bot Identity
      </div>
      <div class="nav-section">Debug</div>
      <div class="nav-item" data-page="logs" onclick="navTo('logs',this)">
        <span class="nav-icon">üìü</span>Raw Log
      </div>
    </nav>

    <main class="content">

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOT CONTROL ‚ïê‚ïê‚ïê -->
      <div class="page active" id="page-control">
        <div class="page-title">BOT CONTROL</div>

        <!-- Status bar -->
        <div class="hero">
          <div class="hero-ring stopped" id="big-ring">üî¥</div>
          <div class="hero-info">
            <div class="info-box">
              <div class="info-lbl">Status</div>
              <div class="info-val" id="h-status">Stopped</div>
            </div>
            <div class="info-box">
              <div class="info-lbl">Strategy</div>
              <div class="info-val r" id="h-strategy">‚Äî</div>
            </div>
            <div class="info-box">
              <div class="info-lbl">Room</div>
              <div class="info-val" id="h-room">‚Äî</div>
            </div>
            <div class="info-box">
              <div class="info-lbl">Uptime</div>
              <div class="info-val g" id="h-uptime">‚Äî</div>
            </div>
          </div>
          <div class="hero-btns">
            <button class="btn btn-yellow" id="btn-pause" onclick="pauseBot()" disabled style="display:none">‚è∏
              PAUSE</button>
            <button class="btn btn-yellow-solid" id="btn-resume" onclick="resumeBot()" style="display:none">‚ñ∂
              RESUME</button>
            <button class="btn btn-red" id="btn-stop" onclick="confirmStop()" disabled>‚ñ† STOP</button>
          </div>
        </div>

        <!-- Pause banner -->
        <div class="pause-banner" id="pause-banner">
          <span style="font-size:20px">‚è∏</span>
          <div style="flex:1">
            <div style="color:var(--yellow);font-family:var(--mono);font-size:12px;font-weight:600;letter-spacing:1px">
              BOT PAUSED</div>
            <div style="color:var(--muted);font-size:12px;margin-top:2px">Will finish current game then wait here until
              resumed.</div>
          </div>
          <button class="btn btn-yellow-solid btn-sm" onclick="resumeBot()">‚ñ∂ Resume</button>
        </div>

        <!-- Room info bar ‚Äî shown when in a room -->
        <div class="card" id="room-card" style="display:none">
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <div style="font-size:20px">üü¢</div>
            <div style="flex:1;min-width:0">
              <div
                style="font-family:var(--mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">
                Active Room</div>
              <div style="font-family:var(--mono);font-size:12px;color:var(--green);margin-top:2px;word-break:break-all"
                id="room-id-display">‚Äî</div>
            </div>
            <a id="ctrl-watch-room-btn" href="#" target="_blank" class="btn btn-blue btn-sm"
              style="text-decoration:none" title="Watch your bot's game live">üëÅ Watch Game</a>
            <button class="btn btn-red btn-sm" id="btn-leave" onclick="leaveRoom()">üö™ Leave</button>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ Compact Telemetry Strip (control page) ‚îÄ‚îÄ -->
        <div id="ctrl-telem-strip" style="display:none">
          <div class="card" style="padding:12px 18px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
              <div style="display:flex;align-items:center;gap:8px">
                <span
                  style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted)">üß†
                  Live Telemetry</span>
                <span id="ctrl-telem-mode" style="font-family:var(--mono);font-size:9px"></span>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <span id="ctrl-telem-faults" style="font-family:var(--mono);font-size:10px;color:var(--red)"></span>
                <span id="ctrl-telem-ts" style="font-family:var(--mono);font-size:9px;color:var(--muted)"></span>
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="telem-box" style="flex:1;min-width:60px">
                <div class="telem-lbl">Turn</div>
                <div class="telem-val" id="ctrl-telem-turn">‚Äî</div>
                <div class="telem-sub">in game</div>
              </div>
              <div class="telem-box" style="flex:1;min-width:60px">
                <div class="telem-lbl">Hand</div>
                <div class="telem-val" id="ctrl-telem-hand">‚Äî</div>
                <div class="telem-sub">cards</div>
              </div>
              <div class="telem-box" style="flex:1;min-width:60px">
                <div class="telem-lbl">Playable</div>
                <div class="telem-val" id="ctrl-telem-playable">‚Äî</div>
                <div class="telem-sub">options</div>
              </div>
              <div class="telem-box" style="flex:1;min-width:60px">
                <div class="telem-lbl">Colour</div>
                <div class="telem-val" id="ctrl-telem-color" style="font-size:12px">‚Äî</div>
                <div class="telem-sub">dominant</div>
              </div>
              <div class="telem-box" style="flex:1;min-width:60px">
                <div class="telem-lbl">NN</div>
                <div class="telem-val" id="ctrl-telem-nn">‚Äî</div>
                <div class="telem-sub">confidence</div>
              </div>
              <div class="telem-box" style="flex:1;min-width:60px">
                <div class="telem-lbl">Threat</div>
                <div class="telem-val" id="ctrl-telem-threat">‚Äî</div>
                <div class="telem-sub">opponent</div>
              </div>
            </div>
            <!-- NN confidence bar -->
            <div style="margin-top:10px">
              <div class="nn-bar">
                <div class="nn-bar-fill" id="ctrl-nn-fill" style="width:0%"></div>
              </div>
              <div
                style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:8px;color:var(--muted);margin-top:2px">
                <span>Guessing</span><span id="ctrl-nn-weight"></span><span>Confident</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Strategy picker (compact, always visible) -->
        <div class="card">
          <div class="card-title" style="margin-bottom:12px">STRATEGY</div>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <div style="flex:1">
              <select id="launch-strat">
                <option value="">‚Äî Use active strategy ‚Äî</option>
              </select>
            </div>
            <button class="btn btn-ghost btn-sm"
              onclick="navTo('strategies', document.querySelector('[data-page=strategies]'))">Manage</button>
          </div>
        </div>

        <!-- The three big play mode cards -->
        <div
          style="font-family:var(--mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:12px">
          Choose How to Play</div>

        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-bottom:8px">

          <!-- ‚îÄ‚îÄ CARD 1: Auto Grind ‚îÄ‚îÄ -->
          <div class="play-card" id="pc-auto">
            <div class="play-card-icon">üöÄ</div>
            <div class="play-card-title">Auto Grind</div>
            <div class="play-card-desc">Creates a new room each time. Bot keeps playing game after game automatically
              until you press Stop.</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
              <div class="play-card-badge badge-green">‚ôæ Continuous</div>
              <div class="play-card-badge" id="auto-sandbox-badge"
                style="display:none;background:rgba(230,57,70,.12);color:var(--red);border:1px solid rgba(230,57,70,.3)">
                ‚ö† Sandbox only</div>
            </div>
            <div id="auto-sandbox-warn"
              style="display:none;font-family:var(--mono);font-size:10px;color:var(--red);line-height:1.5">
              Creating rooms requires Sandbox Mode. Enable it in Bot Identity settings.
            </div>
            <button class="btn btn-green play-card-btn" id="btn-auto" onclick="startMode('auto')">‚ñ∂ Start
              Grinding</button>
          </div>

          <!-- ‚îÄ‚îÄ CARD 2: Wait for Room ‚îÄ‚îÄ -->
          <div class="play-card" id="pc-wait">
            <div class="play-card-icon">‚è≥</div>
            <div class="play-card-title">Wait for Room</div>
            <div class="play-card-desc">Bot waits for an open room to join. When a game ends it waits for the next one
              automatically until you press Stop.</div>
            <div class="play-card-badge badge-blue">‚ôæ Continuous</div>
            <button class="btn btn-blue play-card-btn" id="btn-wait" onclick="startMode('wait')">‚ñ∂ Start
              Waiting</button>
          </div>

          <!-- ‚îÄ‚îÄ CARD 3: Play with Friends ‚îÄ‚îÄ -->
          <div class="play-card" id="pc-pvp">
            <div class="play-card-icon">üéØ</div>
            <div class="play-card-title">Play with Friends</div>
            <div class="play-card-desc">Join a specific player's room, or create a new room so friends can join you. Bot
              stops after the game finishes.</div>
            <div class="play-card-badge badge-yellow">1 Game</div>
            <button class="btn btn-yellow-solid play-card-btn" id="btn-pvp" onclick="openPvpModal()">‚ñ∂ Set Up
              Game</button>
          </div>

        </div>

      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIVE ACTION ‚ïê‚ïê‚ïê‚ïê -->
      <div class="page" id="page-live">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px">
          <div class="page-title" style="margin:0">LIVE ACTION</div>
          <div style="display:flex;gap:8px;align-items:center">
            <a id="watch-featured-btn" href="https://uno-839271117832.europe-west1.run.app/watch" target="_blank"
              class="btn btn-ghost btn-sm" style="text-decoration:none">üëÅ Featured Game</a>
            <a id="watch-room-btn" href="https://uno-839271117832.europe-west1.run.app/watch" target="_blank"
              class="btn btn-blue btn-sm" style="text-decoration:none;display:none">üëÅ Watch My Game</a>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ Activity Feed ‚îÄ‚îÄ -->
        <div class="card" style="padding:0;overflow:hidden">
          <div class="term-bar">
            <div style="display:flex;align-items:center;gap:10px">
              <div class="term-dots">
                <div class="td r"></div>
                <div class="td y"></div>
                <div class="td g"></div>
              </div>
              <span class="term-label">Activity Feed</span>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <span id="feed-count" style="font-family:var(--mono);font-size:10px;color:var(--muted)"></span>
              <button class="btn btn-ghost btn-xs" onclick="clearFeed()">‚úï Clear</button>
              <label class="tog" title="Auto-scroll">
                <input type="checkbox" id="feed-scroll" checked>
                <span class="tog-track"></span>
              </label>
              <span style="font-family:var(--mono);font-size:10px;color:var(--muted)">Scroll</span>
            </div>
          </div>
          <div class="feed" id="feed-body">
            <div class="feed-empty">
              <div class="ei">üì°</div>
              <div>Waiting for game activity‚Ä¶</div>
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ Strategy Telemetry (optional ‚Äî shown when strategy emits telemetry) ‚îÄ‚îÄ -->
        <div class="card" id="telem-card">
          <div class="card-title">
            <div style="display:flex;align-items:center;gap:10px">
              <span>üß† STRATEGY TELEMETRY</span>
              <span id="telem-mode-pill"></span>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span id="telem-ts" style="font-family:var(--mono);font-size:10px;color:var(--muted)"></span>
              <button class="btn btn-ghost btn-xs" onclick="toggleTelemFeed()">üìã Feed</button>
            </div>
          </div>

          <!-- Current turn snapshot -->
          <div class="telem-grid" id="telem-turn-grid"></div>

          <!-- Neural network confidence bar -->
          <div id="telem-nn-row" style="margin-bottom:14px;display:none">
            <div
              style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:4px">
              <span>Network Confidence</span>
              <span id="telem-nn-val">‚Äî</span>
            </div>
            <div class="nn-bar">
              <div class="nn-bar-fill" id="telem-nn-fill" style="width:0%"></div>
            </div>
            <div
              style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:3px">
              <span>Guessing</span><span id="telem-nn-weight"></span><span>Confident</span>
            </div>
          </div>

          <!-- Faults -->
          <div id="telem-faults-row" style="margin-bottom:14px;display:none">
            <div
              style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:6px">
              ‚ö† Active Faults</div>
            <div id="telem-faults-pills"></div>
          </div>

          <!-- Last game summary -->
          <div id="telem-game-row"
            style="display:none;padding:12px;background:var(--surf2);border-radius:8px;margin-bottom:14px">
            <div
              style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:8px">
              Last Game</div>
            <div id="telem-game-grid" class="telem-grid" style="margin-bottom:8px"></div>
            <div id="telem-lifetime" style="font-family:var(--mono);font-size:11px;color:var(--muted2)"></div>
          </div>

          <!-- Telemetry feed (toggleable) -->
          <div id="telem-feed-wrap" style="display:none">
            <div
              style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:6px">
              Telemetry Log</div>
            <div class="telem-feed" id="telem-feed-body"></div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ Lifetime Stats ‚îÄ‚îÄ -->
        <div class="card">
          <div class="card-title">
            LIFETIME STATS
            <span id="live-lifetime-strat"
              style="font-family:var(--mono);font-size:10px;font-weight:400;color:var(--muted)"></span>
          </div>
          <div class="stat-grid">
            <div class="stat-box">
              <div class="stat-lbl">Games</div>
              <div class="stat-val" id="lt-games">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-lbl">Win Rate</div>
              <div class="stat-val g" id="lt-wr">0%</div>
            </div>
            <div class="stat-box">
              <div class="stat-lbl">Wins</div>
              <div class="stat-val g" id="lt-wins">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-lbl">Losses</div>
              <div class="stat-val r" id="lt-losses">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-lbl">Cards Played</div>
              <div class="stat-val b" id="lt-cards">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-lbl">UNO Calls</div>
              <div class="stat-val y" id="lt-uno">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-lbl">Penalties</div>
              <div class="stat-val r" id="lt-pen">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-lbl">Avg Points</div>
              <div class="stat-val" id="lt-avg">0</div>
            </div>
          </div>
          <div id="lt-placements" style="margin-top:4px"></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STRATEGIES ‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="page" id="page-strategies">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px">
          <div class="page-title" style="margin:0">STRATEGIES</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="loadStrats()">‚Ü∫ Refresh</button>
            <button class="btn btn-ghost btn-sm" onclick="openModal('modal-guide')">üìñ Dev Guide</button>
            <button class="btn btn-blue btn-sm" onclick="openUploadModal()">üì¶ Upload Strategy</button>
          </div>
        </div>

        <div class="strat-grid" id="strat-grid">
          <div class="empty">
            <div class="ei">‚è≥</div>
            <div>Loading‚Ä¶</div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATISTICS ‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="page" id="page-stats">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px">
          <div class="page-title" style="margin:0">STATISTICS</div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="stats-sel" onchange="loadStats(this.value)" style="width:auto;min-width:180px">
              <option value="">Select strategy‚Ä¶</option>
            </select>
            <button class="btn btn-ghost btn-sm"
              onclick="loadStats(document.getElementById('stats-sel').value)">‚Ü∫</button>
          </div>
        </div>
        <div id="stats-content">
          <div class="empty">
            <div class="ei">üìä</div>
            <div>Select a strategy above to view stats</div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOT IDENTITY ‚ïê‚ïê‚ïê -->
      <div class="page" id="page-config">
        <div class="page-title">BOT IDENTITY</div>

        <!-- Active strategy selector -->
        <div class="card">
          <div class="card-title">Default Strategy <span
              style="font-family:var(--mono);font-size:11px;font-weight:400;color:var(--muted)">used when bot starts
              without an explicit choice</span></div>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <div style="flex:1">
              <span class="flbl">Active Strategy</span>
              <select id="g-active-strat" onchange="saveActiveStrategy()">
                <option value="">Loading‚Ä¶</option>
              </select>
            </div>
            <button class="btn btn-ghost btn-sm"
              onclick="navTo('strategies', document.querySelector('[data-page=strategies]'))">Manage ‚Üí</button>
          </div>
          <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:8px">Saves immediately when
            you change the selection.</div>
        </div>

        <div class="card">
          <div class="card-title">Default Identity <span
              style="font-family:var(--mono);font-size:11px;font-weight:400;color:var(--muted)">used when strategy has
              no override</span></div>
          <div class="row2">
            <div class="field"><span class="flbl">First Name</span><input type="text" id="g-first"
                placeholder="WorldClass" onblur="saveIdentityField()"></div>
            <div class="field"><span class="flbl">Last Name</span><input type="text" id="g-last" placeholder="UnoBot"
                onblur="saveIdentityField()"></div>
          </div>
          <div class="field"><span class="flbl">Player / Display Name</span><input type="text" id="g-player"
              placeholder="HoerBoer" onblur="saveIdentityField()"></div>
          <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:-6px">Changes save
            automatically when you click away from a field.</div>
        </div>

        <div class="card">
          <div class="card-title">Behaviour</div>
          <div class="toggle-row">
            <div class="toggle-info">
              <div class="tlbl">Sandbox Mode</div>
              <div class="tsub">Play against bots only, no real opponents</div>
            </div>
            <label class="tog"><input type="checkbox" id="g-sandbox" onchange="saveBehaviourField()"><span
                class="tog-track"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info">
              <div class="tlbl">Auto Rejoin</div>
              <div class="tsub">Automatically rejoin after each game ends</div>
            </div>
            <label class="tog"><input type="checkbox" id="g-rejoin" checked onchange="saveBehaviourField()"><span
                class="tog-track"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info">
              <div class="tlbl">Only Human Players</div>
              <div class="tsub">Only join rooms that have real players</div>
            </div>
            <label class="tog"><input type="checkbox" id="g-only" onchange="saveBehaviourField()"><span
                class="tog-track"></span></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info">
              <div class="tlbl">Debug Mode</div>
              <div class="tsub">Verbose output in the raw log</div>
            </div>
            <label class="tog"><input type="checkbox" id="g-debug" onchange="saveBehaviourField()"><span
                class="tog-track"></span></label>
          </div>
          <div class="row2" style="margin-top:16px">
            <div class="field"><span class="flbl">Rejoin Delay (seconds)</span><input type="number" id="g-delay" min="0"
                max="60" value="3" onblur="saveBehaviourField()"></div>
            <div class="field"><span class="flbl">Room Check Interval (s)</span><input type="number" id="g-check"
                min="1" max="60" value="5" onblur="saveBehaviourField()"></div>
          </div>
          <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:8px">Toggles save
            immediately. Number fields save when you click away.</div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RAW LOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="page" id="page-logs">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px">
          <div class="page-title" style="margin:0">RAW LOG</div>
          <div style="display:flex;align-items:center;gap:10px">
            <span id="log-count" style="font-family:var(--mono);font-size:10px;color:var(--muted)"></span>
            <button class="btn btn-ghost btn-sm" onclick="clearLogDisplay()">‚úï Clear</button>
            <label class="tog"><input type="checkbox" id="log-scroll" checked><span class="tog-track"></span></label>
            <span style="font-family:var(--mono);font-size:10px;color:var(--muted)">Auto-scroll</span>
          </div>
        </div>
        <div class="term">
          <div class="term-bar">
            <div class="term-dots">
              <div class="td r"></div>
              <div class="td y"></div>
              <div class="td g"></div>
            </div>
            <div class="term-label">bot stdout</div>
            <div></div>
          </div>
          <div class="term-body" id="log-body">
            <div class="ll dim">Waiting for bot activity‚Ä¶</div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- ‚ïê‚ïê MODAL: Play with Friends ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="overlay hidden" id="modal-pvp">
    <div class="modal" style="width:480px">
      <div class="modal-title">Play with Friends</div>
      <div class="modal-sub">One game ‚Äî bot stops when it finishes</div>

      <!-- Sub-option selector -->
      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px">
        <div class="pvp-option sel" id="pvp-opt-join" onclick="selectPvpOpt('join')">
          <div class="pvp-option-title">üéØ Find a Player's Room</div>
          <div class="pvp-option-desc">Search for a specific player and join their room.</div>
        </div>
        <div class="pvp-option" id="pvp-opt-create" onclick="selectPvpOpt('create')">
          <div class="pvp-option-title">üè† Create a Room for Friends</div>
          <div class="pvp-option-desc">Create a new PvP room. Share the Room ID with friends so they can join you.</div>
        </div>
      </div>

      <!-- Join section -->
      <div id="pvp-join-section">
        <div class="field">
          <span class="flbl">Player Name to Find</span>
          <input type="text" id="pvp-player-name" placeholder="Enter the player's exact name‚Ä¶"
            onkeydown="if(event.key==='Enter') startPvp()">
        </div>
        <p id="pvp-name-warn"
          style="display:none;font-family:var(--mono);font-size:11px;color:var(--red);margin-bottom:8px">
          ‚ö† Please enter a player name.
        </p>
      </div>

      <!-- Create section -->
      <div id="pvp-create-section" style="display:none">
        <div
          style="background:var(--surf2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:4px">
          <div
            style="font-family:var(--mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">
            What Happens</div>
          <ol style="font-size:13px;color:var(--muted2);line-height:1.9;padding-left:18px">
            <li>A new room is created and your bot joins it</li>
            <li>The Room ID is shown so you can share it with friends</li>
            <li>Game starts when players are ready</li>
            <li>Bot stops automatically when the game ends</li>
          </ol>
        </div>
      </div>

      <!-- Room ID display (shown after room creation) -->
      <div id="pvp-room-created" style="display:none;margin-top:14px">
        <div
          style="background:rgba(240,180,41,.07);border:1px solid rgba(240,180,41,.3);border-radius:8px;padding:14px">
          <div
            style="font-family:var(--mono);font-size:10px;color:var(--yellow);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">
            üè† Room Created ‚Äî Share This ID</div>
          <div style="font-family:var(--mono);font-size:15px;color:var(--text);word-break:break-all;margin-bottom:10px"
            id="pvp-room-id-display">‚Äî</div>
          <button class="btn btn-yellow-solid btn-sm" onclick="copyRoomId()">üìã Copy Room ID</button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modal-pvp')">Cancel</button>
        <button class="btn btn-yellow-solid" id="pvp-start-btn" onclick="startPvp()">‚ñ∂ Start</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê MODAL: Stop confirmation ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="overlay hidden" id="modal-stop">
    <div class="modal" style="width:380px">
      <div class="modal-title">Stop Bot?</div>
      <div class="modal-sub">Choose what happens to the current room</div>
      <p style="color:var(--muted);font-size:13px;margin-bottom:20px;line-height:1.6">
        Stopping the bot will terminate the process. Do you also want to leave the current game room?
      </p>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-red-solid" onclick="stopBot(true)" style="justify-content:flex-start;padding:12px 16px">
          <span style="font-size:16px">üö™</span>
          <div style="text-align:left">
            <div>Stop &amp; Leave Room</div>
            <div style="font-size:10px;opacity:.7;text-transform:none;letter-spacing:0;margin-top:2px">Terminates bot
              and leaves the game room</div>
          </div>
        </button>
        <button class="btn btn-ghost" onclick="stopBot(false)" style="justify-content:flex-start;padding:12px 16px">
          <span style="font-size:16px">‚èπ</span>
          <div style="text-align:left">
            <div>Stop Only</div>
            <div style="font-size:10px;opacity:.7;text-transform:none;letter-spacing:0;margin-top:2px">Terminates bot
              but stays in room</div>
          </div>
        </button>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modal-stop')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê MODAL: Leave room ‚Üí what next? ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="overlay hidden" id="modal-left-room">
    <div class="modal" style="width:420px">
      <div class="modal-title">Room Left</div>
      <div class="modal-sub">You've left the room ‚Äî what would you like to do next?</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:4px">
        <button class="btn btn-green" onclick="rejoinAfterLeave('auto')"
          style="justify-content:flex-start;padding:12px 16px">
          <span style="font-size:16px">üöÄ</span>
          <div style="text-align:left">
            <div>Join a Random Room</div>
            <div style="font-size:10px;opacity:.7;text-transform:none;letter-spacing:0;margin-top:2px">Find or create
              any available room</div>
          </div>
        </button>
        <button class="btn btn-ghost" onclick="showJoinPlayer()" style="justify-content:flex-start;padding:12px 16px"
          id="btn-join-player">
          <span style="font-size:16px">üéØ</span>
          <div style="text-align:left">
            <div>Join a Player's Room</div>
            <div style="font-size:10px;opacity:.7;text-transform:none;letter-spacing:0;margin-top:2px">Search by player
              name</div>
          </div>
        </button>
        <!-- Player name input ‚Äî revealed when "Join a Player's Room" is clicked -->
        <div id="join-player-input" style="display:none;padding:4px 0">
          <div class="field">
            <span class="flbl">Player Name</span>
            <input type="text" id="join-player-name" placeholder="Enter the player's name‚Ä¶"
              onkeydown="if(event.key==='Enter') rejoinAfterLeave('target')">
          </div>
          <p id="join-player-warn"
            style="display:none;font-family:var(--mono);font-size:11px;color:var(--red);margin-bottom:8px">
            ‚ö† Please enter a player name.
          </p>
          <button class="btn btn-green btn-sm" onclick="rejoinAfterLeave('target')">üéØ Find &amp; Join</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modal-left-room')">Stay Offline</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê MODAL: Strategy Dev Guide ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="overlay hidden" id="modal-guide">
    <div class="modal" style="width:760px;max-height:88vh;overflow-y:auto">
      <div class="modal-title">üìñ Strategy Developer Guide</div>
      <div class="modal-sub">Everything you need to build a custom UNO strategy</div>

      <!-- Tab bar -->
      <div style="display:flex;gap:0;border-bottom:1px solid var(--border);margin:16px 0 20px">
        <button class="guide-tab active" id="gtab-structure" onclick="switchGuideTab('structure')">File
          Structure</button>
        <button class="guide-tab" id="gtab-api" onclick="switchGuideTab('api')">BaseStrategy API</button>
        <button class="guide-tab" id="gtab-events" onclick="switchGuideTab('events')">Game Events</button>
        <button class="guide-tab" id="gtab-cards" onclick="switchGuideTab('cards')">Card Types</button>
        <button class="guide-tab" id="gtab-prompt" onclick="switchGuideTab('prompt')">ü§ñ AI Prompt</button>
      </div>

      <!-- TAB: File Structure -->
      <div class="guide-panel" id="gpanel-structure">
        <p class="guide-p">Each strategy lives in its own folder inside <code class="ic">strategies/</code>. The bot
          discovers strategies automatically ‚Äî no registration needed.</p>

        <div class="guide-section">Required files</div>
        <pre class="guide-code">strategies/
‚îî‚îÄ‚îÄ my_strategy/
    ‚îú‚îÄ‚îÄ __init__.py      ‚Üê exports your class
    ‚îú‚îÄ‚îÄ strategy.py      ‚Üê your strategy logic
    ‚îî‚îÄ‚îÄ stats.json       ‚Üê auto-created by the bot</pre>

        <div class="guide-section">__init__.py</div>
        <pre class="guide-code">from .strategy import MyStrategy</pre>

        <div class="guide-section">strategy.py skeleton</div>
        <pre class="guide-code">from strategies.base_strategy import BaseStrategy
from typing import Optional, Tuple, List, Dict, Any

class MyStrategy(BaseStrategy):
    """One-line description of your strategy."""

    def __init__(self):
        super().__init__()
        # Add any per-instance state here

    # ‚îÄ‚îÄ Required ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def choose_card(
        self,
        hand: List[Dict[str, Any]],
        top_card: Dict[str, Any],
        current_color: str,
    ) -> Tuple[Optional[int], Optional[str]]:
        """
        Return (card_index, wild_color) or (None, None) to draw.

        hand          ‚Äî list of your cards (see Card Format below)
        top_card      ‚Äî the current top of the discard pile
        current_color ‚Äî active color (may differ after a Wild)
        """
        playable = self.get_playable_cards(hand, top_card, current_color)
        if not playable:
            return None, None           # draw a card

        idx, card = playable[0]
        wild_color = self.pick_wild_color(hand) if "WILD" in card["type"] else None
        return idx, wild_color

    # ‚îÄ‚îÄ Optional lifecycle hooks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    def on_game_start(self):
        super().on_game_start()         # resets session counters
        # Reset any per-game state here

    def on_game_end(self, won: bool, placement: int, points: int):
        super().on_game_end(won, placement, points)  # saves stats!</pre>

        <div class="guide-section">Deploy</div>
        <p class="guide-p">Zip the folder and upload via <strong>Upload Strategy</strong> ‚Äî the bot restarts with it
          available immediately. No code changes to the bot required.</p>
      </div>

      <!-- TAB: BaseStrategy API -->
      <div class="guide-panel hidden" id="gpanel-api">
        <div class="guide-section">Playability helpers</div>
        <pre class="guide-code">self.is_playable(card, top_card, current_color) ‚Üí bool
self.get_playable_cards(hand, top_card, current_color) ‚Üí [(index, card), ...]
self.pick_wild_color(hand) ‚Üí "RED" | "BLUE" | "GREEN" | "YELLOW"
self.cards_by_type(hand, "SKIP") ‚Üí [(index, card), ...]
self.count_color(hand, "RED") ‚Üí int</pre>

        <div class="guide-section">Session stat recording (call in choose_card)</div>
        <pre class="guide-code">self._record_play(card, wild_color=None)   # call when you play
self._record_draw()                         # call when you draw</pre>

        <div class="guide-section">Lifecycle hooks</div>
        <pre class="guide-code">def on_game_start(self)
    # called once per game ‚Äî always call super().on_game_start()

def on_game_end(self, won: bool, placement: int, points: int)
    # called when game ends ‚Äî always call super().on_game_end(...)
    # super() calls _persist_stats() which saves to stats.json

def on_turn_start(self, hand, top_card, current_color)
    # optional ‚Äî called before choose_card every turn</pre>

        <div class="guide-section">Reading stats from inside your strategy</div>
        <pre class="guide-code">from strategies.stats import StrategyStats
s = StrategyStats("my_strategy")
s.games_played     # int
s.win_rate         # float (0‚Äì100)
s.wins / s.losses  # int
s.avg_points_per_game  # float
s.placements       # {"1": n, "2": n, "3": n, "4+": n}</pre>

        <div class="guide-section">Persisting custom data (e.g. learned weights)</div>
        <pre class="guide-code">import json, os
_DIR = os.path.dirname(os.path.abspath(__file__))

def _load():
    path = os.path.join(_DIR, "weights.json")
    if os.path.exists(path):
        return json.load(open(path))
    return {"aggression": 0.5}

def _save(data):
    json.dump(data, open(os.path.join(_DIR, "weights.json"), "w"), indent=2)</pre>
      </div>

      <!-- TAB: Game Events -->
      <div class="guide-panel hidden" id="gpanel-events">
        <p class="guide-p">The bot handles all Socket.io events for you. Your strategy only needs <code
            class="ic">choose_card()</code>. These are the events the server emits:</p>

        <div class="guide-section">turn (public) ‚Äî fires on every state change</div>
        <pre class="guide-code">{
  roomId:       "uuid",
  playerId:     "uuid",        // whose turn it is
  playerName:   "Bot 1",
  topCard:      { color: "RED", type: "NUMBER", value: 5 },
  currentColor: "RED",         // active color after wilds
  unoCalled:    false,
  history:      [ {color, type, value}, ... ],
  players:      [ { id, name, cardCount, score }, ... ]
}</pre>

        <div class="guide-section">turn (private) ‚Äî only sent to the player whose turn it is</div>
        <pre class="guide-code">{
  ...publicTurnData,
  hand: [ { color: "RED", type: "NUMBER", value: 5 }, ... ]
}</pre>

        <div class="guide-section">action ‚Äî card played or drawn</div>
        <pre class="guide-code">{
  type:     "play" | "draw" | "uno" | "penalty",
  playerId: "uuid",
  card:     { color, type, value },   // card involved (if any)
  result: {
    success:            true,
    penalty:            boolean,
    penaltyTitle:       "string",     // only if penalty
    penaltyDescription: "string"      // only if penalty
  },
  gameState: { ... }
}</pre>

        <div class="guide-section">gameStart</div>
        <pre class="guide-code">{ players: [ { id, name, cardCount, score }, ... ] }</pre>

        <div class="guide-section">gameEnd</div>
        <pre class="guide-code">{
  winner: { id: "uuid", name: "Winner Name" },
  score:  50,           // points from opponents' hands
  reason: "played_out"
}</pre>

        <div class="guide-section">countdownStart / countdownCancel</div>
        <pre class="guide-code">countdownStart: { seconds: 10, message: "Game starting in..." }
countdownCancel: { reason: "Not enough players" }</pre>

        <div class="guide-section">REST API actions available</div>
        <pre class="guide-code">play_card(room_id, player_id, card_index, wild_color=None)
draw_card(room_id, player_id)
pass_turn(room_id, player_id)     # only after drawing an unplayable card
call_uno(room_id, player_id)      # call before playing 2nd-to-last card
catchout(room_id, challenger_id, target_id)  # challenge missed UNO</pre>
      </div>

      <!-- TAB: Card Types -->
      <div class="guide-panel hidden" id="gpanel-cards">
        <p class="guide-p">Every card in <code class="ic">hand</code>, <code class="ic">top_card</code>, or <code
            class="ic">history</code> follows this structure:</p>

        <div class="guide-section">Card object</div>
        <pre class="guide-code">{ color: Color, type: CardType, value?: number }</pre>

        <div class="guide-section">Color values</div>
        <pre class="guide-code">type Color = "RED" | "BLUE" | "GREEN" | "YELLOW" | "WILD"</pre>

        <div class="guide-section">Card type values</div>
        <pre class="guide-code">type CardType =
  | "NUMBER"         // value: 0‚Äì9
  | "SKIP"           // skip next player
  | "REVERSE"        // reverse play order
  | "DRAW_TWO"       // next player draws 2 and loses turn
  | "WILD"           // choose any color
  | "WILD_DRAW_FOUR" // choose color + next player draws 4</pre>

        <div class="guide-section">Examples</div>
        <pre class="guide-code">{ color: "RED",  type: "NUMBER",         value: 7 }
{ color: "BLUE", type: "SKIP"                     }
{ color: "WILD", type: "WILD"                     }
{ color: "WILD", type: "WILD_DRAW_FOUR"           }</pre>

        <div class="guide-section">Point values (used in scoring)</div>
        <pre class="guide-code">NUMBER cards     ‚Üí  face value (0‚Äì9)
SKIP             ‚Üí  20 pts
REVERSE          ‚Üí  20 pts
DRAW_TWO         ‚Üí  20 pts
WILD             ‚Üí  50 pts
WILD_DRAW_FOUR   ‚Üí  50 pts</pre>

        <div class="guide-section">Rate limiting</div>
        <pre class="guide-code">Max 60 actions / minute (1 per second average) per MAC address.
Header: X-MAC-Address: 00:11:22:33:44:55
The bot sends this automatically from config.</pre>

        <div class="guide-section">Key rules</div>
        <pre class="guide-code">‚Ä¢ You can only play a card if:
    card.color == currentColor, OR
    card.type  == top_card.type (for action cards), OR
    card.value == top_card.value (for NUMBER cards), OR
    card.type.startsWith("WILD")

‚Ä¢ After drawing: if drawn card is not playable, call pass_turn()
‚Ä¢ Call UNO before playing your 2nd-to-last card (when hand.length == 2)
‚Ä¢ Catchout a player who has 1 card and did not call UNO</pre>
      </div>

      <!-- TAB: AI Prompt -->
      <div class="guide-panel hidden" id="gpanel-prompt">
        <p class="guide-p">Copy this prompt into Claude, ChatGPT, or any AI assistant. It includes the full API context
          so the AI generates a working, uploadable strategy with no extra setup.</p>

        <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
          <button class="btn btn-blue btn-sm" onclick="copyPrompt()">üìã Copy Prompt</button>
        </div>

        <pre class="guide-code" id="ai-prompt-text"
          style="max-height:520px;overflow-y:auto;user-select:text;font-size:11px">Create a Python UNO bot strategy for me. Here is all the context you need:

‚îÅ‚îÅ‚îÅ PROJECT STRUCTURE ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
strategies/
‚îî‚îÄ‚îÄ my_strategy/
    ‚îú‚îÄ‚îÄ __init__.py      ‚Üê from .strategy import MyStrategy
    ‚îú‚îÄ‚îÄ strategy.py      ‚Üê your code goes here
    ‚îî‚îÄ‚îÄ stats.json       ‚Üê auto-created, do not create manually

‚îÅ‚îÅ‚îÅ BASE CLASS (strategies/base_strategy.py) ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

from strategies.base_strategy import BaseStrategy
from typing import Optional, Tuple, List, Dict, Any

class MyStrategy(BaseStrategy):

    def __init__(self):
        super().__init__()

    # REQUIRED ‚Äî return (card_index, wild_color) or (None, None) to draw
    def choose_card(self, hand, top_card, current_color):
        ...

    # OPTIONAL lifecycle hooks ‚Äî always call super()
    def on_game_start(self):
        super().on_game_start()

    def on_game_end(self, won, placement, points):
        super().on_game_end(won, placement, points)  # saves stats to disk

‚îÅ‚îÅ‚îÅ BUILT-IN HELPERS (all inherited from BaseStrategy) ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

self.get_playable_cards(hand, top_card, current_color) ‚Üí [(idx, card), ...]
self.is_playable(card, top_card, current_color) ‚Üí bool
self.pick_wild_color(hand) ‚Üí "RED"|"BLUE"|"GREEN"|"YELLOW"  (picks most common)
self.cards_by_type(hand, "SKIP") ‚Üí [(idx, card), ...]
self.count_color(hand, "RED") ‚Üí int

# Call these in choose_card for automatic stats tracking:
self._record_play(card, wild_color=None)
self._record_draw()

# Read lifetime stats from inside your strategy:
from strategies.stats import StrategyStats
s = StrategyStats("my_strategy")
print(s.win_rate, s.games_played, s.placements)

‚îÅ‚îÅ‚îÅ CARD FORMAT ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Every card is a dict:
  { "color": Color, "type": CardType, "value": int (NUMBER only) }

Color = "RED" | "BLUE" | "GREEN" | "YELLOW" | "WILD"
CardType = "NUMBER" | "SKIP" | "REVERSE" | "DRAW_TWO" | "WILD" | "WILD_DRAW_FOUR"

A card is playable if:
  card["color"] == currentColor, OR
  card["type"]  == top_card["type"] (for non-NUMBER), OR
  card["value"] == top_card["value"] (for NUMBER), OR
  card["type"].startswith("WILD")

Point values: NUMBER=face value, SKIP/REVERSE/DRAW_TWO=20, WILD/WILD_DRAW_FOUR=50

‚îÅ‚îÅ‚îÅ GAME FLOW ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1. on_game_start() is called once
2. choose_card() is called every time it is YOUR turn
3. Return (card_index, wild_color) to play, or (None, None) to draw
4. After drawing: if drawn card not playable, pass_turn() is called automatically
5. Call UNO is handled automatically when hand size == 2
6. on_game_end(won, placement, points) is called once at the end
   - won: True if you won
   - placement: 1=first, 2=second, etc.
   - points: points scored from opponents' remaining cards

‚îÅ‚îÅ‚îÅ RULES REMINDER ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

- 60 actions/minute rate limit (bot handles this automatically)
- call_uno() fires automatically when you have 2 cards and play one
- You can only draw once per turn; then you must play or pass
- WILD/WILD_DRAW_FOUR: always return a wild_color string, never None

‚îÅ‚îÅ‚îÅ DELIVERABLE ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Produce two files ready for upload:

FILE 1 ‚Äî strategies/my_strategy/__init__.py:
(single import line)

FILE 2 ‚Äî strategies/my_strategy/strategy.py:
(full strategy class ‚Äî no external dependencies beyond stdlib + base_strategy)

The files must be zipped as:  my_strategy.zip  containing the folder my_strategy/
Upload the zip via the UnoBot UI ‚Üí Strategies ‚Üí Upload Strategy.

‚îÅ‚îÅ‚îÅ STRATEGY REQUEST ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

[DESCRIBE YOUR STRATEGY HERE ‚Äî e.g.:
  "Build an aggressive bot that prioritizes DRAW_TWO and WILD_DRAW_FOUR,
   saves WILD cards for when it has 3 or fewer cards left, and tracks
   opponents' card counts to decide when to play defensively."]</pre>

        <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:10px">
          Edit the last section then copy. The AI will return two ready-to-upload files.
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modal-guide')">Close</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê MODAL: Strategy config ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="overlay hidden" id="modal-strat-cfg">
    <div class="modal" style="width:520px">
      <div class="modal-title" id="sc-title">Configure Strategy</div>
      <div class="modal-sub" id="sc-sub">Blank fields inherit from global defaults</div>

      <div
        style="font-family:var(--mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px">
        Identity Overrides</div>
      <div class="row2">
        <div class="field"><span class="flbl">First Name</span><input type="text" id="sc-first" placeholder="‚Üê global">
        </div>
        <div class="field"><span class="flbl">Last Name</span><input type="text" id="sc-last" placeholder="‚Üê global">
        </div>
      </div>
      <div class="row2">
        <div class="field"><span class="flbl">Player Name</span><input type="text" id="sc-player"
            placeholder="‚Üê global"></div>
        <div class="field"><span class="flbl">MAC Address</span><input type="text" id="sc-mac" placeholder="‚Üê global">
        </div>
      </div>

      <hr class="modal-divider">
      <div
        style="font-family:var(--mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px">
        Behaviour Overrides</div>

      <div class="toggle-row">
        <div class="toggle-info">
          <div class="tlbl">Only Human Players</div>
          <div class="tsub">Override global ‚Äî only join rooms with real players</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <select id="sc-only" style="width:auto;min-width:110px">
            <option value="">‚Üê global</option>
            <option value="true">On</option>
            <option value="false">Off</option>
          </select>
        </div>
      </div>
      <div class="toggle-row">
        <div class="toggle-info">
          <div class="tlbl">Auto Rejoin</div>
          <div class="tsub">Override global ‚Äî rejoin automatically after each game</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <select id="sc-rejoin" style="width:auto;min-width:110px">
            <option value="">‚Üê global</option>
            <option value="true">On</option>
            <option value="false">Off</option>
          </select>
        </div>
      </div>
      <div class="toggle-row">
        <div class="toggle-info">
          <div class="tlbl">Sandbox Mode</div>
          <div class="tsub">Override global ‚Äî play against bots only</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <select id="sc-sandbox" style="width:auto;min-width:110px">
            <option value="">‚Üê global</option>
            <option value="true">On</option>
            <option value="false">Off</option>
          </select>
        </div>
      </div>
      <div class="toggle-row">
        <div class="toggle-info">
          <div class="tlbl">Debug Mode</div>
          <div class="tsub">Override global ‚Äî verbose log output</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <select id="sc-debug" style="width:auto;min-width:110px">
            <option value="">‚Üê global</option>
            <option value="true">On</option>
            <option value="false">Off</option>
          </select>
        </div>
      </div>
      <div class="field" style="margin-top:12px">
        <span class="flbl">Rejoin Delay (seconds) <span style="color:var(--muted)">(blank = global)</span></span>
        <input type="number" id="sc-delay" min="0" max="120" placeholder="‚Üê global" style="width:160px">
      </div>

      <div class="modal-footer">
        <button class="btn btn-red btn-sm" onclick="clearStratOverrides()">‚úï Clear All Overrides</button>
        <div style="flex:1"></div>
        <button class="btn btn-ghost" onclick="closeModal('modal-strat-cfg')">Cancel</button>
        <button class="btn btn-green" id="sc-save-btn" onclick="saveStratCfg()">üíæ Save</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê MODAL: Upload strategy ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="overlay hidden" id="modal-upload">
    <div class="modal">
      <div class="modal-title">Upload Strategy</div>
      <div class="modal-sub">Install a new strategy from a zip file</div>
      <p class="help-text" style="margin-bottom:16px">
        The zip must contain a single top-level folder with an <code
          style="font-family:var(--mono);background:var(--surf2);padding:1px 5px;border-radius:3px">__init__.py</code>
        that exports a class inheriting from <code
          style="font-family:var(--mono);background:var(--surf2);padding:1px 5px;border-radius:3px">BaseStrategy</code>.
      </p>
      <div class="upload-zone" id="upload-zone" onclick="document.getElementById('upload-file').click()"
        ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')"
        ondrop="handleDrop(event)">
        <div class="upload-icon">üì¶</div>
        <div class="upload-text">Click to select or drag &amp; drop</div>
        <div class="upload-sub" id="upload-filename">Accepts .zip files</div>
      </div>
      <input type="file" id="upload-file" accept=".zip" style="display:none" onchange="handleFileSelect(event)">
      <div id="upload-result"
        style="display:none;margin-top:12px;padding:10px 13px;border-radius:7px;font-family:var(--mono);font-size:12px">
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modal-upload')">Close</button>
        <button class="btn btn-blue" id="upload-btn" onclick="uploadStrategy()" disabled>üì§ Install Strategy</button>
      </div>
    </div>
  </div>

  <div class="toast-ct" id="toasts"></div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // State
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let _status = { status: 'stopped', paused: false, active_strategy: '‚Äî', pid: null, uptime_seconds: null, room_id: null, is_sandbox_mode: true };
    let _strats = [];
    let _launchMode = 'auto';
    let _targets = [];
    let _logOff = 0;        // raw log offset
    let _cfgStratId = null;   // strategy being edited in modal
    let _uploadFile = null;

    // Telemetry state
    let _telemFeedOpen = false;
    let _lastTelem = null;
    let _lastLiveSnap = null;  // latest /api/live snapshot ‚Äî shared by live and telem renderers

    // Live feed state
    let _feedItems = [];      // parsed feed items
    const MAX_FEED = 200;

    // Session counters (parsed from log lines)
    let _sess = { games: 0, wins: 0, losses: 0, cards: 0, uno: 0, pen: 0 };


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Navigation
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function navTo(id, el) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('page-' + id).classList.add('active');
      el.classList.add('active');
      if (id === 'strategies') loadStrats();
      if (id === 'stats') { populateStatsSel(); autoLoadActiveStats(); }
      if (id === 'config') loadConfig();
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Toast
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function toast(msg, type = 'ok') {
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = msg;
      document.getElementById('toasts').appendChild(el);
      setTimeout(() => el.remove(), 3500);
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // API helper
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function api(path, opts = {}) {
      const r = await fetch('/api' + path, {
        headers: { 'Content-Type': 'application/json' },
        ...opts
      });
      if (!r.ok) {
        const j = await r.json().catch(() => ({}));
        throw new Error(j.error || `HTTP ${r.status}`);
      }
      return r.json();
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Status polling
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function pollStatus() {
      try {
        _status = await api('/status');
        renderStatus();
      } catch (e) { }
    }

    function renderStatus() {
      const s = _status;
      const running = s.status === 'running';
      const paused = s.paused && running;
      const viz = paused ? 'paused' : s.status; // 'stopped' | 'running' | 'paused'

      // Header dot
      const dot = document.getElementById('hdr-dot');
      dot.className = 'dot ' + viz;

      // Header text
      const htxt = document.getElementById('hdr-status');
      htxt.textContent = paused ? 'PAUSED' : (running ? 'RUNNING' : 'OFFLINE');
      htxt.style.color = paused ? 'var(--yellow)' : (running ? 'var(--green)' : 'var(--muted)');

      // Header uptime
      document.getElementById('hdr-uptime').textContent =
        (running && s.uptime_seconds != null) ? fmtUp(s.uptime_seconds) : '';

      // Header strategy
      document.getElementById('hdr-strategy').textContent = s.active_strategy || '‚Äî';

      // Header room pill
      const roomEl = document.getElementById('hdr-room');
      if (s.room_id) {
        roomEl.textContent = 'üü¢ ' + s.room_id.substring(0, 8) + '‚Ä¶';
        roomEl.className = 'hdr-room active';
      } else {
        roomEl.textContent = 'No room';
        roomEl.className = 'hdr-room';
      }

      // Hero ring
      const ring = document.getElementById('big-ring');
      ring.className = 'hero-ring ' + viz;
      ring.textContent = paused ? '‚è∏' : (running ? 'ü§ñ' : 'üî¥');

      // Info boxes
      const hs = document.getElementById('h-status');
      hs.textContent = paused ? 'Paused' : (running ? 'Running' : 'Stopped');
      hs.className = 'info-val ' + (paused ? 'y' : (running ? 'g' : ''));
      document.getElementById('h-strategy').textContent = s.active_strategy || '‚Äî';
      document.getElementById('h-room').textContent = s.room_id ? s.room_id.substring(0, 12) + '‚Ä¶' : '‚Äî';
      document.getElementById('h-uptime').textContent =
        (running && s.uptime_seconds != null) ? fmtUp(s.uptime_seconds) : '‚Äî';

      // Control buttons
      document.getElementById('btn-stop').disabled = !running;
      // Play cards ‚Äî disable all three when bot is running
      setPlayBtnsDisabled(running);
      if (!running) { _activeMode = null; highlightPlayCard(null); }

      // Auto Grind button is always available ‚Äî sandbox is optional
      if (!running) {
        document.getElementById('btn-auto').disabled = false;
        document.getElementById('auto-sandbox-badge').style.display = 'none';
        document.getElementById('auto-sandbox-warn').style.display = 'none';
        document.getElementById('pc-auto').style.opacity = '';
      }
      const pb = document.getElementById('btn-pause');
      const rb = document.getElementById('btn-resume');
      pb.disabled = !running || paused;
      pb.style.display = (running && !paused) ? '' : 'none';
      rb.style.display = paused ? '' : 'none';

      // Pause banner
      const banner = document.getElementById('pause-banner');
      paused ? banner.classList.add('show') : banner.classList.remove('show');

      // Room card
      const roomCard = document.getElementById('room-card');
      if (s.room_id) {
        roomCard.style.display = '';
        document.getElementById('room-id-display').textContent = s.room_id;
        const watchUrl = `${UNO_BASE}/watch?roomId=${encodeURIComponent(s.room_id)}`;
        // Control page watch button
        const cwb = document.getElementById('ctrl-watch-room-btn');
        if (cwb) cwb.href = watchUrl;
        // Live page watch button
        const wb = document.getElementById('watch-room-btn');
        if (wb) { wb.href = watchUrl; wb.style.display = ''; }
      } else {
        roomCard.style.display = 'none';
        const wb = document.getElementById('watch-room-btn');
        if (wb) wb.style.display = 'none';
      }
    }

    function fmtUp(sec) {
      const h = Math.floor(sec / 3600), m = Math.floor((sec % 3600) / 60), s = sec % 60;
      return [h, m, s].map(v => String(v).padStart(2, '0')).join(':');
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Play mode cards
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let _activeMode = null;  // 'auto' | 'wait' | 'pvp'

    function highlightPlayCard(mode) {
      ['pc-auto', 'pc-wait', 'pc-pvp'].forEach(id => {
        document.getElementById(id).className = 'play-card';
      });
      if (mode === 'auto') document.getElementById('pc-auto').classList.add('running-auto');
      if (mode === 'wait') document.getElementById('pc-wait').classList.add('running-wait');
      if (mode === 'pvp') document.getElementById('pc-pvp').classList.add('running-pvp');
    }

    function setPlayBtnsDisabled(disabled) {
      ['btn-auto', 'btn-wait', 'btn-pvp'].forEach(id => {
        document.getElementById(id).disabled = disabled;
      });
    }

    async function startMode(mode) {
      // (sandbox mode is recommended for Auto Grind but not enforced here)
      const strategy = document.getElementById('launch-strat').value || null;
      try {
        const autoRejoin = (mode !== 'pvp');
        await api('/bot/start', {
          method: 'POST', body: JSON.stringify({
            mode: (mode === 'pvp' ? 'auto' : mode),
            strategy,
            target_players: [],
            auto_rejoin: autoRejoin,
          })
        });
        _activeMode = mode;
        highlightPlayCard(mode);
        setPlayBtnsDisabled(true);
        toast('‚ñ∂ ' + { auto: 'Auto Grind started', wait: 'Waiting for a room‚Ä¶', pvp: 'PvP game starting' }[mode]);
        setTimeout(pollStatus, 500);
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }

    // ‚îÄ‚îÄ‚îÄ PvP modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _pvpOpt = 'join';
    let _pvpRoomId = null;

    function openPvpModal() {
      selectPvpOpt('join');
      document.getElementById('pvp-player-name').value = '';
      document.getElementById('pvp-name-warn').style.display = 'none';
      document.getElementById('pvp-room-created').style.display = 'none';
      document.getElementById('pvp-start-btn').textContent = '‚ñ∂ Find & Join';
      document.getElementById('pvp-start-btn').disabled = false;
      document.getElementById('pvp-start-btn').onclick = startPvp;
      openModal('modal-pvp');
    }

    function selectPvpOpt(opt) {
      _pvpOpt = opt;
      document.getElementById('pvp-opt-join').classList.toggle('sel', opt === 'join');
      document.getElementById('pvp-opt-create').classList.toggle('sel', opt === 'create');
      document.getElementById('pvp-join-section').style.display = opt === 'join' ? '' : 'none';
      document.getElementById('pvp-create-section').style.display = opt === 'create' ? '' : 'none';
      document.getElementById('pvp-room-created').style.display = 'none';
      document.getElementById('pvp-start-btn').textContent = opt === 'create' ? 'üè† Create Room' : '‚ñ∂ Find & Join';
      document.getElementById('pvp-start-btn').disabled = false;
      document.getElementById('pvp-start-btn').onclick = startPvp;
    }

    async function startPvp() {
      const strategy = document.getElementById('launch-strat').value || null;

      if (_pvpOpt === 'join') {
        const name = document.getElementById('pvp-player-name').value.trim();
        if (!name) { document.getElementById('pvp-name-warn').style.display = 'block'; return; }
        closeModal('modal-pvp');
        try {
          await api('/bot/start', {
            method: 'POST', body: JSON.stringify({
              mode: 'target', strategy, target_players: [name], auto_rejoin: false
            })
          });
          _activeMode = 'pvp';
          highlightPlayCard('pvp');
          setPlayBtnsDisabled(true);
          toast('üéØ Searching for ' + name + `'s room‚Ä¶`, 'info');
          setTimeout(pollStatus, 500);
        } catch (e) { toast('‚ùå ' + e.message, 'err'); }

      } else {
        const btn = document.getElementById('pvp-start-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Creating‚Ä¶';
        try {
          const r = await api('/room/create', { method: 'POST', body: JSON.stringify({ strategy }) });
          if (!r.ok) throw new Error(r.error);
          _pvpRoomId = r.room_id;
          document.getElementById('pvp-room-id-display').textContent = r.room_id;
          document.getElementById('pvp-room-created').style.display = 'block';
          btn.textContent = '‚úÖ Done ‚Äî Close';
          btn.disabled = false;
          btn.onclick = () => {
            closeModal('modal-pvp');
            _activeMode = 'pvp';
            highlightPlayCard('pvp');
            setPlayBtnsDisabled(true);
            // Enable stop button immediately ‚Äî bot is now running
            document.getElementById('btn-stop').disabled = false;
            toast('üè† Room ready ‚Äî share the ID with friends!', 'info');
            setTimeout(pollStatus, 500);
          };
          // Enable stop button now ‚Äî bot started
          _activeMode = 'pvp';
          document.getElementById('btn-stop').disabled = false;
          setPlayBtnsDisabled(true);
          toast('üè† Room created! Share the ID with friends.', 'info');
        } catch (e) {
          toast('‚ùå ' + e.message, 'err');
          btn.disabled = false;
          btn.textContent = 'üè† Create Room';
        }
      }
    }

    function copyRoomId() {
      const id = document.getElementById('pvp-room-id-display').textContent;
      navigator.clipboard.writeText(id).then(() => toast('üìã Room ID copied!')).catch(() => {
        const el = document.createElement('textarea');
        el.value = id; document.body.appendChild(el); el.select();
        document.execCommand('copy'); document.body.removeChild(el);
        toast('üìã Copied!');
      });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Bot control (stop / pause / resume)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function confirmStop() { openModal('modal-stop'); }

    async function stopBot(leaveRoom) {
      closeModal('modal-stop');
      try {
        if (leaveRoom && _status.room_id) {
          // /room/leave also stops the bot ‚Äî no need to also call /bot/stop
          await api('/room/leave', { method: 'POST' });
          toast('üö™ Stopped and left room');
        } else {
          await api('/bot/stop', { method: 'POST' });
          toast('‚èπ Bot stopped');
        }
        _activeMode = null;
        highlightPlayCard(null);
        setPlayBtnsDisabled(false);
        document.getElementById('btn-stop').disabled = true;
        setTimeout(pollStatus, 500);
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }

    async function pauseBot() {
      try {
        await api('/bot/pause', { method: 'POST' });
        toast('‚è∏ Will pause after this game', 'warn');
        setTimeout(pollStatus, 400);
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }

    async function resumeBot() {
      try {
        await api('/bot/resume', { method: 'POST' });
        toast('‚ñ∂ Bot resumed');
        setTimeout(pollStatus, 400);
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Room leave / rejoin
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const UNO_BASE = 'https://uno-839271117832.europe-west1.run.app';

    function watchRoom() {
      const roomId = _status?.room_id;
      if (roomId) {
        window.open(`${UNO_BASE}/watch?roomId=${encodeURIComponent(roomId)}`, '_blank');
      } else {
        window.open(`${UNO_BASE}/watch`, '_blank');
      }
    }

    function toggleTelemFeed() {
      _telemFeedOpen = !_telemFeedOpen;
      const wrap = document.getElementById('telem-feed-wrap');
      if (wrap) wrap.style.display = _telemFeedOpen ? '' : 'none';
    }

    async function leaveRoom() {
      try {
        await api('/room/leave', { method: 'POST' });
        // Leave also stops the bot ‚Äî update UI immediately
        _activeMode = null;
        highlightPlayCard(null);
        setPlayBtnsDisabled(false);
        document.getElementById('btn-stop').disabled = true;
        document.getElementById('room-card').style.display = 'none';
        toast('üö™ Left room');
        setTimeout(pollStatus, 500);
        // Show the "what next?" modal
        document.getElementById('join-player-input').style.display = 'none';
        document.getElementById('join-player-warn').style.display = 'none';
        document.getElementById('join-player-name').value = '';
        openModal('modal-left-room');
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }

    function showJoinPlayer() {
      const inp = document.getElementById('join-player-input');
      inp.style.display = inp.style.display === 'none' ? 'block' : 'none';
      if (inp.style.display === 'block') {
        setTimeout(() => document.getElementById('join-player-name').focus(), 50);
      }
    }

    async function rejoinAfterLeave(mode) {
      if (mode === 'target') {
        const name = document.getElementById('join-player-name').value.trim();
        if (!name) {
          document.getElementById('join-player-warn').style.display = 'block';
          return;
        }
        closeModal('modal-left-room');
        try {
          await api('/room/join', { method: 'POST', body: JSON.stringify({ mode: 'target', target_players: [name] }) });
          toast("‚úÖ Joined player's room");
          setTimeout(pollStatus, 600);
        } catch (e) { toast('‚ùå ' + e.message, 'err'); }
      } else {
        closeModal('modal-left-room');
        try {
          await api('/room/join', { method: 'POST', body: JSON.stringify({ mode: 'auto' }) });
          toast('‚úÖ Joined a room');
          setTimeout(pollStatus, 600);
        } catch (e) { toast('‚ùå ' + e.message, 'err'); }
      }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Strategies
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadStrats() {
      document.getElementById('strat-grid').innerHTML =
        `<div class="empty"><div class="ei">‚è≥</div><div>Loading‚Ä¶</div></div>`;
      try {
        _strats = await api('/strategies');
        renderStrats();
        populateLaunchSel();
        populateStatsSel();
      } catch (e) {
        document.getElementById('strat-grid').innerHTML =
          `<div class="empty"><div class="ei">‚ö†Ô∏è</div><div>Failed to load strategies</div></div>`;
      }
    }

    function fmtId(id) {
      return id.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function renderStrats() {
      const g = document.getElementById('strat-grid');
      if (!_strats.length) {
        g.innerHTML = `<div class="empty" style="grid-column:1/-1"><div class="ei">üß†</div><div>No strategies found</div></div>`;
        return;
      }
      g.innerHTML = _strats.map(s => {
        const st = s.stats;
        const wr = st.win_rate.toFixed(1);
        const cfg = s.config || {};

        // Build override badges
        const overrideBadges = [];
        if (cfg.bot_first_name || cfg.bot_last_name)
          overrideBadges.push(`üè∑ ${(cfg.bot_first_name || '') + ' ' + (cfg.bot_last_name || '')}`);
        if (cfg.only_players_mode !== undefined) overrideBadges.push(`üë§ ${cfg.only_players_mode ? 'Only Players' : 'Any Room'}`);
        if (cfg.auto_rejoin !== undefined) overrideBadges.push(`üîÑ ${cfg.auto_rejoin ? 'Auto Rejoin' : 'No Rejoin'}`);
        if (cfg.is_sandbox_mode !== undefined) overrideBadges.push(`üèñ ${cfg.is_sandbox_mode ? 'Sandbox' : 'Live'}`);
        if (cfg.debug_mode !== undefined) overrideBadges.push(`üêõ Debug ${cfg.debug_mode ? 'On' : 'Off'}`);
        if (cfg.rejoin_delay !== undefined) overrideBadges.push(`‚è± ${cfg.rejoin_delay}s delay`);
        const overridesHtml = overrideBadges.length
          ? overrideBadges.map(b => `<span style="display:inline-flex;align-items:center;padding:2px 7px;background:rgba(59,130,246,.1);color:var(--blue);border:1px solid rgba(59,130,246,.2);border-radius:4px;font-family:var(--mono);font-size:9px;margin:2px">${b}</span>`).join('')
          : `<span style="font-family:var(--mono);font-size:10px;color:var(--muted)">No overrides ‚Äî using global settings</span>`;

        return `<div class="sc ${s.active ? 'active-strat' : ''}" id="sc-${s.id}">
      <div class="sc-header">
        <div>
          <div class="sc-name">${fmtId(s.id)}</div>
          <div class="sc-cls">${s.name}</div>
        </div>
        ${s.active ? '<div class="active-badge">‚óè DEFAULT</div>' : ''}
      </div>
      <div id="sc-ident-${s.id}" style="font-size:12px;margin-bottom:10px;line-height:1.6">${overridesHtml}</div>
      <div class="sc-stats">
        <div class="sc-stat"><div class="sc-stat-lbl">Win %</div><div class="sc-stat-val ${st.win_rate >= 50 ? 'g' : 'r'}">${wr}</div></div>
        <div class="sc-stat"><div class="sc-stat-lbl">Games</div><div class="sc-stat-val">${st.games_played}</div></div>
        <div class="sc-stat"><div class="sc-stat-lbl">Wins</div><div class="sc-stat-val g">${st.wins}</div></div>
      </div>
      <div class="sc-actions">
        ${s.active
            ? `<button class="btn btn-ghost btn-xs" disabled style="opacity:.4">‚òÖ Default</button>`
            : `<button class="btn btn-green btn-xs" onclick="setActive('${s.id}')">‚òÖ Set Default</button>`}
        <button class="btn btn-ghost btn-xs" onclick="openStratCfg('${s.id}')">‚öô Overrides</button>
        <button class="btn btn-ghost btn-xs" onclick="viewStratStats('${s.id}')">üìä Stats</button>
        <button class="btn btn-red btn-xs"   onclick="resetStats('${s.id}')">üóë</button>
      </div>
    </div>`;
      }).join('');
    }

    async function setActive(id) {
      try {
        await api(`/strategies/${id}/activate`, { method: 'POST' });
        toast(`‚úÖ Active strategy ‚Üí ${fmtId(id)}`);
        await loadStrats();
        await pollStatus();
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }

    async function resetStats(id) {
      if (!confirm(`Reset all stats for "${fmtId(id)}"?`)) return;
      try {
        await api(`/strategies/${id}/stats/reset`, { method: 'POST' });
        toast('üóë Stats reset');
        loadStrats();
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }

    function viewStratStats(id) {
      const navEl = [...document.querySelectorAll('.nav-item')].find(el => el.dataset.page === 'stats');
      navTo('stats', navEl);
      document.getElementById('stats-sel').value = id;
      loadStats(id);
    }

    function populateLaunchSel() {
      const sel = document.getElementById('launch-strat');
      const cur = sel.value;
      sel.innerHTML = `<option value="">‚Äî Use active strategy ‚Äî</option>` +
        _strats.map(s => `<option value="${s.id}">${fmtId(s.id)}</option>`).join('');
      if (cur) sel.value = cur;
    }

    function populateStatsSel() {
      const sel = document.getElementById('stats-sel');
      const cur = sel.value;
      if (!_strats.length) return;
      sel.innerHTML = `<option value="">Select strategy‚Ä¶</option>` +
        _strats.map(s => `<option value="${s.id}">${fmtId(s.id)}</option>`).join('');
      if (cur) sel.value = cur;
    }

    async function autoLoadActiveStats() {
      // Ensure both strats and status are fresh
      if (!_strats.length) await loadStrats();
      try { _status = await api('/status'); } catch (_) { }
      populateStatsSel();
      const sel = document.getElementById('stats-sel');
      // Pick: current selection ‚Üí active strategy ‚Üí first strategy in list
      const target = sel.value
        || (_status.active_strategy && _status.active_strategy !== '‚Äî' ? _status.active_strategy : null)
        || (_strats.length ? _strats[0].id : null);
      if (target) {
        sel.value = target;
        if (sel.value) loadStats(sel.value);
      }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Strategy config modal
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function _boolVal(val) {
      if (val === true || val === "true") return "true";
      if (val === false || val === "false") return "false";
      return "";
    }

    async function openStratCfg(id) {
      _cfgStratId = id;
      const s = _strats.find(x => x.id === id);
      document.getElementById('sc-title').textContent = `‚öô Overrides ‚Äî ${fmtId(id)}`;
      document.getElementById('sc-sub').textContent = s ? s.name + ' ¬∑ blank fields use global default' : id;
      document.getElementById('sc-save-btn').disabled = false;

      // Clear all fields first
      ['sc-first', 'sc-last', 'sc-player', 'sc-mac'].forEach(i => document.getElementById(i).value = '');
      ['sc-only', 'sc-rejoin', 'sc-sandbox', 'sc-debug'].forEach(i => document.getElementById(i).value = '');
      document.getElementById('sc-delay').value = '';

      try {
        const c = await api(`/strategies/${id}/config`);
        document.getElementById('sc-first').value = c.bot_first_name || '';
        document.getElementById('sc-last').value = c.bot_last_name || '';
        document.getElementById('sc-player').value = c.player_name || '';
        document.getElementById('sc-mac').value = c.mac_address || '';
        document.getElementById('sc-only').value = _boolVal(c.only_players_mode);
        document.getElementById('sc-rejoin').value = _boolVal(c.auto_rejoin);
        document.getElementById('sc-sandbox').value = _boolVal(c.is_sandbox_mode);
        document.getElementById('sc-debug').value = _boolVal(c.debug_mode);
        if (c.rejoin_delay !== undefined) document.getElementById('sc-delay').value = c.rejoin_delay;
      } catch (e) { }

      openModal('modal-strat-cfg');
    }

    async function saveStratCfg() {
      if (!_cfgStratId) return;
      const btn = document.getElementById('sc-save-btn');
      btn.disabled = true;

      // Booleans: "" means "remove override", "true"/"false" means set it
      function parseBool(val) {
        if (val === "true") return true;
        if (val === "false") return false;
        return "";  // empty string ‚Üí server will remove the key
      }

      const data = {
        bot_first_name: document.getElementById('sc-first').value.trim(),
        bot_last_name: document.getElementById('sc-last').value.trim(),
        player_name: document.getElementById('sc-player').value.trim(),
        mac_address: document.getElementById('sc-mac').value.trim(),
        only_players_mode: parseBool(document.getElementById('sc-only').value),
        auto_rejoin: parseBool(document.getElementById('sc-rejoin').value),
        is_sandbox_mode: parseBool(document.getElementById('sc-sandbox').value),
        debug_mode: parseBool(document.getElementById('sc-debug').value),
        rejoin_delay: document.getElementById('sc-delay').value !== ''
          ? parseInt(document.getElementById('sc-delay').value)
          : "",
      };

      try {
        await api(`/strategies/${_cfgStratId}/config`, { method: 'PATCH', body: JSON.stringify(data) });
        toast(`‚úÖ Overrides saved ‚Äî ${fmtId(_cfgStratId)}`);
        await loadStrats();
        closeModal('modal-strat-cfg');
      } catch (e) {
        toast('‚ùå ' + e.message, 'err');
      } finally {
        btn.disabled = false;
      }
    }

    async function clearStratOverrides() {
      if (!_cfgStratId) return;
      if (!confirm(`Clear ALL overrides for "${fmtId(_cfgStratId)}"? It will use global defaults for everything.`)) return;
      try {
        // Send all fields as empty to strip them
        const empty = {
          bot_first_name: "", bot_last_name: "", player_name: "", mac_address: "",
          only_players_mode: "", auto_rejoin: "", is_sandbox_mode: "", debug_mode: "",
          rejoin_delay: ""
        };
        await api(`/strategies/${_cfgStratId}/config`, { method: 'PATCH', body: JSON.stringify(empty) });
        toast(`‚úÖ All overrides cleared ‚Äî ${fmtId(_cfgStratId)}`);
        await loadStrats();
        closeModal('modal-strat-cfg');
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Statistics
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadStats(id) {
      const el = document.getElementById('stats-content');
      if (!id) { el.innerHTML = `<div class="empty"><div class="ei">üìä</div><div>Select a strategy</div></div>`; return; }
      try {
        const s = await api(`/strategies/${id}/stats`);
        el.innerHTML = renderStats(id, s);
      } catch (e) { el.innerHTML = `<div class="empty"><div>Could not load stats</div></div>`; }
    }

    // ‚îÄ‚îÄ SVG chart helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function svgDonut(slices, r = 52, stroke = 18, size = 140) {
      // slices: [{value, color, label}]
      const total = slices.reduce((a, b) => a + b.value, 0) || 1;
      const cx = size / 2, cy = size / 2;
      const circ = 2 * Math.PI * r;
      let offset = -Math.PI / 2; // start at 12 o'clock
      const paths = slices.map(({ value, color }) => {
        const frac = value / total;
        const angle = frac * 2 * Math.PI;
        const x1 = cx + r * Math.cos(offset);
        const y1 = cy + r * Math.sin(offset);
        offset += angle;
        const x2 = cx + r * Math.cos(offset);
        const y2 = cy + r * Math.sin(offset);
        const large = angle > Math.PI ? 1 : 0;
        if (frac < 0.001) return '';
        return `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} Z"
      fill="${color}" opacity="0.85"/>`;
      }).join('');
      return `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
    <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="var(--surf2)" stroke-width="${stroke}"/>
    ${paths}
    <circle cx="${cx}" cy="${cy}" r="${r - stroke / 2 - 2}" fill="var(--surf)"/>
  </svg>`;
    }

    function svgBars(items, maxH = 80, w = 220) {
      // items: [{label, value, color}]
      if (!items.length) return '';
      const max = Math.max(1, ...items.map(i => i.value));
      const bw = Math.floor((w - (items.length - 1) * 6) / items.length);
      const bars = items.map((item, i) => {
        const bh = Math.max(2, Math.round((item.value / max) * maxH));
        const x = i * (bw + 6);
        const y = maxH - bh;
        return `<g>
      <rect x="${x}" y="${y}" width="${bw}" height="${bh}" rx="3" fill="${item.color}" opacity="0.85"/>
      <text x="${x + bw / 2}" y="${maxH + 14}" text-anchor="middle"
        font-family="monospace" font-size="8" fill="var(--muted)">${item.label}</text>
      <text x="${x + bw / 2}" y="${y - 3}" text-anchor="middle"
        font-family="monospace" font-size="9" fill="var(--fg)">${item.value}</text>
    </g>`;
      }).join('');
      return `<svg width="${w}" height="${maxH + 24}" viewBox="0 0 ${w} ${maxH + 24}">${bars}</svg>`;
    }

    function svgWinLoss(wins, losses) {
      const total = Math.max(1, wins + losses);
      const wp = (wins / total) * 100;
      const lp = (losses / total) * 100;
      return `<div style="margin-top:4px">
    <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;margin-bottom:5px">
      <span style="color:var(--green)">Wins ${wins}</span>
      <span style="color:var(--muted)">${wp.toFixed(0)}% win rate</span>
      <span style="color:var(--red)">Losses ${losses}</span>
    </div>
    <div style="display:flex;height:10px;border-radius:5px;overflow:hidden;gap:2px">
      <div style="flex:${wins};background:var(--green);opacity:.8;border-radius:5px 0 0 5px;min-width:${wins ? 2 : 0}px"></div>
      <div style="flex:${losses};background:var(--red);opacity:.8;border-radius:0 5px 5px 0;min-width:${losses ? 2 : 0}px"></div>
    </div>
  </div>`;
    }

    function renderStats(id, s) {
      const placementSlices = [
        { value: s.placements['1'] || 0, color: '#F0B429', label: '1st' },
        { value: s.placements['2'] || 0, color: '#3B82F6', label: '2nd' },
        { value: s.placements['3'] || 0, color: '#F97316', label: '3rd' },
        { value: s.placements['4+'] || 0, color: '#64748b', label: '4th+' },
      ];
      const pTotal = Math.max(1, placementSlices.reduce((a, b) => a + b.value, 0));

      const placementBars = placementSlices.map(({ value, color, label }) => {
        const pct = ((value / pTotal) * 100).toFixed(0);
        return `<div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:11px;margin-bottom:4px">
        <span>${label === '1st' ? 'ü•á' : label === '2nd' ? 'ü•à' : label === '3rd' ? 'ü•â' : '4th+'} ${label}</span>
        <span style="color:var(--muted)">${value} <span style="opacity:.6">(${pct}%)</span></span>
      </div>
      <div style="background:var(--border);border-radius:3px;height:7px;overflow:hidden">
        <div style="width:${pct}%;height:100%;background:${color};border-radius:3px;transition:width .6s;opacity:.85"></div>
      </div></div>`;
      }).join('');

      const cHex = { RED: '#E63946', BLUE: '#3B82F6', GREEN: '#22C55E', YELLOW: '#F0B429' };
      const cTotal = Math.max(1, Object.values(s.wild_color_choices || {}).reduce((a, b) => a + b, 0));
      const wildSlices = Object.entries(s.wild_color_choices || {}).map(([col, cnt]) =>
        ({ value: cnt, color: cHex[col] || '#64748b', label: col.substring(0, 1) }));
      const wildBars = Object.entries(s.wild_color_choices || {}).map(([col, cnt]) => {
        const pct = ((cnt / cTotal) * 100).toFixed(0);
        return `<div style="margin-bottom:7px">
      <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;margin-bottom:3px">
        <span style="color:${cHex[col] || 'var(--muted)'}">${col}</span>
        <span style="color:var(--muted)">${cnt} (${pct}%)</span>
      </div>
      <div style="background:var(--border);border-radius:3px;height:5px;overflow:hidden">
        <div style="width:${pct}%;height:100%;background:${cHex[col] || '#64748b'};border-radius:3px;transition:width .6s;opacity:.85"></div>
      </div></div>`;
      }).join('');

      const cardTypeEntries = Object.entries(s.card_type_counts || {}).sort((a, b) => b[1] - a[1]).slice(0, 6);
      const ctColors = { NUMBER: '#3B82F6', SKIP: '#F97316', REVERSE: '#A855F7', DRAW_TWO: '#E63946', WILD: '#F0B429', WILD_DRAW_FOUR: '#EF4444' };
      const cardBarsItems = cardTypeEntries.map(([t, v]) => ({ label: t.replace('_', ' ').replace('WILD DRAW', 'WD4').substring(0, 5), value: v, color: ctColors[t] || '#64748b' }));

      const hasCardData = cardTypeEntries.length > 0;
      const hasWildData = wildSlices.some(s => s.value > 0);

      return `
    <div class="card">
      <div class="card-title">${fmtId(id)}
        <button class="btn btn-red btn-xs" onclick="resetStats('${id}')">üóë Reset</button>
      </div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-lbl">Games</div><div class="stat-val">${s.games_played}</div></div>
        <div class="stat-box"><div class="stat-lbl">Win Rate</div><div class="stat-val ${s.win_rate >= 50 ? 'g' : 'r'}">${s.win_rate.toFixed(1)}%</div></div>
        <div class="stat-box"><div class="stat-lbl">Wins</div><div class="stat-val g">${s.wins}</div></div>
        <div class="stat-box"><div class="stat-lbl">Losses</div><div class="stat-val r">${s.losses}</div></div>
        <div class="stat-box"><div class="stat-lbl">Avg Points</div><div class="stat-val y">${s.avg_points_per_game.toFixed(1)}</div></div>
        <div class="stat-box"><div class="stat-lbl">Best Game</div><div class="stat-val">${s.best_game_points}</div></div>
        <div class="stat-box"><div class="stat-lbl">Cards Played</div><div class="stat-val b">${s.total_cards_played}</div></div>
        <div class="stat-box"><div class="stat-lbl">Cards Drawn</div><div class="stat-val">${s.total_cards_drawn}</div></div>
      </div>
      ${svgWinLoss(s.wins, s.losses)}
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <!-- Placement chart -->
      <div class="card">
        <div class="card-title">Placements</div>
        <div style="display:flex;align-items:center;gap:16px">
          <div style="flex-shrink:0">${svgDonut(placementSlices)}</div>
          <div style="flex:1">${placementBars}</div>
        </div>
      </div>

      <!-- Wild color chart -->
      <div class="card">
        <div class="card-title">Wild Color Choices</div>
        ${hasWildData
          ? `<div style="display:flex;align-items:center;gap:16px">
               <div style="flex-shrink:0">${svgDonut(wildSlices)}</div>
               <div style="flex:1">${wildBars}</div>
             </div>`
          : `<div style="color:var(--muted);font-size:12px;margin-top:8px">No wild card data yet</div>`}
      </div>
    </div>

    <!-- Card type bar chart -->
    <div class="card">
      <div class="card-title">Card Types Played</div>
      ${hasCardData
          ? `<div style="overflow-x:auto;padding:4px 0">
             ${svgBars(cardBarsItems, 90, Math.max(220, cardBarsItems.length * 38))}
           </div>
           <div style="margin-top:10px">
             ${cardTypeEntries.map(([t, v]) =>
            `<div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:11px;padding:4px 0;border-bottom:1px solid var(--border)">
                 <span style="color:${ctColors[t] || 'var(--muted)'}">‚óè ${t}</span>
                 <span>${v}</span>
               </div>`
          ).join('')}
           </div>`
          : `<div style="color:var(--muted);font-size:12px;margin-top:8px">No card type data yet</div>`}
    </div>

    <div class="card" style="padding:14px 18px">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px">
        ${[['Cards Played', s.total_cards_played, 'b'], ['Cards Drawn', s.total_cards_drawn, ''],
        ['UNO Calls', s.total_uno_calls, 'y'], ['Penalties', s.total_penalties, 'r']].map(([l, v, cls]) =>
          `<div style="text-align:center">
            <div style="font-family:var(--mono);font-size:22px;font-weight:700" class="${cls}">${v}</div>
            <div style="font-family:var(--mono);font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-top:2px">${l}</div>
          </div>`
        ).join('')}
      </div>
    </div>

    ${s.last_updated ? `<div style="font-family:var(--mono);font-size:9px;color:var(--muted);text-align:right;margin-top:-8px">Updated: ${s.last_updated.substring(0, 19)}</div>` : ''}
    ${renderGameHistoryCharts(s)}`;
      // Draw charts after DOM insertion (deferred so canvas exists)
      setTimeout(() => drawHistoryCharts(s), 50);
      return html;
    }

    function renderGameHistoryCharts(s) {
      const h = s.games_history || [];
      if (!h.length) return '';
      return `
    <div class="card trend-card">
      <div class="card-title">Game History <span style="font-family:var(--mono);font-size:10px;font-weight:400;color:var(--muted)">last ${h.length} games</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">Win / Loss Streak</div>
          <div class="sparkline-wrap"><canvas class="sparkline-canvas" id="chart-wl"></canvas></div>
        </div>
        <div>
          <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">Points per Game</div>
          <div class="sparkline-wrap"><canvas class="sparkline-canvas" id="chart-pts"></canvas></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:14px">
        <div>
          <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">Placement Distribution</div>
          <div class="sparkline-wrap"><canvas class="sparkline-canvas" id="chart-place" style="height:80px"></canvas></div>
        </div>
        <div>
          <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">Cards Played per Game</div>
          <div class="sparkline-wrap"><canvas class="sparkline-canvas" id="chart-cards"></canvas></div>
        </div>
      </div>
    </div>`;
    }

    function drawHistoryCharts(s) {
      const h = s.games_history || [];
      if (!h.length) return;

      const style = getComputedStyle(document.documentElement);
      const green = '#22c55e';
      const red = '#e63946';
      const blue = '#3b82f6';
      const yellow = '#f0b429';
      const muted = style.getPropertyValue('--muted').trim() || '#94a3b8';
      const border = style.getPropertyValue('--border').trim() || '#2a3343';

      function drawBarChart(canvasId, values, colorFn, maxOverride) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.offsetWidth; const H = canvas.offsetHeight;
        canvas.width = W; canvas.height = H;
        ctx.clearRect(0, 0, W, H);
        if (!values.length) return;
        const max = maxOverride || Math.max(...values, 1);
        const barW = Math.max(2, Math.floor((W - values.length) / values.length));
        const gap = Math.floor((W - barW * values.length) / Math.max(values.length - 1, 1));
        values.forEach((v, i) => {
          const x = i * (barW + gap);
          const h = Math.round((v / max) * (H - 4));
          ctx.fillStyle = border;
          ctx.fillRect(x, 0, barW, H);
          ctx.fillStyle = colorFn(v, i);
          ctx.fillRect(x, H - h, barW, h);
        });
      }

      function drawLineChart(canvasId, values, color) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.offsetWidth; const H = canvas.offsetHeight;
        canvas.width = W; canvas.height = H;
        ctx.clearRect(0, 0, W, H);
        if (values.length < 2) return;
        const max = Math.max(...values, 1);
        const step = W / (values.length - 1);
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.lineJoin = 'round';
        ctx.beginPath();
        values.forEach((v, i) => {
          const x = i * step;
          const y = H - 4 - Math.round((v / max) * (H - 8));
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.stroke();
        // Fill under
        ctx.lineTo((values.length - 1) * step, H);
        ctx.lineTo(0, H);
        ctx.closePath();
        ctx.fillStyle = color + '22';
        ctx.fill();
      }

      // Win/Loss bars
      drawBarChart('chart-wl', h.map(g => 1), (_, i) => h[i].won ? green : red, 1);

      // Points line
      drawLineChart('chart-pts', h.map(g => g.points), blue);

      // Placement bars (1=best)
      drawBarChart('chart-place', h.map(g => Math.max(0, 5 - g.placement)), (v) => {
        if (v >= 4) return yellow;
        if (v === 3) return blue;
        if (v === 2) return muted;
        return red;
      }, 4);

      // Cards played line
      drawLineChart('chart-cards', h.map(g => g.cards_played), yellow);
    }

    function _renderStatsOld(id, s) {
      return '';
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Config page
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadConfig() {
      try {
        const c = await api('/config');
        document.getElementById('g-first').value = c.bot_first_name || '';
        document.getElementById('g-last').value = c.bot_last_name || '';
        document.getElementById('g-player').value = c.player_name || '';
        document.getElementById('g-sandbox').checked = !!c.is_sandbox_mode;
        document.getElementById('g-rejoin').checked = c.auto_rejoin !== false;
        document.getElementById('g-only').checked = !!c.only_players_mode;
        document.getElementById('g-debug').checked = !!c.debug_mode;
        document.getElementById('g-delay').value = c.rejoin_delay ?? 3;
        document.getElementById('g-check').value = c.room_check_interval ?? 5;

        // Populate active strategy selector
        const sel = document.getElementById('g-active-strat');
        sel.innerHTML = _strats.length
          ? _strats.map(s => `<option value="${s.id}" ${s.id === c.active_strategy ? 'selected' : ''}>
          ${fmtId(s.id)} ${s.id === c.active_strategy ? '‚òÖ' : ''}</option>`).join('')
          : `<option value="${c.active_strategy || ''}">${c.active_strategy || '‚Äî'}</option>`;
      } catch (e) { toast('Could not load config', 'err'); }
    }

    async function saveActiveStrategy() {
      const val = document.getElementById('g-active-strat').value;
      if (!val) return;
      try {
        await api('/strategies/' + val + '/activate', { method: 'POST' });
        toast(`‚òÖ Default strategy ‚Üí ${fmtId(val)}`);
        await loadStrats();
        // Update ‚òÖ indicators in select
        const sel = document.getElementById('g-active-strat');
        [...sel.options].forEach(o => {
          o.text = o.text.replace(' ‚òÖ', '') + (o.value === val ? ' ‚òÖ' : '');
        });
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }

    // Auto-save identity fields (called onblur)
    async function saveIdentityField() {
      try {
        await api('/config', {
          method: 'PATCH', body: JSON.stringify({
            bot_first_name: document.getElementById('g-first').value.trim(),
            bot_last_name: document.getElementById('g-last').value.trim(),
            player_name: document.getElementById('g-player').value.trim(),
          })
        });
        toast('‚úÖ Saved', 'ok');
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }
    // Keep old name as alias so nothing breaks
    const saveIdentity = saveIdentityField;

    // Auto-save behaviour fields (called onchange / onblur)
    async function saveBehaviourField() {
      try {
        await api('/config', {
          method: 'PATCH', body: JSON.stringify({
            is_sandbox_mode: document.getElementById('g-sandbox').checked,
            auto_rejoin: document.getElementById('g-rejoin').checked,
            only_players_mode: document.getElementById('g-only').checked,
            debug_mode: document.getElementById('g-debug').checked,
            rejoin_delay: parseInt(document.getElementById('g-delay').value) || 3,
            room_check_interval: parseInt(document.getElementById('g-check').value) || 5,
          })
        });
        toast('‚úÖ Saved', 'ok');
      } catch (e) { toast('‚ùå ' + e.message, 'err'); }
    }
    const saveBehaviour = saveBehaviourField;


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Upload strategy
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function openUploadModal() {
      _uploadFile = null;
      document.getElementById('upload-filename').textContent = 'Accepts .zip files';
      document.getElementById('upload-btn').disabled = true;
      const res = document.getElementById('upload-result');
      res.style.display = 'none'; res.textContent = '';
      openModal('modal-upload');
    }

    function handleFileSelect(e) {
      const f = e.target.files[0];
      if (f) { _uploadFile = f; document.getElementById('upload-filename').textContent = f.name; document.getElementById('upload-btn').disabled = false; }
    }

    function handleDrop(e) {
      e.preventDefault();
      document.getElementById('upload-zone').classList.remove('drag');
      const f = e.dataTransfer.files[0];
      if (f && f.name.endsWith('.zip')) {
        _uploadFile = f;
        document.getElementById('upload-filename').textContent = f.name;
        document.getElementById('upload-btn').disabled = false;
      } else { toast('Only .zip files are accepted', 'err'); }
    }

    async function uploadStrategy() {
      if (!_uploadFile) return;
      const btn = document.getElementById('upload-btn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Installing‚Ä¶';
      const res = document.getElementById('upload-result');
      const fd = new FormData();
      fd.append('file', _uploadFile);
      try {
        const r = await fetch('/api/strategies/upload', { method: 'POST', body: fd });
        const j = await r.json();
        if (j.ok) {
          res.style.cssText = 'display:block;background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);color:var(--green)';
          res.textContent = `‚úÖ Installed: ${j.strategy}  (${j.class})`;
          toast(`‚úÖ Strategy "${j.strategy}" installed!`);
          loadStrats();
        } else {
          res.style.cssText = 'display:block;background:rgba(230,57,70,.08);border:1px solid rgba(230,57,70,.2);color:var(--red)';
          res.textContent = `‚ùå ${j.error}`;
        }
      } catch (e) {
        res.style.cssText = 'display:block;background:rgba(230,57,70,.08);border:1px solid rgba(230,57,70,.2);color:var(--red)';
        res.textContent = `‚ùå Upload failed: ${e.message}`;
      } finally {
        btn.disabled = false; btn.textContent = 'üì§ Install Strategy';
      }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Live feed ‚Äî parse log lines into rich feed items
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function parseLine(line) {
      const ts = (line.match(/^\[(\d{2}:\d{2}:\d{2})\]/) || [])[1] || '';
      const body = line.replace(/^\[\d{2}:\d{2}:\d{2}\]\s*/, '');

      if (/üéÆ MY TURN/.test(body)) {
        const hand = (body.match(/Hand:\s*(\d+)/) || [])[1];
        const top = (body.match(/Top:\s*([^‚îÇ]+)/) || [])[1]?.trim();
        return { type: 'mine', icon: 'üéÆ', main: `My turn ‚Äî <strong>${hand} cards</strong> in hand, top: <strong>${top || '?'}</strong>`, ts };
      }
      if (/‚úÖ Played/.test(body)) {
        return { type: 'mine', icon: '‚úÖ', main: `Played <strong>${body.replace('‚úÖ Played ', '').trim()}</strong>`, ts };
      }
      if (/ü§ñ Played/.test(body)) {
        return { type: 'mine', icon: '‚úÖ', main: `Played <strong>${body.replace(/^.*ü§ñ Played:\s*/, '').trim()}</strong>`, ts };
      }
      // "üÉè Drew N card(s)" ‚Äî mine. Must check before opponent draw ("üÉè X drew")
      if (/üÉè Drew/.test(body) && !/drew/.test(body)) {
        return { type: 'mine', icon: 'üÉè', main: `<strong>${body.replace(/^.*üÉè\s*/, '').trim()}</strong>`, ts };
      }
      if (/üì£ Called UNO!/.test(body)) {
        return { type: 'mine', icon: 'üì£', main: `<strong>Called UNO!</strong>`, ts };
      }
      if (/‚ö†Ô∏è.*PENALTY/.test(body)) {
        const desc = body.replace(/^.*PENALTY.*‚îÇ\s*/, '').trim();
        return { type: 'penalty', icon: '‚ö†Ô∏è', main: `Penalty: <strong>${desc || 'rule violation'}</strong>`, ts };
      }
      if (/‚è≥.*'s turn/.test(body)) {
        const name = (body.match(/‚è≥\s+([^']+)'s turn/) || [])[1];
        const cards = (body.match(/(\d+) cards in hand/) || [])[1];
        return { type: 'opponent', icon: '‚è≥', main: `<strong>${name || 'Opponent'}'s</strong> turn ‚Äî ${cards || '?'} cards`, ts };
      }
      if (/üé¥.*played/.test(body)) return { type: 'opponent', icon: 'üé¥', main: body.replace(/^.*üé¥\s*/, ''), ts };
      if (/üÉè.*drew/.test(body)) return { type: 'opponent', icon: 'üÉè', main: body.replace(/^.*üÉè\s*/, ''), ts };
      if (/üì£.*called UNO/.test(body)) return { type: 'opponent', icon: 'üì£', main: `<strong>${body.replace(/^.*üì£\s*/, '')}</strong>`, ts };
      if (/üèÜ WE WON/.test(body)) {
        const score = (body.match(/Score:\s*(\d+)/) || [])[1];
        return { type: 'win', icon: 'üèÜ', main: `<strong>WE WON!</strong>${score ? ` ‚Äî ${score} pts` : ''}`, ts };
      }
      if (/üòî Game over/.test(body)) {
        return { type: 'loss', icon: 'üòî', main: body.replace(/^.*üòî\s*/, ''), ts };
      }
      if (/üÉè GAME STARTED/.test(body)) {
        const players = (body.match(/Players:\s*(.+)$/) || [])[1];
        return { type: 'system', icon: 'üÉè', main: `Game started ‚Äî <strong>${players || '?'}</strong>`, ts };
      }
      if (/‚è∞/.test(body)) return { type: 'system', icon: '‚è∞', main: body.replace(/^.*‚è∞\s*/, ''), ts };
      if (/‚ñ∂ Bot started/.test(body)) return { type: 'system', icon: '‚ñ∂', main: `<strong>Bot started</strong>`, ts };
      if (/‚èπ Bot stopped/.test(body)) return { type: 'system', icon: '‚èπ', main: `<strong>Bot stopped</strong>`, ts };
      if (/üîå Connected/.test(body)) return { type: 'system', icon: 'üîå', main: 'Connected to game server', ts };
      if (/üö™ Joined room/.test(body)) {
        const rid = (body.match(/room\s+([a-f0-9-]{8,})/) || [])[1];
        return { type: 'system', icon: 'üö™', main: `Joined room${rid ? ` <strong>${rid.substring(0, 8)}‚Ä¶</strong>` : ''}`, ts };
      }
      const hasEmoji = /[\u{1F000}-\u{1FFFF}‚úÖ‚ö†Ô∏èüîåüéÆüÉèüì£]/u.test(body);
      if (!hasEmoji) return null;
      return { type: 'system', icon: 'üì°', main: body, ts };
    }

    function addFeedItem(item) {
      if (!item) return;
      _feedItems.push(item);
      if (_feedItems.length > MAX_FEED) _feedItems.shift();
      const body = document.getElementById('feed-body');
      const empty = body.querySelector('.feed-empty');
      if (empty) empty.remove();
      const el = document.createElement('div');
      el.className = `feed-item ${item.type}`;
      el.innerHTML = `
    <div class="feed-icon">${item.icon}</div>
    <div class="feed-content">
      <div class="feed-main">${item.main}</div>
      <div class="feed-time">${item.ts}</div>
    </div>`;
      body.appendChild(el);
      while (body.children.length > MAX_FEED) body.removeChild(body.firstChild);
      document.getElementById('feed-count').textContent = `${_feedItems.length} events`;
      if (document.getElementById('feed-scroll').checked) body.scrollTop = body.scrollHeight;
    }

    function clearFeed() {
      _feedItems = [];
      document.getElementById('feed-body').innerHTML = `<div class="feed-empty"><div class="ei">üì°</div><div>Feed cleared</div></div>`;
      document.getElementById('feed-count').textContent = '';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Live stats polling (polls /api/live every 1.5s)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let _liveGameStart = null;

    async function pollLiveStats() {
      try {
        const snap = await api('/live');
        renderLiveStats(snap);
      } catch (e) {
        // Hard error ‚Äî clear panel
        renderLiveStats(null);
      }
    }

    function renderLiveStats(snap) {
      const live = snap?.live_game;
      const active = live?.active;

      // Header dot
      const dot = document.getElementById('live-dot');
      const inactive = document.getElementById('live-inactive');

      if (active) {
        dot.className = 'dot running';
        inactive.style.display = 'none';
        if (!_liveGameStart) _liveGameStart = live.started_at;
      } else {
        dot.className = 'dot stopped';
        _liveGameStart = null;
        inactive.style.display = 'block';
      }

      // Timer
      const timerEl = document.getElementById('live-timer');
      if (active && live.started_at) {
        const elapsed = Math.floor((Date.now() - new Date(live.started_at).getTime()) / 1000);
        timerEl.textContent = fmtUp(elapsed);
      } else {
        timerEl.textContent = '';
      }

      // Strategy badge
      const strat = snap?.strategy_id || _status?.active_strategy || '‚Äî';
      document.getElementById('live-strategy-badge').textContent = strat ? `¬∑ ${fmtId(strat)}` : '';
      document.getElementById('live-lifetime-strat').textContent = strat ? fmtId(strat) : '';

      // Live game counters
      document.getElementById('live-hand').textContent = active ? (live.current_hand_size ?? '‚Äî') : '‚Äî';
      document.getElementById('live-cards-p').textContent = active ? live.cards_played : 0;
      document.getElementById('live-cards-d').textContent = active ? live.cards_drawn : 0;
      document.getElementById('live-uno').textContent = active ? live.uno_calls : 0;
      document.getElementById('live-pen').textContent = active ? live.penalties : 0;
      document.getElementById('live-turns').textContent = active ? live.turns : 0;

      if (!snap) return;

      // Lifetime stats (always show ‚Äî merged with live delta when game is active)
      // snap may come from /api/live (has live_game) or /api/strategies/x/stats (no live_game)
      document.getElementById('lt-games').textContent = snap.games_played;
      document.getElementById('lt-wr').textContent = snap.win_rate?.toFixed(1) + '%';
      document.getElementById('lt-wins').textContent = snap.wins;
      document.getElementById('lt-losses').textContent = snap.losses;
      document.getElementById('lt-cards').textContent = snap.total_cards_played;
      document.getElementById('lt-uno').textContent = snap.total_uno_calls;
      document.getElementById('lt-pen').textContent = snap.total_penalties;
      document.getElementById('lt-avg').textContent = snap.avg_points_per_game?.toFixed(1) ?? '0';

      // Placement bars
      const p = snap.placements || {};
      const total = Math.max(1, (p['1'] || 0) + (p['2'] || 0) + (p['3'] || 0) + (p['4+'] || 0));
      const bars = [
        { k: '1', label: 'ü•á 1st', color: 'var(--yellow)' },
        { k: '2', label: 'ü•à 2nd', color: 'var(--blue)' },
        { k: '3', label: 'ü•â 3rd', color: 'var(--orange)' },
        { k: '4+', label: '4th+', color: 'var(--muted)' },
      ].map(({ k, label, color }) => {
        const cnt = p[k] || 0, pct = ((cnt / total) * 100).toFixed(0);
        return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
      <div style="font-family:var(--mono);font-size:10px;color:var(--muted);width:50px">${label}</div>
      <div style="flex:1;background:var(--border);border-radius:3px;height:5px;overflow:hidden">
        <div style="width:${pct}%;height:100%;background:${color};border-radius:3px;transition:width .4s"></div>
      </div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--muted);width:28px;text-align:right">${cnt}</div>
    </div>`;
      }).join('');
      document.getElementById('lt-placements').innerHTML = bars;

      // Cache snapshot so the telem sync helper can access it
      _lastLiveSnap = snap;
      _syncTelemFromLive();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Universal live-stats ‚Üí telemetry bridge
    // Populates the ctrl-telem-strip (Control page) and the
    // Strategy Telemetry card (Live page) from /api/live data
    // whenever the strategy does not emit log-based telemetry.
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function _syncTelemFromLive() {
      const live = _lastLiveSnap?.live_game;
      const active = !!live?.active;

      // If log-parsed turn telemetry exists, let renderTelemetry handle everything.
      if (_lastTelem?.turn) return;

      // ‚îÄ‚îÄ Control page compact strip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const strip = document.getElementById('ctrl-telem-strip');
      if (strip) {
        if (active) {
          strip.style.display = '';
          // Relabel and populate each telem-box slot
          const boxes = strip.querySelectorAll('.telem-box');
          // boxes: [Turn, Hand, Playable, Colour, NN, Threat]
          const slots = [
            { val: live.turns ?? 0, sub: 'turns taken' },
            { val: live.current_hand_size ?? '‚Äî', sub: 'cards in hand' },
            { val: live.cards_played ?? 0, sub: 'cards played' },
            { val: live.cards_drawn ?? 0, sub: 'cards drawn' },
            { val: live.uno_calls ?? 0, sub: 'uno calls' },
            { val: live.penalties ?? 0, sub: 'penalties' },
          ];
          boxes.forEach((box, i) => {
            const s = slots[i];
            if (!s) return;
            const valEl = box.querySelector('.telem-val');
            const subEl = box.querySelector('.telem-sub');
            if (valEl) valEl.textContent = s.val;
            if (subEl) subEl.textContent = s.sub;
          });
          // Hide NN bar (not applicable without log telemetry)
          const nnBar = document.getElementById('ctrl-nn-fill')?.closest('div[style]');
          if (nnBar) nnBar.style.display = 'none';
          // Clear nn-weight / faults labels
          const nnWeight = document.getElementById('ctrl-nn-weight');
          if (nnWeight) nnWeight.textContent = '';
          const faultsEl = document.getElementById('ctrl-telem-faults');
          if (faultsEl) faultsEl.textContent = '';
          // Mode pill ‚Üí LIVE
          const modePill = document.getElementById('ctrl-telem-mode');
          if (modePill) modePill.innerHTML = '<span class="mode-pill mode-LIVE">LIVE</span>';
          // Timestamp ‚Üí strategy name
          const tsEl = document.getElementById('ctrl-telem-ts');
          if (tsEl) {
            const strat = _lastLiveSnap?.strategy_id || _status?.active_strategy || '';
            tsEl.textContent = strat ? fmtId(strat) : '';
          }
        } else {
          strip.style.display = 'none';
        }
      }

      // ‚îÄ‚îÄ Live Action page ‚Äî Strategy Telemetry card ‚îÄ‚îÄ‚îÄ
      const telemModePill = document.getElementById('telem-mode-pill');
      const telemTurnGrid = document.getElementById('telem-turn-grid');
      const telemTs = document.getElementById('telem-ts');
      const nnRow = document.getElementById('telem-nn-row');
      const faultsRow = document.getElementById('telem-faults-row');

      if (!telemModePill) return;

      if (active) {
        telemModePill.innerHTML = '<span class="mode-pill mode-LIVE">LIVE</span>';
        if (telemTs) {
          const strat = _lastLiveSnap?.strategy_id || _status?.active_strategy || '';
          telemTs.textContent = strat ? fmtId(strat) : '';
        }
        if (telemTurnGrid) {
          telemTurnGrid.innerHTML = `
        <div class="telem-box">
          <div class="telem-lbl">Turns</div>
          <div class="telem-val">${live.turns ?? 0}</div>
          <div class="telem-sub">taken so far</div>
        </div>
        <div class="telem-box">
          <div class="telem-lbl">Hand</div>
          <div class="telem-val ${(live.current_hand_size ?? 99) <= 3 ? 'green' : (live.current_hand_size ?? 0) >= 10 ? 'red' : ''}">${live.current_hand_size ?? '‚Äî'}</div>
          <div class="telem-sub">cards held</div>
        </div>
        <div class="telem-box">
          <div class="telem-lbl">Played</div>
          <div class="telem-val b">${live.cards_played ?? 0}</div>
          <div class="telem-sub">cards played</div>
        </div>
        <div class="telem-box">
          <div class="telem-lbl">Drawn</div>
          <div class="telem-val ${(live.cards_drawn ?? 0) > 20 ? 'red' : ''}">${live.cards_drawn ?? 0}</div>
          <div class="telem-sub">from deck</div>
        </div>
        <div class="telem-box">
          <div class="telem-lbl">UNO</div>
          <div class="telem-val y">${live.uno_calls ?? 0}</div>
          <div class="telem-sub">calls</div>
        </div>
        <div class="telem-box">
          <div class="telem-lbl">Penalties</div>
          <div class="telem-val ${(live.penalties ?? 0) > 0 ? 'red' : ''}">${live.penalties ?? 0}</div>
          <div class="telem-sub">incurred</div>
        </div>`;
          telemTurnGrid.style.display = '';
        }
        if (nnRow) nnRow.style.display = 'none';
        if (faultsRow) faultsRow.style.display = 'none';
      } else {
        // No active game and no log telemetry ‚Äî show placeholder
        telemModePill.innerHTML = '<span style="font-family:var(--mono);font-size:10px;color:var(--muted)">waiting for bot‚Ä¶</span>';
        if (telemTs) telemTs.textContent = '';
        if (telemTurnGrid) {
          telemTurnGrid.innerHTML = '<div style="color:var(--muted);font-family:var(--mono);font-size:11px;padding:8px 0">‚ö° Live stats appear here when the bot is active</div>';
          telemTurnGrid.style.display = '';
        }
        if (nnRow) nnRow.style.display = 'none';
        if (faultsRow) faultsRow.style.display = 'none';
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Raw log polling ‚Äî drives both log view and feed
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function pollLog() {
      try {
        const r = await api(`/bot/log?since=${_logOff}`);

        // Detect server-side log reset (new bot session)
        if (r.total < _logOff) {
          _logOff = 0;
          document.getElementById('log-body').innerHTML = '';
          clearFeed();
        }

        if (!r.lines || !r.lines.length) return;

        // Clear placeholder in raw log on first real lines
        if (_logOff === 0) {
          const ph = document.getElementById('log-body').querySelector('.dim');
          if (ph) ph.remove();
        }

        const logBody = document.getElementById('log-body');

        r.lines.forEach(line => {
          // Raw log entry
          const d = document.createElement('div');
          d.className = 'll ' + classifyLine(line);
          d.textContent = line;
          logBody.appendChild(d);

          // Feed entry
          addFeedItem(parseLine(line));
        });

        _logOff = r.total;
        document.getElementById('log-count').textContent = r.total + ' lines';

        // Auto-scroll raw log
        if (document.getElementById('log-scroll').checked) {
          logBody.scrollTop = logBody.scrollHeight;
        }
      } catch (e) { }
    }

    function classifyLine(line) {
      if (/üèÜ|WE WON|‚úÖ/.test(line)) return 'ok';
      if (/‚ùå|Error|Traceback|PENALTY/.test(line)) return 'err';
      if (/‚ö†Ô∏è|warn/.test(line)) return 'warn';
      if (/üîå|üö™|‚ñ∂|‚èπ|üÉè GAME/.test(line)) return 'info';
      if (/üéÆ MY TURN/.test(line)) return 'turn-mine';
      return '';
    }

    function clearLogDisplay() {
      document.getElementById('log-body').innerHTML = '<div class="ll dim">Log display cleared (new lines will still appear)</div>';
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Modals
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function openModal(id) {
      document.getElementById(id).classList.remove('hidden');
    }
    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }
    // Click overlay to close
    document.querySelectorAll('.overlay').forEach(o => {
      o.addEventListener('click', e => {
        if (e.target === o) closeModal(o.id);
      });
    });


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Init
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function switchGuideTab(tab) {
      ['structure', 'api', 'events', 'cards', 'prompt'].forEach(t => {
        document.getElementById('gtab-' + t).classList.toggle('active', t === tab);
        document.getElementById('gpanel-' + t).classList.toggle('hidden', t !== tab);
      });
    }

    function copyPrompt() {
      const txt = document.getElementById('ai-prompt-text').textContent;
      navigator.clipboard.writeText(txt).then(
        () => toast('üìã Prompt copied to clipboard'),
        () => {
          // Fallback: select text
          const el = document.getElementById('ai-prompt-text');
          const sel = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(el);
          sel.removeAllRanges();
          sel.addRange(range);
          toast('‚å® Text selected ‚Äî press Ctrl+C to copy', 'info');
        }
      );
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Telemetry polling
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const COLOR_CLASS = { RED: 'red', BLUE: 'blue', GREEN: 'green', YELLOW: 'yellow' };

    async function pollTelemetry() {
      try {
        const t = await api('/telemetry');
        renderTelemetry(t);
      } catch (e) {
        // No telemetry available
      }
    }

    function renderTelemetry(t) {
      if (!t) return;
      _lastTelem = t;
      // After updating log-parsed telem, re-sync to avoid live fallback overwriting
      // nero-specific data (the guard `if (_lastTelem?.turn) return` in _syncTelemFromLive handles this)

      const card = document.getElementById('telem-card');
      const hasTurn = !!(t && t.turn);
      const hasGame = !!(t && t.game);

      if (!t || (!hasTurn && !hasGame)) {
        // Show placeholder ‚Äî bot not running or no telemetry yet
        document.getElementById('telem-mode-pill').innerHTML = '<span style="font-family:var(--mono);font-size:10px;color:var(--muted)">waiting for bot‚Ä¶</span>';
        document.getElementById('telem-ts').textContent = '';
        document.getElementById('telem-turn-grid').innerHTML = '<div style="color:var(--muted);font-family:var(--mono);font-size:11px;padding:8px 0">‚ö° Telemetry appears here when the bot is active</div>';
        document.getElementById('telem-turn-grid').style.display = '';
        document.getElementById('telem-nn-row').style.display = 'none';
        document.getElementById('telem-faults-row').style.display = 'none';
        document.getElementById('telem-game-row').style.display = 'none';
        return;
      }

      // ‚îÄ‚îÄ Mode pill ‚îÄ‚îÄ
      const modePill = document.getElementById('telem-mode-pill');
      const mode = t.turn?.mode || 'NORMAL';
      modePill.innerHTML = `<span class="mode-pill mode-${mode}">${mode}</span>`;

      // ‚îÄ‚îÄ Timestamp ‚îÄ‚îÄ
      document.getElementById('telem-ts').textContent = t.turn?.ts ? `Turn ${t.turn.turn} ¬∑ ${t.turn.ts}` : '';

      // ‚îÄ‚îÄ Current turn grid ‚îÄ‚îÄ
      const turnGrid = document.getElementById('telem-turn-grid');
      if (hasTurn) {
        const tr = t.turn;
        const colorCls = COLOR_CLASS[tr.color] || '';
        const threatCls = tr.threat === 'high' ? 'red' : tr.threat === 'medium' ? 'yellow' : 'green';
        turnGrid.innerHTML = `
      <div class="telem-box">
        <div class="telem-lbl">Hand</div>
        <div class="telem-val ${tr.hand <= 3 ? 'green' : tr.hand >= 10 ? 'red' : ''}">${tr.hand}</div>
        <div class="telem-sub">${tr.playable} playable</div>
      </div>
      <div class="telem-box">
        <div class="telem-lbl">Turn</div>
        <div class="telem-val">${tr.turn}</div>
        <div class="telem-sub">in game</div>
      </div>
      <div class="telem-box">
        <div class="telem-lbl">Dominant</div>
        <div class="telem-val ${colorCls}" style="font-size:13px">${tr.color}</div>
        <div class="telem-sub">active colour</div>
      </div>
      <div class="telem-box">
        <div class="telem-lbl">Threat</div>
        <div class="telem-val ${threatCls}" style="font-size:13px">${tr.threat || '‚Äî'}</div>
        <div class="telem-sub">opponent threat</div>
      </div>`;
        turnGrid.style.display = '';
      } else {
        turnGrid.innerHTML = '';
        turnGrid.style.display = 'none';
      }

      // ‚îÄ‚îÄ Neural network bar ‚îÄ‚îÄ
      const nnRow = document.getElementById('telem-nn-row');
      if (hasTurn && t.turn.nn_score !== null && t.turn.nn_score !== undefined) {
        const pct = Math.min(100, Math.round(t.turn.nn_score * 100));
        document.getElementById('telem-nn-fill').style.width = pct + '%';
        document.getElementById('telem-nn-val').textContent = t.turn.nn_score.toFixed(3);
        document.getElementById('telem-nn-weight').textContent =
          t.turn.nn_weight !== null ? `${t.turn.nn_weight}% NN` : '';
        nnRow.style.display = '';
      } else {
        nnRow.style.display = 'none';
      }

      // ‚îÄ‚îÄ Sync compact strip on control page ‚îÄ‚îÄ
      const strip = document.getElementById('ctrl-telem-strip');
      if (strip && hasTurn) {
        const tr = t.turn;
        strip.style.display = '';
        document.getElementById('ctrl-telem-turn').textContent = tr.turn;
        document.getElementById('ctrl-telem-hand').textContent = tr.hand;
        document.getElementById('ctrl-telem-playable').textContent = tr.playable;
        document.getElementById('ctrl-telem-color').textContent = tr.color;
        document.getElementById('ctrl-telem-nn').textContent = tr.nn_score !== null && tr.nn_score !== undefined ? tr.nn_score.toFixed(3) : '‚Äî';
        document.getElementById('ctrl-telem-threat').textContent = tr.threat || '‚Äî';
        document.getElementById('ctrl-telem-ts').textContent = `Turn ${tr.turn} ¬∑ ${tr.ts}`;
        const mode = tr.mode || 'NORMAL';
        document.getElementById('ctrl-telem-mode').innerHTML = `<span class="mode-pill mode-${mode}">${mode}</span>`;
        // NN bar
        if (tr.nn_score !== null && tr.nn_score !== undefined) {
          const pct = Math.min(100, Math.round(tr.nn_score * 100));
          document.getElementById('ctrl-nn-fill').style.width = pct + '%';
          document.getElementById('ctrl-nn-weight').textContent = tr.nn_weight !== null ? `${tr.nn_weight}% NN` : '';
        }
        // Faults on strip
        const stripFaults = t.faults || t.game?.faults || [];
        document.getElementById('ctrl-telem-faults').textContent = stripFaults.length ? '‚ö† ' + stripFaults.join(', ') : '';
      } else if (strip) {
        strip.style.display = hasTurn ? '' : 'none';
      }

      // ‚îÄ‚îÄ Faults ‚îÄ‚îÄ
      const faults = t.faults || t.game?.faults || [];
      const faultsRow = document.getElementById('telem-faults-row');
      if (faults.length) {
        const faultMap = {
          STUCK_COLOR: { icon: 'üîÅ', label: 'Stuck Color', desc: 'Repeatedly drawing on same color' },
          WILD_WASTED: { icon: '‚ô†', label: 'Wild Wasted', desc: 'Used wild when color card available' },
          OVERDRAWS: { icon: 'üì•', label: 'Overdraws', desc: 'Drawing excessively per turn' },
          LOW_AGGRESSION: { icon: 'üò¥', label: 'Low Aggression', desc: 'Not playing aggressively enough' },
        };
        document.getElementById('telem-faults-pills').innerHTML = faults.map(f => {
          const info = faultMap[f] || { icon: '‚ö†', label: f, desc: '' };
          return `<span class="fault-pill" title="${info.desc}">${info.icon} ${info.label}</span>`;
        }).join('');
        faultsRow.style.display = '';
      } else {
        faultsRow.style.display = 'none';
      }

      // ‚îÄ‚îÄ Last game summary ‚îÄ‚îÄ
      const gameRow = document.getElementById('telem-game-row');
      if (hasGame) {
        const g = t.game;
        const resultOk = g.result && g.result.includes('1st');
        document.getElementById('telem-game-grid').innerHTML = `
      <div class="telem-box">
        <div class="telem-lbl">Result</div>
        <div class="telem-val ${resultOk ? 'green' : 'red'}" style="font-size:13px">${g.result || '‚Äî'}</div>
        <div class="telem-sub">${g.ts || ''}</div>
      </div>
      <div class="telem-box">
        <div class="telem-lbl">Turns</div>
        <div class="telem-val">${g.turns ?? '‚Äî'}</div>
        <div class="telem-sub">game length</div>
      </div>
      <div class="telem-box">
        <div class="telem-lbl">Draws</div>
        <div class="telem-val ${(g.draws || 0) > 30 ? 'red' : ''}">${g.draws ?? '‚Äî'}</div>
        <div class="telem-sub">from deck</div>
      </div>
      <div class="telem-box">
        <div class="telem-lbl">Actions</div>
        <div class="telem-val blue">${g.actions ?? '‚Äî'}</div>
        <div class="telem-sub">action cards</div>
      </div>
      <div class="telem-box">
        <div class="telem-lbl">WD4s</div>
        <div class="telem-val yellow">${g.w4 ?? '‚Äî'}</div>
        <div class="telem-sub">wild draw 4</div>
      </div>
      <div class="telem-box">
        <div class="telem-lbl">Targeted</div>
        <div class="telem-val ${(g.targeted || 0) > 5 ? 'red' : ''}">${g.targeted ?? '‚Äî'}</div>
        <div class="telem-sub">times hit</div>
      </div>
      ${g.avg_nn !== null && g.avg_nn !== undefined ? `
      <div class="telem-box">
        <div class="telem-lbl">Avg NN</div>
        <div class="telem-val">${g.avg_nn.toFixed(3)}</div>
        <div class="telem-sub">confidence</div>
      </div>` : ''}
      ${g.training_error !== null && g.training_error !== undefined ? `
      <div class="telem-box">
        <div class="telem-lbl">Train Err</div>
        <div class="telem-val ${g.training_error > 0.3 ? 'red' : 'green'}">${g.training_error.toFixed(3)}</div>
        <div class="telem-sub">network error</div>
      </div>` : ''}`;

        if (t.lifetime) {
          document.getElementById('telem-lifetime').textContent =
            `Lifetime: ${t.lifetime.wins} wins from ${t.lifetime.games} games ¬∑ ${t.lifetime.win_rate} win rate`;
        } else {
          document.getElementById('telem-lifetime').textContent = '';
        }
        gameRow.style.display = '';
      } else {
        gameRow.style.display = 'none';
      }

      // ‚îÄ‚îÄ Telemetry feed lines ‚îÄ‚îÄ
      const feedBody = document.getElementById('telem-feed-body');
      if (t.feed && t.feed.length) {
        feedBody.innerHTML = t.feed.map(line => {
          const body = line.replace(/^\[\d{2}:\d{2}:\d{2}\]\s*/, '');
          const ts = (line.match(/^\[(\d{2}:\d{2}:\d{2})\]/) || [])[1] || '';
          let cls = 'draw';
          if (/Warning:/.test(body)) cls = 'warn';
          else if (/Played a/.test(body)) cls = 'play';
          // Colour-code card colours inline
          const coloured = body
            .replace(/\b(RED)\b/g, '<span class="color-RED">RED</span>')
            .replace(/\b(BLUE)\b/g, '<span class="color-BLUE">BLUE</span>')
            .replace(/\b(GREEN)\b/g, '<span class="color-GREEN">GREEN</span>')
            .replace(/\b(YELLOW)\b/g, '<span class="color-YELLOW">YELLOW</span>');
          return `<div class="tl ${cls}"><span style="color:var(--muted);margin-right:6px">${ts}</span>${coloured}</div>`;
        }).join('');
        if (_telemFeedOpen) feedBody.scrollTop = feedBody.scrollHeight;
      }
    }

    async function init() {
      await pollStatus();
      await loadStrats();
      setInterval(pollStatus, 3000);
      setInterval(pollLog, 1500);
      setInterval(pollLiveStats, 1500);
      setInterval(pollTelemetry, 2000);
      pollLiveStats();
      pollTelemetry();
    }
    init();
  </script>
</body>

</html>