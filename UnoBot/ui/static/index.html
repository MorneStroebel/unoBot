<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>UnoBot Control</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0b0d;--surf:#111318;--surf2:#161b24;--surf3:#1c2230;
  --border:#1e2535;--border2:#283040;
  --text:#dde4f0;--muted:#566070;--muted2:#7a8899;
  --red:#e63946;--green:#22c55e;--yellow:#f0b429;--blue:#3b82f6;--orange:#f4845f;
  --r:10px;
  --mono:'Share Tech Mono',monospace;
  --display:'Bebas Neue',sans-serif;
  --body:'DM Sans',sans-serif;
}
html{background:var(--bg);color:var(--text);font-family:var(--body);font-size:14px;height:100%}
body{height:100%;display:flex;flex-direction:column}

/* â”€â”€â”€ Scanlines overlay â”€â”€â”€ */
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.06) 3px,rgba(0,0,0,.06) 4px);pointer-events:none;z-index:9999}

/* â”€â”€â”€ Header â”€â”€â”€ */
header{display:flex;align-items:center;justify-content:space-between;padding:14px 26px;border-bottom:1px solid var(--border);background:var(--surf);position:sticky;top:0;z-index:200;gap:16px}
.logo{display:flex;align-items:center;gap:12px;flex-shrink:0}
.logo-icon{width:36px;height:36px;background:var(--red);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 0 20px rgba(230,57,70,.4);flex-shrink:0}
.logo-text{font-family:var(--display);font-size:28px;letter-spacing:3px;line-height:1}
.logo-sub{font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:4px;text-transform:uppercase;margin-top:2px}
.hdr-right{display:flex;align-items:center;gap:20px}
.status-pill{display:flex;align-items:center;gap:7px;padding:5px 12px;border:1px solid var(--border2);border-radius:20px;font-family:var(--mono);font-size:11px;background:var(--surf2)}
.dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:all .3s}
.dot.stopped{background:var(--muted)}
.dot.running{background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
.dot.paused{background:var(--yellow);box-shadow:0 0 8px var(--yellow)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.hdr-strategy{font-family:var(--mono);font-size:11px;color:var(--muted2)}
.hdr-room{font-family:var(--mono);font-size:11px;color:var(--muted);background:var(--surf2);border:1px solid var(--border);border-radius:6px;padding:4px 9px;cursor:default}
.hdr-room.active{color:var(--green);border-color:rgba(34,197,94,.3)}

/* â”€â”€â”€ Layout â”€â”€â”€ */
.layout{display:flex;flex:1;min-height:0}
.nav{width:220px;min-width:220px;border-right:1px solid var(--border);padding:16px 0;display:flex;flex-direction:column;background:var(--surf)}
.nav-section{font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:3px;text-transform:uppercase;padding:12px 20px 5px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;cursor:pointer;color:var(--muted2);font-size:13px;font-weight:500;border-left:3px solid transparent;transition:all .15s;user-select:none}
.nav-item:hover{color:var(--text);background:rgba(255,255,255,.03)}
.nav-item.active{color:var(--red);border-left-color:var(--red);background:rgba(230,57,70,.06)}
.nav-icon{width:18px;text-align:center;font-size:15px;flex-shrink:0}

/* â”€â”€â”€ Content â”€â”€â”€ */
.content{flex:1;overflow-y:auto;padding:28px}
.page{display:none}.page.active{display:block}
.page-title{font-family:var(--display);font-size:28px;letter-spacing:2px;margin-bottom:22px}

/* â”€â”€â”€ Cards â”€â”€â”€ */
.card{background:var(--surf);border:1px solid var(--border);border-radius:var(--r);padding:22px;margin-bottom:16px}
.card-title{font-family:var(--display);font-size:17px;letter-spacing:1.5px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}

/* â”€â”€â”€ Buttons â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 16px;border:1px solid transparent;border-radius:7px;font-family:var(--mono);font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:all .15s;white-space:nowrap;flex-shrink:0}
.btn:disabled{opacity:.3;cursor:not-allowed;pointer-events:none}
.btn-green{background:var(--green);color:#000;border-color:var(--green)}
.btn-green:hover{background:#16a34a;box-shadow:0 0 14px rgba(34,197,94,.3)}
.btn-red{background:transparent;color:var(--red);border-color:var(--red)}
.btn-red:hover{background:rgba(230,57,70,.1)}
.btn-red-solid{background:var(--red);color:#fff;border-color:var(--red)}
.btn-red-solid:hover{background:#c1121f}
.btn-yellow{background:transparent;color:var(--yellow);border-color:var(--yellow)}
.btn-yellow:hover{background:rgba(240,180,41,.1)}
.btn-yellow-solid{background:var(--yellow);color:#000;border-color:var(--yellow)}
.btn-yellow-solid:hover{background:#ca8a04}
.btn-ghost{background:transparent;color:var(--muted2);border-color:var(--border2)}
.btn-ghost:hover{color:var(--text);background:rgba(255,255,255,.04)}
.btn-blue{background:var(--blue);color:#fff;border-color:var(--blue)}
.btn-blue:hover{background:#2563eb}
.btn-sm{padding:5px 11px;font-size:10px;letter-spacing:1px}
.btn-xs{padding:3px 8px;font-size:9px;letter-spacing:.8px}

/* â”€â”€â”€ Forms â”€â”€â”€ */
.field{margin-bottom:14px}
.flbl{display:block;font-family:var(--mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px}
input[type=text],input[type=number],select,textarea{
  background:var(--surf2);border:1px solid var(--border2);border-radius:7px;
  color:var(--text);font-family:var(--mono);font-size:12px;padding:8px 11px;
  outline:none;transition:border-color .15s;width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--red)}
select option{background:var(--surf2)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}

/* â”€â”€â”€ Toggle â”€â”€â”€ */
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-bottom:1px solid var(--border)}
.toggle-row:last-child{border-bottom:none}
.toggle-info .tlbl{font-size:13px;font-weight:500}
.toggle-info .tsub{font-size:11px;color:var(--muted);margin-top:2px}
.tog{position:relative;width:40px;height:22px;cursor:pointer;flex-shrink:0}
.tog input{opacity:0;width:0;height:0;position:absolute}
.tog-track{position:absolute;inset:0;background:var(--border2);border-radius:11px;transition:background .2s}
.tog-track::before{content:'';position:absolute;width:16px;height:16px;background:var(--muted);border-radius:50%;top:3px;left:3px;transition:all .2s}
.tog input:checked~.tog-track{background:rgba(230,57,70,.3)}
.tog input:checked~.tog-track::before{transform:translateX(18px);background:var(--red)}

/* â”€â”€â”€ Stats grid â”€â”€â”€ */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-bottom:16px}
.stat-box{background:var(--surf2);border:1px solid var(--border);border-radius:8px;padding:13px}
.stat-lbl{font-family:var(--mono);font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px}
.stat-val{font-family:var(--display);font-size:30px;line-height:1;color:var(--text)}
.stat-val.g{color:var(--green)}.stat-val.r{color:var(--red)}.stat-val.y{color:var(--yellow)}.stat-val.b{color:var(--blue)}

/* â”€â”€â”€ Strategy cards â”€â”€â”€ */
.strat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:16px}
.sc{background:var(--surf2);border:1px solid var(--border);border-radius:var(--r);padding:20px;transition:border-color .2s;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 0 0,rgba(230,57,70,.05),transparent 55%);opacity:0;transition:opacity .2s}
.sc:hover{border-color:var(--border2)}.sc:hover::before{opacity:1}
.sc.active-strat{border-color:var(--red)}.sc.active-strat::before{opacity:1}
.sc-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
.sc-name{font-family:var(--display);font-size:22px;letter-spacing:1px}
.sc-cls{font-family:var(--mono);font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px}
.active-badge{font-family:var(--mono);font-size:9px;background:rgba(230,57,70,.15);color:var(--red);border:1px solid rgba(230,57,70,.3);border-radius:4px;padding:2px 8px;white-space:nowrap}
.sc-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:12px 0}
.sc-stat{background:var(--surf);border:1px solid var(--border);border-radius:6px;padding:8px 10px}
.sc-stat-lbl{font-size:9px;color:var(--muted);font-family:var(--mono);text-transform:uppercase;letter-spacing:1px}
.sc-stat-val{font-family:var(--display);font-size:20px;color:var(--text)}
.sc-stat-val.g{color:var(--green)}.sc-stat-val.r{color:var(--red)}
.sc-identity{font-family:var(--mono);font-size:10px;color:var(--muted2);margin-bottom:12px;padding:6px 9px;background:var(--surf);border:1px solid var(--border);border-radius:6px}
.sc-actions{display:flex;gap:7px;flex-wrap:wrap}

/* â”€â”€â”€ Terminal â”€â”€â”€ */
.term{background:#070a0c;border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.term-bar{padding:8px 13px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surf)}
.term-dots{display:flex;gap:5px}
.td{width:10px;height:10px;border-radius:50%}
.td.r{background:#ff5f57}.td.y{background:#febc2e}.td.g{background:#28c840}
.term-label{font-family:var(--mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:2px}
.term-body{height:420px;overflow-y:auto;padding:13px;font-family:var(--mono);font-size:12px;line-height:1.75;color:#7a9aaa}
.term-body::-webkit-scrollbar{width:3px}
.term-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.ll{white-space:pre-wrap;word-break:break-word}
.ll.ok{color:#4ade80}.ll.err{color:#f87171}.ll.warn{color:#fbbf24}.ll.info{color:#60a5fa}.ll.dim{color:#2a3a45}
.ll.turn-mine{color:#e2e8f0;font-weight:600}
.ll.action-play{color:#86efac}
.ll.action-draw{color:#93c5fd}
.ll.action-penalty{color:#fca5a5}
.ll.game-event{color:#fde68a}

/* â”€â”€â”€ Live action feed â”€â”€â”€ */
.feed{height:280px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;padding:12px}
.feed::-webkit-scrollbar{width:3px}
.feed::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.feed-item{display:flex;align-items:flex-start;gap:10px;padding:8px 11px;border-radius:7px;background:var(--surf2);border:1px solid var(--border);font-size:13px;animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.feed-icon{font-size:17px;flex-shrink:0;margin-top:1px}
.feed-content{flex:1;min-width:0}
.feed-main{color:var(--text);line-height:1.4}
.feed-main strong{color:#fff}
.feed-time{font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:2px}
.feed-item.mine{border-color:rgba(34,197,94,.25);background:rgba(34,197,94,.05)}
.feed-item.win{border-color:rgba(240,180,41,.3);background:rgba(240,180,41,.06)}
.feed-item.loss{border-color:rgba(230,57,70,.2);background:rgba(230,57,70,.04)}
.feed-item.penalty{border-color:rgba(248,113,113,.3);background:rgba(248,113,113,.05)}
.feed-item.system{opacity:.7}
.feed-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--muted);font-family:var(--mono);font-size:12px;gap:8px}
.feed-empty .ei{font-size:32px}

/* â”€â”€â”€ Mode selector â”€â”€â”€ */
.mode-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.mode-btn{background:var(--surf2);border:2px solid var(--border);border-radius:9px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .15s;user-select:none}
.mode-btn:hover{border-color:var(--border2)}
.mode-btn.sel{border-color:var(--red);background:rgba(230,57,70,.07)}
.mode-icon{font-size:26px;margin-bottom:6px}
.mode-name{font-family:var(--mono);font-size:11px;color:var(--text);text-transform:uppercase;letter-spacing:1px}
.mode-desc{font-size:11px;color:var(--muted);margin-top:3px}

/* â”€â”€â”€ Tags â”€â”€â”€ */
.tag-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;min-height:24px}
.tag{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:5px;font-family:var(--mono);font-size:11px;background:rgba(59,130,246,.12);color:var(--blue);border:1px solid rgba(59,130,246,.25)}
.tag button{background:none;border:none;color:inherit;cursor:pointer;font-size:14px;padding:0;line-height:1;opacity:.6}
.tag button:hover{opacity:1}

/* â”€â”€â”€ Hero bar â”€â”€â”€ */
.hero{background:var(--surf);border:1px solid var(--border);border-radius:var(--r);padding:24px;margin-bottom:16px;display:flex;align-items:center;gap:24px;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:-40px;right:-40px;width:180px;height:180px;background:radial-gradient(circle,rgba(230,57,70,.06) 0%,transparent 70%);pointer-events:none}
.hero-ring{width:80px;height:80px;border-radius:50%;border:3px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:32px;transition:all .4s;flex-shrink:0}
.hero-ring.running{border-color:var(--green);box-shadow:0 0 24px rgba(34,197,94,.18)}
.hero-ring.paused{border-color:var(--yellow);box-shadow:0 0 24px rgba(240,180,41,.18)}
.hero-ring.stopped{border-color:var(--muted)}
.hero-info{flex:1;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
.info-box{background:var(--surf2);border:1px solid var(--border);border-radius:7px;padding:10px 13px}
.info-lbl{font-family:var(--mono);font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px}
.info-val{font-size:14px;font-weight:600;color:var(--text)}
.info-val.g{color:var(--green)}.info-val.r{color:var(--red)}.info-val.y{color:var(--yellow)}
.hero-btns{display:flex;flex-direction:column;gap:8px;min-width:124px}

/* â”€â”€â”€ Pause banner â”€â”€â”€ */
.pause-banner{background:rgba(240,180,41,.07);border:1px solid rgba(240,180,41,.3);border-radius:var(--r);padding:12px 18px;margin-bottom:16px;display:none;align-items:center;gap:12px}
.pause-banner.show{display:flex}

/* â”€â”€â”€ Upload zone â”€â”€â”€ */
.upload-zone{border:2px dashed var(--border2);border-radius:var(--r);padding:28px;text-align:center;cursor:pointer;transition:all .2s}
.upload-zone:hover,.upload-zone.drag{border-color:var(--red);background:rgba(230,57,70,.04)}
.upload-icon{font-size:36px;margin-bottom:8px}
.upload-text{font-family:var(--mono);font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
.upload-sub{font-size:12px;color:var(--muted);margin-top:4px}

/* â”€â”€â”€ Modal â”€â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:500;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.overlay.hidden{display:none}
.modal{background:var(--surf);border:1px solid var(--border2);border-radius:var(--r);padding:26px;width:440px;max-width:95vw;max-height:90vh;overflow-y:auto}
.modal-title{font-family:var(--display);font-size:24px;letter-spacing:1.5px;margin-bottom:4px}
.modal-sub{font-family:var(--mono);font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:20px}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.modal-divider{border:none;border-top:1px solid var(--border);margin:16px 0}

/* â”€â”€â”€ Toast â”€â”€â”€ */
.toast-ct{position:fixed;bottom:22px;right:22px;display:flex;flex-direction:column;gap:7px;z-index:9000}
.toast{padding:10px 15px;border-radius:7px;font-family:var(--mono);font-size:12px;border:1px solid;animation:tIn .2s ease;max-width:320px}
.toast.ok{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.3);color:var(--green)}
.toast.err{background:rgba(230,57,70,.1);border-color:rgba(230,57,70,.3);color:var(--red)}
.toast.info{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.3);color:var(--blue)}
.toast.warn{background:rgba(240,180,41,.1);border-color:rgba(240,180,41,.3);color:var(--yellow)}
@keyframes tIn{from{transform:translateX(14px);opacity:0}to{transform:none;opacity:1}}

/* â”€â”€â”€ Misc â”€â”€â”€ */
.empty{text-align:center;padding:40px 20px;color:var(--muted);font-family:var(--mono);font-size:12px}
.empty .ei{font-size:36px;margin-bottom:10px}
.sep{border:none;border-top:1px solid var(--border);margin:18px 0}
.help-text{font-size:12px;color:var(--muted);margin-top:5px;line-height:1.5}
.target-hint{display:none;margin-top:12px}
.target-hint.show{display:block}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">ğŸƒ</div>
    <div>
      <div class="logo-text">UNOBOT</div>
      <div class="logo-sub">Control Panel</div>
    </div>
  </div>
  <div class="hdr-right">
    <div class="hdr-strategy" id="hdr-strategy">â€”</div>
    <div class="hdr-room" id="hdr-room">No room</div>
    <div class="status-pill">
      <div class="dot stopped" id="hdr-dot"></div>
      <span id="hdr-status">OFFLINE</span>
      <span id="hdr-uptime" style="color:var(--muted);margin-left:4px"></span>
    </div>
  </div>
</header>

<div class="layout">
  <nav class="nav">
    <div class="nav-section">Control</div>
    <div class="nav-item active" data-page="control" onclick="navTo('control',this)">
      <span class="nav-icon">âš¡</span>Bot Control
    </div>
    <div class="nav-item" data-page="live" onclick="navTo('live',this)">
      <span class="nav-icon">ğŸ“¡</span>Live Action
    </div>
    <div class="nav-section">Strategy</div>
    <div class="nav-item" data-page="strategies" onclick="navTo('strategies',this)">
      <span class="nav-icon">ğŸ§ </span>Strategies
    </div>
    <div class="nav-item" data-page="stats" onclick="navTo('stats',this)">
      <span class="nav-icon">ğŸ“Š</span>Statistics
    </div>
    <div class="nav-section">Settings</div>
    <div class="nav-item" data-page="config" onclick="navTo('config',this)">
      <span class="nav-icon">âš™ï¸</span>Bot Identity
    </div>
    <div class="nav-section">Debug</div>
    <div class="nav-item" data-page="logs" onclick="navTo('logs',this)">
      <span class="nav-icon">ğŸ“Ÿ</span>Raw Log
    </div>
  </nav>

  <main class="content">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOT CONTROL â•â•â• -->
    <div class="page active" id="page-control">
      <div class="page-title">BOT CONTROL</div>

      <!-- Hero status bar -->
      <div class="hero">
        <div class="hero-ring stopped" id="big-ring">ğŸ”´</div>
        <div class="hero-info">
          <div class="info-box"><div class="info-lbl">Status</div><div class="info-val" id="h-status">Stopped</div></div>
          <div class="info-box"><div class="info-lbl">Strategy</div><div class="info-val r" id="h-strategy">â€”</div></div>
          <div class="info-box"><div class="info-lbl">Room</div><div class="info-val" id="h-room">â€”</div></div>
          <div class="info-box"><div class="info-lbl">Uptime</div><div class="info-val g" id="h-uptime">â€”</div></div>
        </div>
        <div class="hero-btns">
          <button class="btn btn-green"        id="btn-start"  onclick="startBot()">â–¶ START</button>
          <button class="btn btn-yellow"        id="btn-pause"  onclick="pauseBot()"  disabled>â¸ PAUSE</button>
          <button class="btn btn-yellow-solid"  id="btn-resume" onclick="resumeBot()" style="display:none">â–¶ RESUME</button>
          <button class="btn btn-red"           id="btn-stop"   onclick="confirmStop()" disabled>â–  STOP</button>
        </div>
      </div>

      <!-- Pause banner -->
      <div class="pause-banner" id="pause-banner">
        <span style="font-size:20px">â¸</span>
        <div style="flex:1">
          <div style="color:var(--yellow);font-family:var(--mono);font-size:12px;font-weight:600;letter-spacing:1px">BOT PAUSED</div>
          <div style="color:var(--muted);font-size:12px;margin-top:2px">Will finish current game, then hold here until resumed.</div>
        </div>
        <button class="btn btn-yellow-solid btn-sm" onclick="resumeBot()">â–¶ Resume</button>
      </div>

      <!-- Room controls (leave / rejoin) -->
      <div class="card" id="room-card" style="display:none">
        <div class="card-title">ROOM ACTIONS</div>
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:180px">
            <div style="font-family:var(--mono);font-size:11px;color:var(--muted)">Currently in room</div>
            <div style="font-family:var(--mono);font-size:13px;color:var(--green);margin-top:3px;word-break:break-all" id="room-id-display">â€”</div>
          </div>
          <button class="btn btn-red btn-sm" onclick="leaveRoom()">ğŸšª Leave Room</button>
        </div>
      </div>

      <!-- Launch config -->
      <div class="card">
        <div class="card-title">LAUNCH OPTIONS</div>

        <div class="field">
          <span class="flbl">Strategy</span>
          <select id="launch-strat">
            <option value="">â€” Use active strategy â€”</option>
          </select>
        </div>

        <div class="field">
          <span class="flbl">Room Mode</span>
          <div class="mode-grid">
            <div class="mode-btn sel" data-mode="auto" onclick="selMode('auto',this)">
              <div class="mode-icon">ğŸš€</div>
              <div class="mode-name">Auto</div>
              <div class="mode-desc">Join or create any room</div>
            </div>
            <div class="mode-btn" data-mode="wait" onclick="selMode('wait',this)">
              <div class="mode-icon">â³</div>
              <div class="mode-name">Wait</div>
              <div class="mode-desc">Wait for an open room</div>
            </div>
            <div class="mode-btn" data-mode="target" onclick="selMode('target',this)">
              <div class="mode-icon">ğŸ¯</div>
              <div class="mode-name">Find Player</div>
              <div class="mode-desc">Join a friend's room</div>
            </div>
          </div>
        </div>

        <!-- Target player input â€” only shown in target mode -->
        <div class="target-hint" id="target-hint">
          <div class="field">
            <span class="flbl">Player Name(s) <span style="color:var(--muted);font-weight:400">â€” press Enter or comma after each name</span></span>
            <input type="text" id="target-input" placeholder="Type a player name and press Enterâ€¦"
              onkeydown="targetKey(event)" oninput="targetComma(event)">
            <div class="tag-list" id="tag-list"></div>
          </div>
          <p id="target-warn" style="display:none;font-family:var(--mono);font-size:11px;color:var(--red);margin-bottom:10px">
            âš  Add at least one player name before starting.
          </p>
        </div>

        <button class="btn btn-green" style="width:100%;margin-top:4px" id="btn-start2" onclick="startBot()">â–¶ START BOT</button>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LIVE ACTION â•â•â•â• -->
    <div class="page" id="page-live">
      <div class="page-title">LIVE ACTION</div>

      <div class="card" style="padding:0;overflow:hidden">
        <div class="term-bar">
          <div style="display:flex;align-items:center;gap:10px">
            <div class="term-dots"><div class="td r"></div><div class="td y"></div><div class="td g"></div></div>
            <span class="term-label">Activity Feed</span>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <span id="feed-count" style="font-family:var(--mono);font-size:10px;color:var(--muted)"></span>
            <button class="btn btn-ghost btn-xs" onclick="clearFeed()">âœ• Clear</button>
            <label class="tog" title="Auto-scroll">
              <input type="checkbox" id="feed-scroll" checked>
              <span class="tog-track"></span>
            </label>
            <span style="font-family:var(--mono);font-size:10px;color:var(--muted)">Scroll</span>
          </div>
        </div>
        <div class="feed" id="feed-body">
          <div class="feed-empty"><div class="ei">ğŸ“¡</div><div>Waiting for game activityâ€¦</div></div>
        </div>
      </div>

      <!-- Quick stats row -->
      <div class="card">
        <div class="card-title">CURRENT SESSION</div>
        <div class="stat-grid">
          <div class="stat-box"><div class="stat-lbl">Games</div><div class="stat-val" id="sess-games">0</div></div>
          <div class="stat-box"><div class="stat-lbl">Wins</div><div class="stat-val g" id="sess-wins">0</div></div>
          <div class="stat-box"><div class="stat-lbl">Losses</div><div class="stat-val r" id="sess-losses">0</div></div>
          <div class="stat-box"><div class="stat-lbl">Cards Played</div><div class="stat-val b" id="sess-cards">0</div></div>
          <div class="stat-box"><div class="stat-lbl">UNO Calls</div><div class="stat-val y" id="sess-uno">0</div></div>
          <div class="stat-box"><div class="stat-lbl">Penalties</div><div class="stat-val r" id="sess-pen">0</div></div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STRATEGIES â•â•â•â•â• -->
    <div class="page" id="page-strategies">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px">
        <div class="page-title" style="margin:0">STRATEGIES</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost btn-sm" onclick="loadStrats()">â†º Refresh</button>
          <button class="btn btn-blue btn-sm" onclick="openUploadModal()">ğŸ“¦ Upload Strategy</button>
        </div>
      </div>

      <div class="strat-grid" id="strat-grid">
        <div class="empty"><div class="ei">â³</div><div>Loadingâ€¦</div></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATISTICS â•â•â•â•â• -->
    <div class="page" id="page-stats">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px">
        <div class="page-title" style="margin:0">STATISTICS</div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="stats-sel" onchange="loadStats(this.value)" style="width:auto;min-width:180px">
            <option value="">Select strategyâ€¦</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="loadStats(document.getElementById('stats-sel').value)">â†º</button>
        </div>
      </div>
      <div id="stats-content">
        <div class="empty"><div class="ei">ğŸ“Š</div><div>Select a strategy above to view stats</div></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOT IDENTITY â•â•â• -->
    <div class="page" id="page-config">
      <div class="page-title">BOT IDENTITY</div>

      <div class="card">
        <div class="card-title">Default Identity <span style="font-family:var(--mono);font-size:11px;font-weight:400;color:var(--muted)">used when strategy has no override</span></div>
        <div class="row2">
          <div class="field"><span class="flbl">First Name</span><input type="text" id="g-first" placeholder="WorldClass"></div>
          <div class="field"><span class="flbl">Last Name</span><input type="text" id="g-last" placeholder="UnoBot"></div>
        </div>
        <div class="field"><span class="flbl">Player / Display Name</span><input type="text" id="g-player" placeholder="HoerBoer"></div>
        <button class="btn btn-green" onclick="saveIdentity()">ğŸ’¾ Save Identity</button>
      </div>

      <div class="card">
        <div class="card-title">Behaviour</div>
        <div class="toggle-row">
          <div class="toggle-info"><div class="tlbl">Sandbox Mode</div><div class="tsub">Play against bots only, no real opponents</div></div>
          <label class="tog"><input type="checkbox" id="g-sandbox"><span class="tog-track"></span></label>
        </div>
        <div class="toggle-row">
          <div class="toggle-info"><div class="tlbl">Auto Rejoin</div><div class="tsub">Automatically rejoin after each game ends</div></div>
          <label class="tog"><input type="checkbox" id="g-rejoin" checked><span class="tog-track"></span></label>
        </div>
        <div class="toggle-row">
          <div class="toggle-info"><div class="tlbl">Only Human Players</div><div class="tsub">Only join rooms that have real players</div></div>
          <label class="tog"><input type="checkbox" id="g-only"><span class="tog-track"></span></label>
        </div>
        <div class="toggle-row">
          <div class="toggle-info"><div class="tlbl">Debug Mode</div><div class="tsub">Verbose output in the raw log</div></div>
          <label class="tog"><input type="checkbox" id="g-debug"><span class="tog-track"></span></label>
        </div>
        <div class="row2" style="margin-top:16px">
          <div class="field"><span class="flbl">Rejoin Delay (seconds)</span><input type="number" id="g-delay" min="0" max="60" value="3"></div>
          <div class="field"><span class="flbl">Room Check Interval (s)</span><input type="number" id="g-check" min="1" max="60" value="5"></div>
        </div>
        <button class="btn btn-green" onclick="saveBehaviour()">ğŸ’¾ Save Behaviour</button>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RAW LOG â•â•â•â•â•â•â•â• -->
    <div class="page" id="page-logs">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px">
        <div class="page-title" style="margin:0">RAW LOG</div>
        <div style="display:flex;align-items:center;gap:10px">
          <span id="log-count" style="font-family:var(--mono);font-size:10px;color:var(--muted)"></span>
          <button class="btn btn-ghost btn-sm" onclick="clearLogDisplay()">âœ• Clear</button>
          <label class="tog"><input type="checkbox" id="log-scroll" checked><span class="tog-track"></span></label>
          <span style="font-family:var(--mono);font-size:10px;color:var(--muted)">Auto-scroll</span>
        </div>
      </div>
      <div class="term">
        <div class="term-bar">
          <div class="term-dots"><div class="td r"></div><div class="td y"></div><div class="td g"></div></div>
          <div class="term-label">bot stdout</div>
          <div></div>
        </div>
        <div class="term-body" id="log-body">
          <div class="ll dim">Waiting for bot activityâ€¦</div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- â•â• MODAL: Stop confirmation â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay hidden" id="modal-stop">
  <div class="modal" style="width:380px">
    <div class="modal-title">Stop Bot?</div>
    <div class="modal-sub">Choose what happens to the current room</div>
    <p style="color:var(--muted);font-size:13px;margin-bottom:20px;line-height:1.6">
      Stopping the bot will terminate the process. Do you also want to leave the current game room?
    </p>
    <div style="display:flex;flex-direction:column;gap:8px">
      <button class="btn btn-red-solid" onclick="stopBot(true)" style="justify-content:flex-start;padding:12px 16px">
        <span style="font-size:16px">ğŸšª</span>
        <div style="text-align:left">
          <div>Stop &amp; Leave Room</div>
          <div style="font-size:10px;opacity:.7;text-transform:none;letter-spacing:0;margin-top:2px">Terminates bot and leaves the game room</div>
        </div>
      </button>
      <button class="btn btn-ghost" onclick="stopBot(false)" style="justify-content:flex-start;padding:12px 16px">
        <span style="font-size:16px">â¹</span>
        <div style="text-align:left">
          <div>Stop Only</div>
          <div style="font-size:10px;opacity:.7;text-transform:none;letter-spacing:0;margin-top:2px">Terminates bot but stays in room</div>
        </div>
      </button>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-stop')">Cancel</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: Leave room â†’ what next? â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay hidden" id="modal-left-room">
  <div class="modal" style="width:420px">
    <div class="modal-title">Room Left</div>
    <div class="modal-sub">You've left the room â€” what would you like to do next?</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:4px">
      <button class="btn btn-green" onclick="rejoinAfterLeave('auto')" style="justify-content:flex-start;padding:12px 16px">
        <span style="font-size:16px">ğŸš€</span>
        <div style="text-align:left">
          <div>Join a Random Room</div>
          <div style="font-size:10px;opacity:.7;text-transform:none;letter-spacing:0;margin-top:2px">Find or create any available room</div>
        </div>
      </button>
      <button class="btn btn-ghost" onclick="showJoinPlayer()" style="justify-content:flex-start;padding:12px 16px" id="btn-join-player">
        <span style="font-size:16px">ğŸ¯</span>
        <div style="text-align:left">
          <div>Join a Player's Room</div>
          <div style="font-size:10px;opacity:.7;text-transform:none;letter-spacing:0;margin-top:2px">Search by player name</div>
        </div>
      </button>
      <!-- Player name input â€” revealed when "Join a Player's Room" is clicked -->
      <div id="join-player-input" style="display:none;padding:4px 0">
        <div class="field">
          <span class="flbl">Player Name</span>
          <input type="text" id="join-player-name" placeholder="Enter the player's nameâ€¦"
            onkeydown="if(event.key==='Enter') rejoinAfterLeave('target')">
        </div>
        <p id="join-player-warn" style="display:none;font-family:var(--mono);font-size:11px;color:var(--red);margin-bottom:8px">
          âš  Please enter a player name.
        </p>
        <button class="btn btn-green btn-sm" onclick="rejoinAfterLeave('target')">ğŸ¯ Find &amp; Join</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-left-room')">Stay Offline</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: Strategy config â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay hidden" id="modal-strat-cfg">
  <div class="modal">
    <div class="modal-title" id="sc-title">Configure Strategy</div>
    <div class="modal-sub" id="sc-sub"></div>

    <div class="row2">
      <div class="field"><span class="flbl">Bot First Name <span style="color:var(--muted)">(blank = global)</span></span><input type="text" id="sc-first" placeholder="e.g. Blitz"></div>
      <div class="field"><span class="flbl">Bot Last Name</span><input type="text" id="sc-last" placeholder="e.g. Alpha"></div>
    </div>
    <div class="field"><span class="flbl">Player / Display Name <span style="color:var(--muted)">(blank = global)</span></span><input type="text" id="sc-player" placeholder="e.g. HoerBoer"></div>
    <div class="field"><span class="flbl">MAC Address <span style="color:var(--muted)">(blank = global)</span></span><input type="text" id="sc-mac" placeholder="e.g. 00:11:22:33:44:55"></div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-strat-cfg')">Cancel</button>
      <button class="btn btn-green" id="sc-save-btn" onclick="saveStratCfg()">ğŸ’¾ Save</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: Upload strategy â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay hidden" id="modal-upload">
  <div class="modal">
    <div class="modal-title">Upload Strategy</div>
    <div class="modal-sub">Install a new strategy from a zip file</div>
    <p class="help-text" style="margin-bottom:16px">
      The zip must contain a single top-level folder with an <code style="font-family:var(--mono);background:var(--surf2);padding:1px 5px;border-radius:3px">__init__.py</code> that exports a class inheriting from <code style="font-family:var(--mono);background:var(--surf2);padding:1px 5px;border-radius:3px">BaseStrategy</code>.
    </p>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('upload-file').click()"
      ondragover="event.preventDefault();this.classList.add('drag')"
      ondragleave="this.classList.remove('drag')"
      ondrop="handleDrop(event)">
      <div class="upload-icon">ğŸ“¦</div>
      <div class="upload-text">Click to select or drag &amp; drop</div>
      <div class="upload-sub" id="upload-filename">Accepts .zip files</div>
    </div>
    <input type="file" id="upload-file" accept=".zip" style="display:none" onchange="handleFileSelect(event)">
    <div id="upload-result" style="display:none;margin-top:12px;padding:10px 13px;border-radius:7px;font-family:var(--mono);font-size:12px"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-upload')">Close</button>
      <button class="btn btn-blue" id="upload-btn" onclick="uploadStrategy()" disabled>ğŸ“¤ Install Strategy</button>
    </div>
  </div>
</div>

<div class="toast-ct" id="toasts"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _status   = {status:'stopped',paused:false,active_strategy:'â€”',pid:null,uptime_seconds:null,room_id:null};
let _strats   = [];
let _launchMode = 'auto';
let _targets  = [];
let _logOff   = 0;        // raw log offset
let _cfgStratId = null;   // strategy being edited in modal
let _uploadFile = null;

// Live feed state
let _feedItems = [];      // parsed feed items
const MAX_FEED = 200;

// Session counters (parsed from log lines)
let _sess = {games:0, wins:0, losses:0, cards:0, uno:0, pen:0};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Navigation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navTo(id, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  el.classList.add('active');
  if (id === 'strategies') loadStrats();
  if (id === 'stats')      populateStatsSel();
  if (id === 'config')     loadConfig();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Toast
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type='ok') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API helper
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(path, opts={}) {
  const r = await fetch('/api' + path, {
    headers: {'Content-Type':'application/json'},
    ...opts
  });
  if (!r.ok) {
    const j = await r.json().catch(() => ({}));
    throw new Error(j.error || `HTTP ${r.status}`);
  }
  return r.json();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Status polling
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function pollStatus() {
  try {
    _status = await api('/status');
    renderStatus();
  } catch(e) {}
}

function renderStatus() {
  const s       = _status;
  const running = s.status === 'running';
  const paused  = s.paused && running;
  const viz     = paused ? 'paused' : s.status; // 'stopped' | 'running' | 'paused'

  // Header dot
  const dot = document.getElementById('hdr-dot');
  dot.className = 'dot ' + viz;

  // Header text
  const htxt = document.getElementById('hdr-status');
  htxt.textContent = paused ? 'PAUSED' : (running ? 'RUNNING' : 'OFFLINE');
  htxt.style.color = paused ? 'var(--yellow)' : (running ? 'var(--green)' : 'var(--muted)');

  // Header uptime
  document.getElementById('hdr-uptime').textContent =
    (running && s.uptime_seconds != null) ? fmtUp(s.uptime_seconds) : '';

  // Header strategy
  document.getElementById('hdr-strategy').textContent = s.active_strategy || 'â€”';

  // Header room pill
  const roomEl = document.getElementById('hdr-room');
  if (s.room_id) {
    roomEl.textContent = 'ğŸŸ¢ ' + s.room_id.substring(0,8) + 'â€¦';
    roomEl.className = 'hdr-room active';
  } else {
    roomEl.textContent = 'No room';
    roomEl.className = 'hdr-room';
  }

  // Hero ring
  const ring = document.getElementById('big-ring');
  ring.className = 'hero-ring ' + viz;
  ring.textContent = paused ? 'â¸' : (running ? 'ğŸ¤–' : 'ğŸ”´');

  // Info boxes
  const hs = document.getElementById('h-status');
  hs.textContent = paused ? 'Paused' : (running ? 'Running' : 'Stopped');
  hs.className = 'info-val ' + (paused ? 'y' : (running ? 'g' : ''));
  document.getElementById('h-strategy').textContent = s.active_strategy || 'â€”';
  document.getElementById('h-room').textContent = s.room_id ? s.room_id.substring(0,12)+'â€¦' : 'â€”';
  document.getElementById('h-uptime').textContent =
    (running && s.uptime_seconds != null) ? fmtUp(s.uptime_seconds) : 'â€”';

  // Control buttons
  document.getElementById('btn-start').disabled  = running;
  document.getElementById('btn-start2').disabled = running;
  document.getElementById('btn-stop').disabled   = !running;
  const pb = document.getElementById('btn-pause');
  const rb = document.getElementById('btn-resume');
  pb.disabled = !running || paused;
  pb.style.display = (running && !paused) ? '' : 'none';
  rb.style.display = paused ? '' : 'none';

  // Pause banner
  const banner = document.getElementById('pause-banner');
  paused ? banner.classList.add('show') : banner.classList.remove('show');

  // Room card
  const roomCard = document.getElementById('room-card');
  if (s.room_id) {
    roomCard.style.display = '';
    document.getElementById('room-id-display').textContent = s.room_id;
  } else {
    roomCard.style.display = 'none';
  }
}

function fmtUp(sec) {
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
  return [h,m,s].map(v => String(v).padStart(2,'0')).join(':');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Mode + target players
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selMode(mode, el) {
  _launchMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('sel'));
  el.classList.add('sel');
  const hint = document.getElementById('target-hint');
  if (mode === 'target') {
    hint.classList.add('show');
  } else {
    hint.classList.remove('show');
    _targets = [];
    renderTags();
    document.getElementById('target-input').value = '';
    document.getElementById('target-warn').style.display = 'none';
  }
}

function targetKey(e) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    addTarget(e.target.value.trim().replace(/,+$/, ''));
    e.target.value = '';
  }
}

function targetComma(e) {
  if (e.target.value.includes(',')) {
    const parts = e.target.value.split(',');
    e.target.value = parts.pop();
    parts.forEach(p => addTarget(p.trim()));
  }
}

function addTarget(name) {
  if (!name || _targets.includes(name)) return;
  _targets.push(name);
  renderTags();
  document.getElementById('target-warn').style.display = 'none';
}

function removeTarget(name) {
  _targets = _targets.filter(t => t !== name);
  renderTags();
}

function renderTags() {
  document.getElementById('tag-list').innerHTML = _targets.map(t =>
    `<div class="tag">${t}<button onclick="removeTarget('${t.replace(/'/g,"\\'")}')">Ã—</button></div>`
  ).join('');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Bot control
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startBot() {
  if (_launchMode === 'target') {
    const inp = document.getElementById('target-input');
    if (inp.value.trim()) addTarget(inp.value.trim()), inp.value='';
    if (_targets.length === 0) {
      document.getElementById('target-warn').style.display = 'block';
      return;
    }
  }
  const strategy = document.getElementById('launch-strat').value || null;
  try {
    await api('/bot/start', {method:'POST', body:JSON.stringify({
      mode: _launchMode, strategy, target_players: _targets
    })});
    toast('â–¶ Bot started');
    setTimeout(pollStatus, 500);
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
}

function confirmStop() {
  openModal('modal-stop');
}

async function stopBot(leaveRoom) {
  closeModal('modal-stop');
  try {
    if (leaveRoom && _status.room_id) {
      try {
        await api('/room/leave', {method:'POST'});
        toast('ğŸšª Left room');
      } catch(e) { /* ignore â€” bot stop will handle cleanup */ }
    }
    await api('/bot/stop', {method:'POST'});
    toast('â¹ Bot stopped');
    setTimeout(pollStatus, 500);
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
}

async function pauseBot() {
  try {
    await api('/bot/pause', {method:'POST'});
    toast('â¸ Bot will pause after this game', 'warn');
    setTimeout(pollStatus, 400);
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
}

async function resumeBot() {
  try {
    await api('/bot/resume', {method:'POST'});
    toast('â–¶ Bot resumed');
    setTimeout(pollStatus, 400);
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Room leave / rejoin
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function leaveRoom() {
  try {
    await api('/room/leave', {method:'POST'});
    toast('ğŸšª Left room');
    setTimeout(pollStatus, 500);
    // Show the "what next?" modal
    document.getElementById('join-player-input').style.display = 'none';
    document.getElementById('join-player-warn').style.display = 'none';
    document.getElementById('join-player-name').value = '';
    openModal('modal-left-room');
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
}

function showJoinPlayer() {
  const inp = document.getElementById('join-player-input');
  inp.style.display = inp.style.display === 'none' ? 'block' : 'none';
  if (inp.style.display === 'block') {
    setTimeout(() => document.getElementById('join-player-name').focus(), 50);
  }
}

async function rejoinAfterLeave(mode) {
  if (mode === 'target') {
    const name = document.getElementById('join-player-name').value.trim();
    if (!name) {
      document.getElementById('join-player-warn').style.display = 'block';
      return;
    }
    closeModal('modal-left-room');
    try {
      await api('/room/join', {method:'POST', body:JSON.stringify({mode:'target', target_players:[name]})});
      toast('âœ… Joined player\'s room');
      setTimeout(pollStatus, 600);
    } catch(e) { toast('âŒ ' + e.message, 'err'); }
  } else {
    closeModal('modal-left-room');
    try {
      await api('/room/join', {method:'POST', body:JSON.stringify({mode:'auto'})});
      toast('âœ… Joined a room');
      setTimeout(pollStatus, 600);
    } catch(e) { toast('âŒ ' + e.message, 'err'); }
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Strategies
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStrats() {
  document.getElementById('strat-grid').innerHTML =
    `<div class="empty"><div class="ei">â³</div><div>Loadingâ€¦</div></div>`;
  try {
    _strats = await api('/strategies');
    renderStrats();
    populateLaunchSel();
    populateStatsSel();
  } catch(e) {
    document.getElementById('strat-grid').innerHTML =
      `<div class="empty"><div class="ei">âš ï¸</div><div>Failed to load strategies</div></div>`;
  }
}

function fmtId(id) {
  return id.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
}

function renderStrats() {
  const g = document.getElementById('strat-grid');
  if (!_strats.length) {
    g.innerHTML = `<div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ§ </div><div>No strategies found</div></div>`;
    return;
  }
  g.innerHTML = _strats.map(s => {
    const st  = s.stats;
    const wr  = st.win_rate.toFixed(1);
    const cfg = s.config || {};
    const identity = (cfg.bot_first_name||cfg.bot_last_name)
      ? `${cfg.bot_first_name||''} ${cfg.bot_last_name||''}`.trim()
      : 'Using global identity';

    return `<div class="sc ${s.active ? 'active-strat' : ''}" id="sc-${s.id}">
      <div class="sc-header">
        <div>
          <div class="sc-name">${fmtId(s.id)}</div>
          <div class="sc-cls">${s.name}</div>
        </div>
        ${s.active ? '<div class="active-badge">â— ACTIVE</div>' : ''}
      </div>
      <div class="sc-identity" id="sc-ident-${s.id}">ğŸ· ${identity}</div>
      <div class="sc-stats">
        <div class="sc-stat"><div class="sc-stat-lbl">Win %</div><div class="sc-stat-val ${st.win_rate>=50?'g':'r'}">${wr}</div></div>
        <div class="sc-stat"><div class="sc-stat-lbl">Games</div><div class="sc-stat-val">${st.games_played}</div></div>
        <div class="sc-stat"><div class="sc-stat-lbl">Wins</div><div class="sc-stat-val g">${st.wins}</div></div>
      </div>
      <div class="sc-actions">
        ${s.active
          ? `<button class="btn btn-ghost btn-xs" disabled>â— Active</button>`
          : `<button class="btn btn-green btn-xs" onclick="setActive('${s.id}')">â–¶ Set Active</button>`}
        <button class="btn btn-ghost btn-xs" onclick="openStratCfg('${s.id}')">âœ Identity</button>
        <button class="btn btn-ghost btn-xs" onclick="viewStratStats('${s.id}')">ğŸ“Š Stats</button>
        <button class="btn btn-red btn-xs"   onclick="resetStats('${s.id}')">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

async function setActive(id) {
  try {
    await api(`/strategies/${id}/activate`, {method:'POST'});
    toast(`âœ… Active strategy â†’ ${fmtId(id)}`);
    await loadStrats();
    await pollStatus();
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
}

async function resetStats(id) {
  if (!confirm(`Reset all stats for "${fmtId(id)}"?`)) return;
  try {
    await api(`/strategies/${id}/stats/reset`, {method:'POST'});
    toast('ğŸ—‘ Stats reset');
    loadStrats();
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
}

function viewStratStats(id) {
  const navEl = [...document.querySelectorAll('.nav-item')].find(el => el.dataset.page === 'stats');
  navTo('stats', navEl);
  document.getElementById('stats-sel').value = id;
  loadStats(id);
}

function populateLaunchSel() {
  const sel = document.getElementById('launch-strat');
  const cur = sel.value;
  sel.innerHTML = `<option value="">â€” Use active strategy â€”</option>` +
    _strats.map(s => `<option value="${s.id}">${fmtId(s.id)}</option>`).join('');
  if (cur) sel.value = cur;
}

function populateStatsSel() {
  const sel = document.getElementById('stats-sel');
  const cur = sel.value;
  if (!_strats.length) return;
  sel.innerHTML = `<option value="">Select strategyâ€¦</option>` +
    _strats.map(s => `<option value="${s.id}">${fmtId(s.id)}</option>`).join('');
  if (cur) sel.value = cur;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Strategy config modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openStratCfg(id) {
  _cfgStratId = id;
  const s = _strats.find(x => x.id === id);
  document.getElementById('sc-title').textContent = `Configure â€” ${fmtId(id)}`;
  document.getElementById('sc-sub').textContent = s ? s.name : id;
  // Clear fields
  ['sc-first','sc-last','sc-player','sc-mac'].forEach(i => document.getElementById(i).value = '');
  document.getElementById('sc-save-btn').disabled = false;

  try {
    const c = await api(`/strategies/${id}/config`);
    document.getElementById('sc-first').value  = c.bot_first_name || '';
    document.getElementById('sc-last').value   = c.bot_last_name  || '';
    document.getElementById('sc-player').value = c.player_name    || '';
    document.getElementById('sc-mac').value    = c.mac_address    || '';
  } catch(e) {}

  openModal('modal-strat-cfg');
}

async function saveStratCfg() {
  if (!_cfgStratId) return;
  const btn = document.getElementById('sc-save-btn');
  btn.disabled = true;
  const data = {
    bot_first_name: document.getElementById('sc-first').value.trim(),
    bot_last_name:  document.getElementById('sc-last').value.trim(),
    player_name:    document.getElementById('sc-player').value.trim(),
    mac_address:    document.getElementById('sc-mac').value.trim(),
  };
  try {
    await api(`/strategies/${_cfgStratId}/config`, {method:'PATCH', body:JSON.stringify(data)});
    toast(`âœ… Identity saved for ${fmtId(_cfgStratId)}`);
    const hint = (data.bot_first_name||data.bot_last_name)
      ? `${data.bot_first_name} ${data.bot_last_name}`.trim()
      : 'Using global identity';
    const el = document.getElementById(`sc-ident-${_cfgStratId}`);
    if (el) el.textContent = 'ğŸ· ' + hint;
    await loadStrats();
    closeModal('modal-strat-cfg');
  } catch(e) {
    toast('âŒ ' + e.message, 'err');
  } finally {
    btn.disabled = false;
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Statistics
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStats(id) {
  const el = document.getElementById('stats-content');
  if (!id) { el.innerHTML = `<div class="empty"><div class="ei">ğŸ“Š</div><div>Select a strategy</div></div>`; return; }
  try {
    const s = await api(`/strategies/${id}/stats`);
    el.innerHTML = renderStats(id, s);
  } catch(e) { el.innerHTML = `<div class="empty"><div>Could not load stats</div></div>`; }
}

function renderStats(id, s) {
  const total = Math.max(1, s.placements['1']+s.placements['2']+s.placements['3']+s.placements['4+']);
  const placements = [
    {k:'1',label:'ğŸ¥‡ 1st',color:'var(--yellow)'},
    {k:'2',label:'ğŸ¥ˆ 2nd',color:'var(--blue)'},
    {k:'3',label:'ğŸ¥‰ 3rd',color:'var(--orange)'},
    {k:'4+',label:'4th+',color:'var(--muted)'},
  ].map(p => {
    const cnt = s.placements[p.k], pct = ((cnt/total)*100).toFixed(0);
    return `<div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:11px;margin-bottom:4px">
        <span>${p.label}</span><span style="color:var(--muted)">${cnt} (${pct}%)</span>
      </div>
      <div style="background:var(--border);border-radius:3px;height:6px;overflow:hidden">
        <div style="width:${pct}%;height:100%;background:${p.color};border-radius:3px;transition:width .5s"></div>
      </div></div>`;
  }).join('');

  const cMap = {RED:'var(--red)',BLUE:'var(--blue)',GREEN:'var(--green)',YELLOW:'var(--yellow)'};
  const cTotal = Math.max(1, Object.values(s.wild_color_choices||{}).reduce((a,b)=>a+b,0));
  const colorBars = Object.entries(s.wild_color_choices||{}).map(([col,cnt]) => {
    const pct = ((cnt/cTotal)*100).toFixed(0);
    return `<div style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;margin-bottom:3px">
        <span style="color:${cMap[col]||'var(--muted)'}">${col}</span>
        <span style="color:var(--muted)">${cnt} (${pct}%)</span>
      </div>
      <div style="background:var(--border);border-radius:3px;height:4px;overflow:hidden">
        <div style="width:${pct}%;height:100%;background:${cMap[col]||'var(--muted)'};border-radius:3px;transition:width .5s"></div>
      </div></div>`;
  }).join('');

  return `
    <div class="card">
      <div class="card-title">${fmtId(id)} <span style="font-family:var(--mono);font-size:11px;font-weight:400;color:var(--muted)">${s.name||''}</span>
        <button class="btn btn-red btn-xs" onclick="resetStats('${id}')">ğŸ—‘ Reset</button>
      </div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-lbl">Games</div><div class="stat-val">${s.games_played}</div></div>
        <div class="stat-box"><div class="stat-lbl">Win Rate</div><div class="stat-val ${s.win_rate>=50?'g':'r'}">${s.win_rate.toFixed(1)}%</div></div>
        <div class="stat-box"><div class="stat-lbl">Wins</div><div class="stat-val g">${s.wins}</div></div>
        <div class="stat-box"><div class="stat-lbl">Losses</div><div class="stat-val r">${s.losses}</div></div>
        <div class="stat-box"><div class="stat-lbl">Avg Points</div><div class="stat-val y">${s.avg_points_per_game.toFixed(1)}</div></div>
        <div class="stat-box"><div class="stat-lbl">Best Game</div><div class="stat-val">${s.best_game_points}</div></div>
        <div class="stat-box"><div class="stat-lbl">Cards Played</div><div class="stat-val b">${s.total_cards_played}</div></div>
        <div class="stat-box"><div class="stat-lbl">Cards Drawn</div><div class="stat-val">${s.total_cards_drawn}</div></div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card"><div class="card-title">Placements</div>${placements}</div>
      <div class="card"><div class="card-title">Wild Colors</div>
        ${colorBars || `<div style="color:var(--muted);font-size:12px">No wild card data yet</div>`}
        <div style="margin-top:14px">
          ${[['Cards Played',s.total_cards_played],['Cards Drawn',s.total_cards_drawn],
             ['UNO Calls',s.total_uno_calls],['Penalties',s.total_penalties]].map(([l,v]) =>
            `<div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:11px;padding:5px 0;border-bottom:1px solid var(--border)">
              <span style="color:var(--muted)">${l}</span><span>${v}</span></div>`
          ).join('')}
        </div>
      </div>
    </div>
    ${s.last_updated ? `<div style="font-family:var(--mono);font-size:9px;color:var(--muted);text-align:right;margin-top:-8px">Updated: ${s.last_updated.substring(0,19)}</div>` : ''}`;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Config page
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadConfig() {
  try {
    const c = await api('/config');
    document.getElementById('g-first').value   = c.bot_first_name || '';
    document.getElementById('g-last').value    = c.bot_last_name  || '';
    document.getElementById('g-player').value  = c.player_name    || '';
    document.getElementById('g-sandbox').checked  = !!c.is_sandbox_mode;
    document.getElementById('g-rejoin').checked   = c.auto_rejoin !== false;
    document.getElementById('g-only').checked     = !!c.only_players_mode;
    document.getElementById('g-debug').checked    = !!c.debug_mode;
    document.getElementById('g-delay').value   = c.rejoin_delay ?? 3;
    document.getElementById('g-check').value   = c.room_check_interval ?? 5;
  } catch(e) { toast('Could not load config', 'err'); }
}

async function saveIdentity() {
  try {
    await api('/config', {method:'PATCH', body:JSON.stringify({
      bot_first_name: document.getElementById('g-first').value.trim(),
      bot_last_name:  document.getElementById('g-last').value.trim(),
      player_name:    document.getElementById('g-player').value.trim(),
    })});
    toast('âœ… Identity saved');
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
}

async function saveBehaviour() {
  try {
    await api('/config', {method:'PATCH', body:JSON.stringify({
      is_sandbox_mode:     document.getElementById('g-sandbox').checked,
      auto_rejoin:         document.getElementById('g-rejoin').checked,
      only_players_mode:   document.getElementById('g-only').checked,
      debug_mode:          document.getElementById('g-debug').checked,
      rejoin_delay:        parseInt(document.getElementById('g-delay').value)||3,
      room_check_interval: parseInt(document.getElementById('g-check').value)||5,
    })});
    toast('âœ… Behaviour saved');
  } catch(e) { toast('âŒ ' + e.message, 'err'); }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Upload strategy
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openUploadModal() {
  _uploadFile = null;
  document.getElementById('upload-filename').textContent = 'Accepts .zip files';
  document.getElementById('upload-btn').disabled = true;
  const res = document.getElementById('upload-result');
  res.style.display = 'none'; res.textContent = '';
  openModal('modal-upload');
}

function handleFileSelect(e) {
  const f = e.target.files[0];
  if (f) { _uploadFile = f; document.getElementById('upload-filename').textContent = f.name; document.getElementById('upload-btn').disabled = false; }
}

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.remove('drag');
  const f = e.dataTransfer.files[0];
  if (f && f.name.endsWith('.zip')) {
    _uploadFile = f;
    document.getElementById('upload-filename').textContent = f.name;
    document.getElementById('upload-btn').disabled = false;
  } else { toast('Only .zip files are accepted', 'err'); }
}

async function uploadStrategy() {
  if (!_uploadFile) return;
  const btn = document.getElementById('upload-btn');
  btn.disabled = true;
  btn.textContent = 'â³ Installingâ€¦';
  const res = document.getElementById('upload-result');
  const fd = new FormData();
  fd.append('file', _uploadFile);
  try {
    const r = await fetch('/api/strategies/upload', {method:'POST', body:fd});
    const j = await r.json();
    if (j.ok) {
      res.style.cssText = 'display:block;background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);color:var(--green)';
      res.textContent = `âœ… Installed: ${j.strategy}  (${j.class})`;
      toast(`âœ… Strategy "${j.strategy}" installed!`);
      loadStrats();
    } else {
      res.style.cssText = 'display:block;background:rgba(230,57,70,.08);border:1px solid rgba(230,57,70,.2);color:var(--red)';
      res.textContent = `âŒ ${j.error}`;
    }
  } catch(e) {
    res.style.cssText = 'display:block;background:rgba(230,57,70,.08);border:1px solid rgba(230,57,70,.2);color:var(--red)';
    res.textContent = `âŒ Upload failed: ${e.message}`;
  } finally {
    btn.disabled = false; btn.textContent = 'ğŸ“¤ Install Strategy';
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Live feed â€” parse log lines into rich feed items
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseLine(line) {
  // Classify log lines and extract semantic meaning
  const ts = (line.match(/^\[(\d{2}:\d{2}:\d{2})\]/) || [])[1] || '';
  const body = line.replace(/^\[\d{2}:\d{2}:\d{2}\]\s*/, '');

  if (/ğŸ® MY TURN/.test(body)) {
    const hand = (body.match(/Hand:\s*(\d+)/) || [])[1];
    const top  = (body.match(/Top:\s*([^â”‚]+)/) || [])[1]?.trim();
    return {type:'mine', icon:'ğŸ®', main:`My turn â€” <strong>${hand} cards</strong> in hand, top: <strong>${top||'?'}</strong>`, ts};
  }
  if (/âœ… Played/.test(body)) {
    const card = body.replace('âœ… Played ','').trim();
    _sess.cards++;
    return {type:'mine', icon:'âœ…', main:`Played <strong>${card}</strong>`, ts};
  }
  if (/ğŸƒ Drew \d/.test(body) && !body.includes('drew')) {
    _sess.cards++;
    return {type:'mine', icon:'ğŸƒ', main:`<strong>${body.replace(/^.*ğŸƒ\s*/,'')}</strong>`, ts};
  }
  if (/ğŸ“£ Called UNO!/.test(body)) {
    _sess.uno++;
    return {type:'mine', icon:'ğŸ“£', main:`<strong>Called UNO!</strong>`, ts};
  }
  if (/âš ï¸.*PENALTY/.test(body)) {
    _sess.pen++;
    const desc = body.replace(/^.*PENALTY.*â”‚\s*/,'').trim();
    return {type:'penalty', icon:'âš ï¸', main:`Penalty: <strong>${desc||'rule violation'}</strong>`, ts};
  }
  if (/â³.*'s turn/.test(body)) {
    const name = (body.match(/â³\s+([^']+)'s turn/) || [])[1];
    const cards = (body.match(/(\d+) cards in hand/) || [])[1];
    return {type:'opponent', icon:'â³', main:`<strong>${name||'Opponent'}'s</strong> turn â€” ${cards||'?'} cards`, ts};
  }
  if (/ğŸ´.*played/.test(body)) {
    const rest = body.replace(/^.*ğŸ´\s*/,'');
    return {type:'opponent', icon:'ğŸ´', main:rest, ts};
  }
  if (/ğŸƒ.*drew/.test(body)) {
    const rest = body.replace(/^.*ğŸƒ\s*/,'');
    return {type:'opponent', icon:'ğŸƒ', main:rest, ts};
  }
  if (/ğŸ“£.*called UNO/.test(body)) {
    const rest = body.replace(/^.*ğŸ“£\s*/,'');
    return {type:'opponent', icon:'ğŸ“£', main:`<strong>${rest}</strong>`, ts};
  }
  if (/ğŸ† WE WON/.test(body)) {
    _sess.wins++; _sess.games++;
    updateSessionStats();
    const score = (body.match(/Score:\s*(\d+)/) || [])[1];
    return {type:'win', icon:'ğŸ†', main:`<strong>WE WON!</strong>${score ? ` â€” ${score} pts` : ''}`, ts};
  }
  if (/ğŸ˜” Game over/.test(body)) {
    _sess.losses++; _sess.games++;
    updateSessionStats();
    const rest = body.replace(/^.*ğŸ˜”\s*/,'');
    return {type:'loss', icon:'ğŸ˜”', main:rest, ts};
  }
  if (/ğŸƒ GAME STARTED/.test(body)) {
    const players = (body.match(/Players:\s*(.+)$/) || [])[1];
    return {type:'system', icon:'ğŸƒ', main:`Game started â€” <strong>${players||'?'}</strong>`, ts};
  }
  if (/â°/.test(body)) {
    return {type:'system', icon:'â°', main:body.replace(/^.*â°\s*/,''), ts};
  }
  if (/â–¶ Bot started/.test(body)) {
    _sess = {games:0,wins:0,losses:0,cards:0,uno:0,pen:0};
    updateSessionStats();
    return {type:'system', icon:'â–¶', main:`<strong>Bot started</strong>`, ts};
  }
  if (/â¹ Bot stopped/.test(body) || /ğŸ SESSION COMPLETE/.test(body)) {
    return {type:'system', icon:'â¹', main:`<strong>Bot stopped</strong>`, ts};
  }
  if (/ğŸ”Œ Connected/.test(body)) {
    return {type:'system', icon:'ğŸ”Œ', main:'Connected to game server', ts};
  }
  if (/ğŸšª Joined room/.test(body)) {
    const rid = (body.match(/room\s+([a-f0-9-]{8,})/) || [])[1];
    return {type:'system', icon:'ğŸšª', main:`Joined room${rid ? ` <strong>${rid.substring(0,8)}â€¦</strong>` : ''}`, ts};
  }
  // Default â€” only show lines with emojis (suppress pure noise)
  const hasEmoji = /[\u{1F000}-\u{1FFFF}âœ…âš ï¸ğŸ”ŒğŸ®ğŸƒğŸ“£]/u.test(body);
  if (!hasEmoji) return null;
  return {type:'system', icon:'ğŸ“¡', main:body, ts};
}

function updateSessionStats() {
  document.getElementById('sess-games').textContent   = _sess.games;
  document.getElementById('sess-wins').textContent    = _sess.wins;
  document.getElementById('sess-losses').textContent  = _sess.losses;
  document.getElementById('sess-cards').textContent   = _sess.cards;
  document.getElementById('sess-uno').textContent     = _sess.uno;
  document.getElementById('sess-pen').textContent     = _sess.pen;
}

function addFeedItem(item) {
  if (!item) return;
  _feedItems.push(item);
  if (_feedItems.length > MAX_FEED) _feedItems.shift();

  const body = document.getElementById('feed-body');
  // Remove empty placeholder
  const empty = body.querySelector('.feed-empty');
  if (empty) empty.remove();

  const el = document.createElement('div');
  el.className = `feed-item ${item.type}`;
  el.innerHTML = `
    <div class="feed-icon">${item.icon}</div>
    <div class="feed-content">
      <div class="feed-main">${item.main}</div>
      <div class="feed-time">${item.ts}</div>
    </div>`;
  body.appendChild(el);

  // Trim DOM if too long
  while (body.children.length > MAX_FEED) body.removeChild(body.firstChild);

  document.getElementById('feed-count').textContent = `${_feedItems.length} events`;
  if (document.getElementById('feed-scroll').checked) {
    body.scrollTop = body.scrollHeight;
  }
}

function clearFeed() {
  _feedItems = [];
  document.getElementById('feed-body').innerHTML = `<div class="feed-empty"><div class="ei">ğŸ“¡</div><div>Feed cleared</div></div>`;
  document.getElementById('feed-count').textContent = '';
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Raw log polling â€” drives both log view and feed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function pollLog() {
  try {
    const r = await api(`/bot/log?since=${_logOff}`);

    // Detect server-side log reset (new bot session)
    if (r.total < _logOff) {
      _logOff = 0;
      document.getElementById('log-body').innerHTML = '';
      clearFeed();
    }

    if (!r.lines || !r.lines.length) return;

    // Clear placeholder in raw log on first real lines
    if (_logOff === 0) {
      const ph = document.getElementById('log-body').querySelector('.dim');
      if (ph) ph.remove();
    }

    const logBody = document.getElementById('log-body');

    r.lines.forEach(line => {
      // Raw log entry
      const d = document.createElement('div');
      d.className = 'll ' + classifyLine(line);
      d.textContent = line;
      logBody.appendChild(d);

      // Feed entry
      addFeedItem(parseLine(line));
    });

    _logOff = r.total;
    document.getElementById('log-count').textContent = r.total + ' lines';

    // Auto-scroll raw log
    if (document.getElementById('log-scroll').checked) {
      logBody.scrollTop = logBody.scrollHeight;
    }
  } catch(e) {}
}

function classifyLine(line) {
  if (/ğŸ†|WE WON|âœ…/.test(line)) return 'ok';
  if (/âŒ|Error|Traceback|PENALTY/.test(line)) return 'err';
  if (/âš ï¸|warn/.test(line)) return 'warn';
  if (/ğŸ”Œ|ğŸšª|â–¶|â¹|ğŸƒ GAME/.test(line)) return 'info';
  if (/ğŸ® MY TURN/.test(line)) return 'turn-mine';
  return '';
}

function clearLogDisplay() {
  document.getElementById('log-body').innerHTML = '<div class="ll dim">Log display cleared (new lines will still appear)</div>';
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Modals
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) {
  document.getElementById(id).classList.remove('hidden');
}
function closeModal(id) {
  document.getElementById(id).classList.add('hidden');
}
// Click overlay to close
document.querySelectorAll('.overlay').forEach(o => {
  o.addEventListener('click', e => {
    if (e.target === o) closeModal(o.id);
  });
});


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  await pollStatus();
  await loadStrats();
  setInterval(pollStatus, 3000);
  setInterval(pollLog, 1500);
}
init();
</script>
</body>
</html>
